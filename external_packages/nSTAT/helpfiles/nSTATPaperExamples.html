
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>nSTAT J. Neuroscience Methods Paper Examples</title><meta name="generator" content="MATLAB 9.2"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-07-02"><meta name="DC.source" content="nSTATPaperExamples.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>nSTAT J. Neuroscience Methods Paper Examples</h1><!--introduction--><p><b>Author</b>: Iahn Cajigas</p><p><b>Date</b>: 01/04/2012</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Experiment 1</a></li><li><a href="#2">Constant Magnesium Concentration - Constant rate poisson</a></li><li><a href="#3">Varying Magnesium Concentration - Piecewise Constant rate poisson</a></li><li><a href="#4">Data Visualization</a></li><li><a href="#5">Define Covariates for the analysis</a></li><li><a href="#6">Define how we want to analyze the data</a></li><li><a href="#7">Perform Analysis</a></li><li><a href="#9">Experiment 2</a></li><li><a href="#10">Load the data</a></li><li><a href="#12">Compare constant rate model with model including stimulus effect</a></li><li><a href="#13">History Effect</a></li><li><a href="#14">Example 3 - PSTH Data</a></li><li><a href="#15">Estimate the PSTH with 50ms windows</a></li><li><a href="#16">Example 3b - SSGLM Example</a></li><li><a href="#17">Summarize Simulated Data</a></li><li><a href="#18">Estimation of the Stimulus Response</a></li><li><a href="#19">Run the SSGLM Filter</a></li><li><a href="#23">Compare differences across trials</a></li><li><a href="#24">Example 4 - HIPPOCAMPAL PLACE CELL - RECEPTIVE FIELD ESTIMATION</a></li><li><a href="#26">Example Data</a></li><li><a href="#27">Analyze All Cells</a></li><li><a href="#28">View Summary Statistics</a></li><li><a href="#30">Visualize the results</a></li><li><a href="#32">Example 5 - STIMULUS DECODING</a></li><li><a href="#33">Generate the conditional Intensity Function</a></li><li><a href="#35">Example 5b - Arm reaching to target Simulation</a></li><li><a href="#37">Experiment 6 - Hybrid Point Process Filter Example</a></li><li><a href="#38">Problem Statement</a></li><li><a href="#40">Generated Simulated Arm Reach</a></li><li><a href="#42">Simulate Neural Firing</a></li></ul></div><h2 id="1">Experiment 1</h2><p>MINIATURE EXCITATORY POST-SYNAPTIC CURRENTS (mEPSCs) Data from Marnie Phillips  <a href="marnie.a.phillips@gmail.com">marnie.a.phillips@gmail.com</a> This analysis is based on a partial version of the dataset used in</p><p>Phillips MA, Lewis LD, Gong J, Constantine-Paton M, Brown EN.  2011 <i>Model-based statistical analysis of miniature synaptic transmission.</i> J Neurophys (under consideration)</p><p><b>Date</b>: 03/01/2011</p><h2 id="2">Constant Magnesium Concentration - Constant rate poisson</h2><p>Under a constant Magnesium concentration, it is seen that the mEPSCs behave as a homogeneous poisson process (constant arrival rate).</p><pre class="codeinput">    close <span class="string">all</span>; clear <span class="string">all</span>;
    epsc2 = importdata(<span class="string">'epsc2.txt'</span>);
    sampleRate = 1000;
    spikeTimes = epsc2.data(:,2)*1/sampleRate; <span class="comment">%in seconds</span>
    nstConst = nspikeTrain(spikeTimes);
    time = 0:(1/sampleRate):nstConst.maxTime;


    <span class="comment">% Define Covariates for the analysis</span>
    baseline = Covariate(time,ones(length(time),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="keyword">...</span>
        <span class="string">''</span>,{<span class="string">'\mu'</span>});
    covarColl = CovColl({baseline});

    <span class="comment">% Create the trial structure</span>
    spikeColl = nstColl(nstConst);
    trial     = Trial(spikeColl,covarColl);


    <span class="comment">% Define how we want to analyze the data</span>
    clear <span class="string">tc</span> <span class="string">tcc</span>;
    tc{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>}},sampleRate,[]);
    tc{1}.setName(<span class="string">'Constant Baseline'</span>);
    tcc = ConfigColl(tc);

    <span class="comment">% Perform Analysis (Commented to since data already saved)</span>
    results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);
<span class="comment">%     h=results.plotResults;</span>
    close <span class="string">all</span>;
    scrsz = get(0,<span class="string">'ScreenSize'</span>);
    results.lambda.setDataLabels({<span class="string">'\lambda_{const}'</span>});
    h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.01 scrsz(4)*.04 <span class="keyword">...</span>
        scrsz(3)*.98 scrsz(4)*.95]);

    subplot(2,2,1); spikeColl.plot;
        title({<span class="string">'Neural Raster with constant Mg^{2+} Concentration'</span>},<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
         hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
         hy=ylabel(<span class="string">'mEPSCs'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
         set(gca,<span class="string">'yTick'</span>,[0 1]);
         set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    subplot(2,2,3); results.KSPlot;
    subplot(2,2,2); results.plotInvGausTrans;
    subplot(2,2,4); results.lambda.plot([],{{<span class="string">' ''b'' ,''Linewidth'',2'</span>}});
    hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    hy=get(gca,<span class="string">'YLabel'</span>);
    set([hx hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    h_legend = legend(<span class="string">'\lambda_{const}'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)+.05 pos(2) pos(3:4)]);
    set(h_legend,<span class="string">'FontSize'</span>,14)
</pre><pre class="codeoutput">Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Analyzing Configuration #1: Neuron #1
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_01.png" alt=""> <h2 id="3">Varying Magnesium Concentration - Piecewise Constant rate poisson</h2><p>When the magnesium concentration of the bath decreased (i.e. magnesium is removed), the rate of mEPSCs begin to increase in frequency. This can be modeled in a many different ways (using the change in Magnesium directly as a model covariate, etc.) Here we approximate the rate as being constant during certain portions of the experiment. These segments can in principle be estimated (using heirarchical Bayesian methods), but here we select them via visual inspection. We compare three models: a constant rate model (from above), a piecewise constant rate model, and a piecewise constant rate model with history.</p><pre class="codeinput">    close <span class="string">all</span>;
 <span class="comment">% load the data;</span>
    washout1 = importdata(<span class="string">'washout1.txt'</span>);
    washout2 = importdata(<span class="string">'washout2.txt'</span>);

    sampleRate  = 1000;
    <span class="comment">% Magnesium removed at t=0</span>
    spikeTimes1 = 260+washout1.data(:,2)*1/sampleRate; <span class="comment">%in seconds</span>
    spikeTimes2 = sort(washout2.data(:,2))*1/sampleRate + 745;<span class="comment">%in seconds</span>
    nst = nspikeTrain([spikeTimes1; spikeTimes2]);
    time = 260:(1/sampleRate):nst.maxTime;
</pre><h2 id="4">Data Visualization</h2><p>Visual inspection of the spike train is used to pick three regions where the firing rate appears to be different. Here we do not estimate where these transitions happen but pick times in an ad-hoc manner.</p><pre class="codeinput">    scrsz = get(0,<span class="string">'ScreenSize'</span>);
    h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.01 scrsz(4)*.04 scrsz(3)*.6 <span class="keyword">...</span>
        scrsz(4)*.9]);

    subplot(2,1,1);
    nstConst.plot; set(gca,<span class="string">'yTick'</span>,[0 1]); hy=ylabel(<span class="string">'mEPSCs'</span>);
     title({<span class="string">'Neural Raster with constant Mg^{2+} Concentration'</span>},<span class="keyword">...</span>
         <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hx=get(gca,<span class="string">'XLabel'</span>);
    set([hx,hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

    subplot(2,1,2);
    nst.plot; set(gca,<span class="string">'yTick'</span>,[0 1]); hy=ylabel(<span class="string">'mEPSCs'</span>);
    title({<span class="string">'Neural Raster with decreasing Mg^{2+} Concentration'</span>},<span class="keyword">...</span>
        <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hx=get(gca,<span class="string">'XLabel'</span>);
    set([hx,hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_02.png" alt=""> <h2 id="5">Define Covariates for the analysis</h2><pre class="codeinput">          timeInd1 =find(time&lt;495,1,<span class="string">'last'</span>); <span class="comment">%0-495sec first constant rate</span>
        timeInd2 =find(time&lt;765,1,<span class="string">'last'</span>); <span class="comment">%495-765 second constant rate epoch</span>
                                       <span class="comment">%765 onwards third constant rate</span>
                                       <span class="comment">%epoch</span>
    constantRate = ones(length(time),1);
    rate1 = zeros(length(time),1); rate1(1:timeInd1)=1;
    rate2 = zeros(length(time),1); rate2((timeInd1+1):timeInd2)=1;
    rate3 = zeros(length(time),1); rate3((timeInd2+1):end)=1;
    baseline = Covariate(time,[constantRate,rate1, rate2, rate3],<span class="keyword">...</span>
        <span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,{<span class="string">'\mu'</span>,<span class="string">'\mu_{1}'</span>,<span class="string">'\mu_{2}'</span>,<span class="string">'\mu_{3}'</span>});
    covarColl = CovColl({baseline});

    <span class="comment">% Create the trial structure</span>
    spikeColl = nstColl(nst);
    trial     = Trial(spikeColl,covarColl);

    <span class="comment">%30ms history in logarithmic spacing (chosen after using</span>
    <span class="comment">%Analysis.computeHistLagForAll for various window lengths)</span>
    maxWindow=.3; numWindows=20;
    delta=1/sampleRate;
    windowTimes =unique(round([0 logspace(log10(delta),<span class="keyword">...</span>
    log10(maxWindow),numWindows)]*sampleRate)./sampleRate);
    windowTimes = windowTimes(1:11);
</pre><h2 id="6">Define how we want to analyze the data</h2><pre class="codeinput">    clear <span class="string">tc</span> <span class="string">tcc</span>;
    tc{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>}},sampleRate,[]);
    tc{1}.setName(<span class="string">'Constant Baseline'</span>);
    tc{2} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu_{1}'</span>,<span class="string">'\mu_{2}'</span>,<span class="string">'\mu_{3}'</span>}},<span class="keyword">...</span>
        sampleRate,[]); tc{2}.setName(<span class="string">'Diff Baseline'</span>);
    tcc = ConfigColl(tc);
</pre><h2 id="7">Perform Analysis</h2><p>We see that the piece-wise constant rate model (without history) outperforms the constant baseline model in terms of AIC, BIC, and KS-statistic.</p><pre class="codeinput">    results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);
<span class="comment">%     h=results.plotResults;</span>
<span class="comment">%     Summary = FitResSummary(results);</span>
<span class="comment">%     h=Summary.plotSummary;</span>
</pre><pre class="codeoutput">Analyzing Configuration #1: Neuron #1
Analyzing Configuration #2: Neuron #1
</pre><pre class="codeinput">close <span class="string">all</span>;
    scrsz = get(0,<span class="string">'ScreenSize'</span>);
    results.lambda.setDataLabels({<span class="string">'\lambda_{const}'</span>,<span class="keyword">...</span>
        <span class="string">'\lambda_{const-epoch}'</span>});
    h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.01 scrsz(4)*.04 <span class="keyword">...</span>
        scrsz(3)*.98 scrsz(4)*.95]);

    subplot(2,2,1); spikeColl.plot;
        title({<span class="string">'Neural Raster with decreasing Mg^{2+} Concentration'</span>},<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
        hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
        set(gca,<span class="string">'YTickLabel'</span>,[]);
        set([hx],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
        timeInd1 =find(time&lt;495,1,<span class="string">'last'</span>); <span class="comment">%0-495sec first constant rate</span>
        timeInd2 =find(time&lt;765,1,<span class="string">'last'</span>); <span class="comment">%495-765 second constant rate epoch</span>
                                       <span class="comment">%765 onwards third constant rate</span>
                                       <span class="comment">%epoch</span>
        plot([495;495],[0,1],<span class="string">'r'</span>,<span class="string">'Linewidth'</span>,4); hold <span class="string">on</span>;
        plot([765;765],[0,1],<span class="string">'r'</span>,<span class="string">'Linewidth'</span>,4);

    subplot(2,2,3); results.KSPlot;
    subplot(2,2,2); results.plotInvGausTrans;
    subplot(2,2,4);
    results.lambda.getSubSignal(1).plot([],{{<span class="string">' ''b'' ,''Linewidth'',2'</span>}});
    results.lambda.getSubSignal(2).plot([],{{<span class="string">' ''g'' ,''Linewidth'',2'</span>}});
                    v=axis; axis([v(1) v(2) 0 5]);
    hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    hy=get(gca,<span class="string">'YLabel'</span>);
    set([hx hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    h_legend = legend(<span class="string">'\lambda_{const}'</span>,<span class="string">'\lambda_{const-epoch}'</span>,<span class="keyword">...</span>
        <span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)+.05 pos(2)-.01 pos(3:4)]);
    set(h_legend,<span class="string">'FontSize'</span>,14)
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_03.png" alt=""> <h2 id="9">Experiment 2</h2><p>EXPLICIT STIMULUS EXAMPLE - WHISKER STIMULATION/THALAMIC NEURON In the worksheet with analyze the stimulus effect and history effect on the firing of a thalamic neuron under a known stimulus consisting of whisker stimulation. Data from Demba Ba (<a href="mailto:demba@mit.edu">demba@mit.edu</a>)</p><h2 id="10">Load the data</h2><p>clear all;</p><pre class="codeinput">close <span class="string">all</span>; currdir = pwd;
index = strfind(currdir,<span class="string">'helpfiles'</span>)-1;
rootpath = currdir(1:index);

Direction=3; Neuron=1; Stim=2;
<span class="comment">% datapath = strcat(rootpath,['data/Explicit Stimulus/Dir' num2str(Direction)...</span>
<span class="comment">%     '\Neuron' num2str(Neuron) '\Stim' num2str(Stim) '\']);</span>
datapath = strcat(rootpath,[<span class="string">'data/Explicit Stimulus/Dir'</span> num2str(Direction)<span class="keyword">...</span>
    <span class="string">'/Neuron'</span> num2str(Neuron) <span class="string">'/Stim'</span> num2str(Stim) <span class="string">'/'</span>]);
data=load(strcat(datapath,<span class="string">'trngdataBis.mat'</span>));

time=0:.001:(length(data.t)-1)*.001;
stimData = data.t;
spikeTimes = time(data.y==1);

stim = Covariate(time,stimData./10,<span class="string">'Stimulus'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'mm'</span>,{<span class="string">'stim'</span>});
baseline = Covariate(time,ones(length(time),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,<span class="keyword">...</span>
    {<span class="string">'constant'</span>});

nst = nspikeTrain(spikeTimes);
nspikeColl = nstColl(nst);
cc = CovColl({stim,baseline});
trial = Trial(nspikeColl,cc);
<span class="comment">% trial.plot;</span>

scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
subplot(3,1,1);
nst2 = nspikeTrain(spikeTimes);
nst2.setMaxTime(21);nst2.plot;
set(gca,<span class="string">'ytick'</span>,[0 1]);
xlabel(<span class="string">''</span>);
hy=ylabel(<span class="string">'spikes'</span>);
set(hy,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title({<span class="string">'Neural Raster'</span>},<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
set(gca, <span class="keyword">...</span>
  <span class="string">'XTick'</span>       , 0:1:max(time), <span class="keyword">...</span>
  <span class="string">'XTickLabel'</span>  , [],<span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );
subplot(3,1,2);
stim.getSigInTimeWindow(0,21).plot([],{{<span class="string">' ''k'' '</span>}}); legend <span class="string">off</span>;
set(gca,<span class="string">'ytick'</span>,[0 0.5 1]);
hy=ylabel(<span class="string">'Displacement [mm]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>); xlabel(<span class="string">''</span>);
set(hy,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title({<span class="string">'Stimulus - Whisker Displacement'</span>},<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

set(gca, <span class="keyword">...</span>
  <span class="string">'XTick'</span>       , 0:1:max(time), <span class="keyword">...</span>
  <span class="string">'XTickLabel'</span>  , [],<span class="keyword">...</span>
  <span class="string">'YTick'</span>       , 0:.25:1, <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );

subplot(3,1,3);
stim.derivative.getSigInTimeWindow(0,21).plot([],{{<span class="string">' ''k'' '</span>}}); legend <span class="string">off</span>;
set(gca,<span class="string">'ytick'</span>,[-80 0 80]);
axis([0 21 -80 80]);
hy=ylabel(<span class="string">'Displacement Velocity [mm/s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
hx= xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set([hx hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title({<span class="string">'Displacement Velocity'</span>},<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
    <span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

set(gca, <span class="keyword">...</span>
  <span class="string">'XTick'</span>       , 0:1:max(time), <span class="keyword">...</span>
  <span class="string">'YTick'</span>       , -80:40:80, <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_04.png" alt=""> <p>Fit a constant baseline and Find Stimulus Lag We fit a constant rate (Poisson) model to the data and use the look at the cross-covariance function of between the stimulus and the fit residual to determine the appropriate lag for the stimulus.</p><pre class="codeinput">clear <span class="string">c</span>; close <span class="string">all</span>;
selfHist = [] ; NeighborHist = []; sampleRate = 1000;
c{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'constant'</span>}},sampleRate,selfHist,NeighborHist);
c{1}.setName(<span class="string">'Baseline'</span>);
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial,cfgColl,0);

<span class="comment">% Find Stimulus Lag (look for peaks in the cross-covariance function less</span>
<span class="comment">% than 1 second</span>
scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(7,2,[1 3 5])
results.Residual.xcov(stim).windowedSignal([0,1]).plot;

ylabel(<span class="string">''</span>);
[m,ind,ShiftTime] = max(results.Residual.xcov(stim).windowedSignal([0,1]));
title([<span class="string">'Cross Correlation Function - Peak at t='</span> num2str(ShiftTime) <span class="string">' sec'</span>],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
hold <span class="string">on</span>;
h=plot(ShiftTime,m,<span class="string">'ro'</span>,<span class="string">'Linewidth'</span>,3);
set(h, <span class="string">'MarkerFaceColor'</span>,[1 0 0], <span class="string">'MarkerEdgeColor'</span>,[1 0 0]);
hx=xlabel(<span class="string">'Lag [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set(hx,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);


<span class="comment">%Allow for shifts of less than 1 second</span>
stim = Covariate(time,stimData,<span class="string">'Stimulus'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'V'</span>,{<span class="string">'stim'</span>});
stim = stim.shift(ShiftTime);
baseline = Covariate(time,ones(length(time),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,<span class="keyword">...</span>
    {<span class="string">'\mu'</span>});

nst = nspikeTrain(spikeTimes);
nspikeColl = nstColl(nst);
cc = CovColl({stim,baseline});
trial2 = Trial(nspikeColl,cc);
</pre><pre class="codeoutput">Analyzing Configuration #1: Neuron #1
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_05.png" alt=""> <h2 id="12">Compare constant rate model with model including stimulus effect</h2><p>Addition of the stimulus improves the fits in terms of the KS plot and the making the rescaled ISIs less correlated. The Point Process Residula also looks more "white"</p><pre class="codeinput">clear <span class="string">c</span>;
selfHist = [] ; NeighborHist = []; sampleRate = 1000;
c{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>}},sampleRate,selfHist,<span class="keyword">...</span>
    NeighborHist);
c{1}.setName(<span class="string">'Baseline'</span>);
c{2} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>},{<span class="string">'Stimulus'</span>,<span class="string">'stim'</span>}},<span class="keyword">...</span>
    sampleRate,selfHist,NeighborHist);
c{2}.setName(<span class="string">'Baseline+Stimulus'</span>);
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial2,cfgColl,0);
<span class="comment">% results.plotResults;</span>
</pre><pre class="codeoutput">Analyzing Configuration #1: Neuron #1
Analyzing Configuration #2: Neuron #1
</pre><h2 id="13">History Effect</h2><p>Determine the best history effect model using AIC, BIC, and KS statistic</p><pre class="codeinput">sampleRate=1000;
delta=1/sampleRate*1;
maxWindow=1; numWindows=32;
windowTimes =unique(round([0 logspace(log10(delta),<span class="keyword">...</span>
    log10(maxWindow),numWindows)]*sampleRate)./sampleRate);
results =Analysis.computeHistLagForAll(trial2,windowTimes,<span class="keyword">...</span>
    {{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>},{<span class="string">'Stimulus'</span>,<span class="string">'stim'</span>}},<span class="string">'BNLRCG'</span>,0,sampleRate,0);

KSind = find(results{1}.KSStats.ks_stat == min(results{1}.KSStats.ks_stat));
AICind = find((results{1}.AIC(2:end)-results{1}.AIC(1))== <span class="keyword">...</span>
               min(results{1}.AIC(2:end)-results{1}.AIC(1))) +1;
BICind = find((results{1}.BIC(2:end)-results{1}.BIC(1))== <span class="keyword">...</span>
               min(results{1}.BIC(2:end)-results{1}.BIC(1))) +1;
<span class="keyword">if</span>(AICind==1)
    AICind=inf;
<span class="keyword">end</span>
<span class="keyword">if</span>(BICind==1)
    BICind=inf; <span class="comment">%sometime BIC is non-decreasing and the index would be 1</span>
<span class="keyword">end</span>
windowIndex = min([AICind,BICind]) <span class="comment">%use the minimum order model</span>
Summary = FitResSummary(results);
<span class="comment">% Summary.plotSummary;</span>


clear <span class="string">c</span>;
<span class="keyword">if</span>(windowIndex&gt;1)
    selfHist = windowTimes(1:windowIndex+1);
<span class="keyword">else</span>
    selfHist = [];
<span class="keyword">end</span>
NeighborHist = []; sampleRate = 1000;
<span class="comment">%</span>
<span class="comment">% figure;</span>
subplot(7,2,2);
x=0:length(windowTimes)-1;
plot(x,results{1}.KSStats.ks_stat,<span class="string">'.-'</span>); axis <span class="string">tight</span>; hold <span class="string">on</span>;
plot(x(windowIndex),results{1}.KSStats.ks_stat(windowIndex),<span class="string">'r*'</span>);

 set(gca,<span class="string">'XTick'</span>, 0:5:results{1}.numResults-1,<span class="string">'XTickLabel'</span>,[],<span class="keyword">...</span>
     <span class="string">'TickLength'</span>, [.02 .02] , <span class="keyword">...</span>
  <span class="string">'XMinorTick'</span>, <span class="string">'on'</span>,<span class="string">'LineWidth'</span>   , 1);

hy=ylabel(<span class="string">'KS Statistic'</span>);
set(hy,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
dAIC = results{1}.AIC-results{1}.AIC(1);
 title({<span class="string">'Model Selection via change'</span>; <span class="string">'in KS Statistic, AIC, and BIC'</span>},<span class="keyword">...</span>
     <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'FontSize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

subplot(7,2,4); plot(x,dAIC,<span class="string">'.-'</span>);
set(gca,<span class="string">'XTick'</span>, 0:5:results{1}.numResults-1,<span class="string">'XTickLabel'</span>,[],<span class="keyword">...</span>
     <span class="string">'TickLength'</span>, [.02 .02] , <span class="keyword">...</span>
  <span class="string">'XMinorTick'</span>, <span class="string">'on'</span>,<span class="string">'LineWidth'</span>   , 1);
hy=ylabel(<span class="string">'\Delta AIC'</span>);axis <span class="string">tight</span>; hold <span class="string">on</span>;
set(hy,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
plot(x(windowIndex),dAIC(windowIndex),<span class="string">'r*'</span>);
dBIC = results{1}.BIC-results{1}.BIC(1);

subplot(7,2,6); plot(x,dBIC,<span class="string">'.-'</span>);
hy=ylabel(<span class="string">'\Delta BIC'</span>); axis <span class="string">tight</span>; hold <span class="string">on</span>;

plot(x(windowIndex),dBIC(windowIndex),<span class="string">'r*'</span>);
hx=xlabel(<span class="string">'# History Windows, Q'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
set(gca, <span class="keyword">...</span>
  <span class="string">'TickLength'</span>  , [.02 .02] , <span class="keyword">...</span>
  <span class="string">'XMinorTick'</span>  , <span class="string">'on'</span>      , <span class="keyword">...</span>
  <span class="string">'XTick'</span>       , 0:5:results{1}.numResults-1, <span class="keyword">...</span>
  <span class="string">'LineWidth'</span>   , 1         );



<span class="comment">% Compare Baseline, Baseline+Stimulus Model, Baseline+History+Stimulus</span>
<span class="comment">% Addition of the history effect yields a model that falls within the 95%</span>
<span class="comment">% CI of the KS plot.</span>

c{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>}},sampleRate,[],NeighborHist);
c{1}.setName(<span class="string">'Baseline'</span>);
c{2} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>},{<span class="string">'Stimulus'</span>,<span class="string">'stim'</span>}},<span class="keyword">...</span>
                    sampleRate,[],[]);
c{2}.setName(<span class="string">'Baseline+Stimulus'</span>);
c{3} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'\mu'</span>},{<span class="string">'Stimulus'</span>,<span class="string">'stim'</span>}},<span class="keyword">...</span>
                    sampleRate,windowTimes(1:windowIndex),[]);
c{3}.setName(<span class="string">'Baseline+Stimulus+Hist'</span>);
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial2,cfgColl,0);
<span class="comment">%results.plotResults;</span>
<span class="comment">%</span>
results.lambda.setDataLabels({<span class="string">'\lambda_{const}'</span>,<span class="string">'\lambda_{const+stim}'</span>,<span class="keyword">...</span>
    <span class="string">'\lambda_{const+stim+hist}'</span>});
subplot(7,2,[9 11 13]); results.KSPlot;
subplot(7,2,[10 12 14]); results.plotCoeffs; legend <span class="string">off</span>;
</pre><pre class="codeoutput">Analyzing Configuration #1: Neuron #1
Analyzing Configuration #2: Neuron #1
Analyzing Configuration #3: Neuron #1
Analyzing Configuration #4: Neuron #1
Analyzing Configuration #5: Neuron #1
Analyzing Configuration #6: Neuron #1
Analyzing Configuration #7: Neuron #1
Analyzing Configuration #8: Neuron #1
Analyzing Configuration #9: Neuron #1
Analyzing Configuration #10: Neuron #1
Analyzing Configuration #11: Neuron #1
Analyzing Configuration #12: Neuron #1
Analyzing Configuration #13: Neuron #1
Analyzing Configuration #14: Neuron #1
Analyzing Configuration #15: Neuron #1
Analyzing Configuration #16: Neuron #1
Analyzing Configuration #17: Neuron #1
Analyzing Configuration #18: Neuron #1
Analyzing Configuration #19: Neuron #1
Analyzing Configuration #20: Neuron #1
Analyzing Configuration #21: Neuron #1
Analyzing Configuration #22: Neuron #1
Analyzing Configuration #23: Neuron #1
Analyzing Configuration #24: Neuron #1
Analyzing Configuration #25: Neuron #1
Analyzing Configuration #26: Neuron #1
Analyzing Configuration #27: Neuron #1
Analyzing Configuration #28: Neuron #1
Analyzing Configuration #29: Neuron #1
Analyzing Configuration #30: Neuron #1

windowIndex =

    10

Analyzing Configuration #1: Neuron #1
Analyzing Configuration #2: Neuron #1
Analyzing Configuration #3: Neuron #1
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_06.png" alt=""> <h2 id="14">Example 3 - PSTH Data</h2><pre class="codeinput"><span class="comment">% Generate a known Conditional Intensity Function</span>
<span class="comment">% We generated a known conditional intensity function (rate function) and</span>
<span class="comment">% generate distinct realizations of point processes consistent with this</span>
<span class="comment">% rate function. We use the method of thinning to simulate a point process.</span>
clear <span class="string">all</span>;
close <span class="string">all</span>;
delta = 0.001;
Tmax = 1;
time = 0:delta:Tmax;
f=2;
mu = -3;

tempData = 1*sin(2*pi*f*time)+mu; <span class="comment">%lambda &gt;=0</span>
lambdaData = exp(tempData)./(1+exp(tempData))*(1/delta);
lambda = Covariate(time,lambdaData, <span class="string">'\lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="keyword">...</span>
    <span class="string">'spikes/sec'</span>,{<span class="string">'\lambda_{1}'</span>},{{<span class="string">' ''b'', ''LineWidth'' ,2'</span>}});
numRealizations = 20;
spikeCollSim = CIF.simulateCIFByThinningFromLambda(lambda,numRealizations);


scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(2,2,3);spikeCollSim.plot;
set(gca,<span class="string">'YTick'</span>,0:5:numRealizations,<span class="string">'YTickLabel'</span>,0:5:numRealizations);
title({[num2str(numRealizations) <span class="string">' Simulated Point Process Sample Paths'</span>]},<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

subplot(2,2,1);lambda.plot;
title({<span class="string">'Simulated Conditional Intensity Function (CIF)'</span>},<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
hy=get(gca,<span class="string">'YLabel'</span>);
set(hy,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

fileLocation = which(<span class="string">'nSTAT_Install'</span>);
index = strfind(fileLocation,<span class="string">'nSTAT_Install.m'</span>)-1;
nSTATDir =fileLocation(1:index);

rootDir = [nSTATDir <span class="string">'data'</span> filesep <span class="string">'PSTH'</span> filesep];
filename = <span class="string">'Results.mat'</span>;
x=load(strcat(rootDir,filename));
numTrials = x.Results.Data.Spike_times_STC.balanced_SUA.Nr_trials;
cellNum=6; clear <span class="string">nst</span>;
<span class="keyword">for</span> i=1:numTrials
    spikeTimes{i}=x.Results.Data.Spike_times_STC.balanced_SUA.spike_times{1,i,cellNum};
    nst{i} = nspikeTrain(spikeTimes{i});
    nst{i}.setName(num2str(cellNum));
<span class="keyword">end</span>

spikeCollReal1=nstColl(nst);
spikeCollReal1.setMinTime(0); spikeCollReal1.setMaxTime(2);
subplot(2,2,2);spikeCollReal1.plot;  set(gca,<span class="string">'YTick'</span>,0:2:numTrials,<span class="keyword">...</span>
    <span class="string">'YTickLabel'</span>,0:2:numTrials);
<span class="comment">%set(gca,'xtick',[0:.5:2],'xtickLabel',{'0','0.5','1','1.5','2'});</span>
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Response to Moving Visual Stimulus (Neuron 6)'</span>,<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

cellNum=1; clear <span class="string">nst</span>;
<span class="keyword">for</span> i=1:numTrials
    spikeTimes{i}=x.Results.Data.Spike_times_STC.balanced_SUA.spike_times{1,i,cellNum};
    nst{i} = nspikeTrain(spikeTimes{i});
    nst{i}.setName(num2str(cellNum));
<span class="keyword">end</span>

spikeCollReal2=nstColl(nst);
spikeCollReal2.setMinTime(0); spikeCollReal2.setMaxTime(2);
subplot(2,2,4);spikeCollReal2.plot;
set(gca,<span class="string">'YTick'</span>,0:2:numTrials,<span class="string">'YTickLabel'</span>,0:2:numTrials);
<span class="comment">%set(gca,'xtick',[0:.5:2],'xtickLabel',{'0','0.5','1','1.5','2'});</span>
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Response to Moving Visual Stimulus (Neuron 1)'</span>,<span class="string">'FontWeight'</span>,<span class="keyword">...</span>
    <span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
</pre><pre class="codeoutput">Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_07.png" alt=""> <h2 id="15">Estimate the PSTH with 50ms windows</h2><pre class="codeinput">close <span class="string">all</span>;

scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

binsize = .05; <span class="comment">%50ms window</span>
psth    = spikeCollSim.psth(binsize);
psthGLM = spikeCollSim.psthGLM(binsize);
true = lambda; <span class="comment">%rate*delta = expected number of arrivals per bin</span>
subplot(2,3,4);

h1=true.plot([],{{<span class="string">' ''b'',''Linewidth'',4'</span>}});
h3=psthGLM.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}});
h2=psth.plot([],{{<span class="string">' ''rx'',''Linewidth'',4'</span>}});

xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'[spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

legend <span class="string">off</span>;
h_legend=legend([h1(1) h2(1)  h3(1)],<span class="string">'true'</span>,<span class="string">'PSTH'</span>,<span class="string">'PSTH_{glm}'</span>);
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.005 pos(2)+.095 pos(3:4)]);


<span class="comment">%</span>
subplot(2,3,1);spikeCollSim.plot;
set(gca,<span class="string">'YTick'</span>,0:2:spikeCollSim.numSpikeTrains,<span class="string">'YTickLabel'</span>,0:2:spikeCollSim.numSpikeTrains);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

subplot(2,3,5);
binsize = .05; <span class="comment">%50ms window</span>
psthReal1    = spikeCollReal1.psth(binsize);
psthGLMReal1 = spikeCollReal1.psthGLM(binsize);<span class="comment">%,[],[],[],[],[],1000);</span>

h3=psthGLMReal1.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}});
h2=psthReal1.plot([],{{<span class="string">' ''rx'',''Linewidth'',4'</span>}});
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'[spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

h_legend=legend([h2(1)  h3(1)],<span class="string">'PSTH'</span>,<span class="string">'PSTH_{glm}'</span>);
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.005 pos(2)+.07 pos(3:4)]);
subplot(2,3,2); spikeCollReal1.plot;
set(gca,<span class="string">'YTick'</span>,0:2:spikeCollReal2.numSpikeTrains,<span class="string">'YTickLabel'</span>,0:2:spikeCollReal2.numSpikeTrains);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
subplot(2,3,6);
psthReal2    = spikeCollReal2.psth(binsize);
psthGLMReal2 = spikeCollReal2.psthGLM(binsize);<span class="comment">%,[],[],[],[],[],1000);</span>
h3=psthGLMReal2.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}});
h2=psthReal2.plot([],{{<span class="string">' ''rx'',''Linewidth'',4'</span>}});
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'[spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);


h_legend=legend([h2(1)  h3(1)],<span class="string">'PSTH'</span>,<span class="string">'PSTH_{glm}'</span>);
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.005 pos(2)+.07 pos(3:4)]);
subplot(2,3,3); spikeCollReal2.plot;
set(gca,<span class="string">'YTick'</span>,0:2:spikeCollReal2.numSpikeTrains,<span class="string">'YTickLabel'</span>,0:2:spikeCollReal2.numSpikeTrains);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
</pre><pre class="codeoutput">Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #6
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_08.png" alt=""> <h2 id="16">Example 3b - SSGLM Example</h2><p>Example of estimating with-in and across trial dynamics Methods from: G. Czanner, U. T. Eden, S. Wirth, M. Yanike, W. A. Suzuki, and E. N. Brown, "Analysis of between-trial and within-trial neural spiking dynamics.," Journal of neurophysiology, vol. 99, no. 5, pp. 2672?2693, May. 2008.</p><pre class="codeinput">close <span class="string">all</span>;
clear <span class="string">all</span>;
<span class="comment">% set(0,'DefaultFigureRenderer','ZBuffer')</span>
delta = 0.001; Tmax = 1;
time = 0:delta:Tmax;
Ts=.001;
numRealizations = 50; <span class="comment">%Each realization corresponds to a distinct trial</span>

<span class="keyword">for</span> i=1:numRealizations
    <span class="comment">% The within trial dynamics are sinusoidal</span>
    <span class="comment">% For each trial the stimulus effect increases</span>
    f=2; b1(i)=3*((i)/numRealizations);b0=-3;
    u = sin(2*pi*f*time);
    e = zeros(length(time),1);   <span class="comment">%No Ensemble input</span>

    stim=Covariate(time',u,<span class="string">'Stimulus'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'Voltage'</span>,{<span class="string">'sin'</span>});
    ens =Covariate(time',e,<span class="string">'Ensemble'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'Spikes'</span>,{<span class="string">'n1'</span>});

    mu=b0;
    histCoeffs=[-4 -1 -.5];
    H=tf(histCoeffs,[1],Ts,<span class="string">'Variable'</span>,<span class="string">'z^-1'</span>);

    S=tf([b1(i)],1,Ts,<span class="string">'Variable'</span>,<span class="string">'z^-1'</span>);
    E=tf([0],1,Ts,<span class="string">'Variable'</span>,<span class="string">'z^-1'</span>);
    simTypeSelect=<span class="string">'binomial'</span>; <span class="comment">%Parameters are used to compute</span>
                              <span class="comment">%binomial conditional intensity function</span>
                              <span class="comment">%</span>

    <span class="comment">% Obtain a realization of the point process with the current</span>
    <span class="comment">% stimulus and history effect</span>
    [sC, lambdaTemp]=CIF.simulateCIF(mu,H,S,E,stim,ens,1,simTypeSelect);

    <span class="keyword">if</span>(i==1)
        lambda=lambdaTemp; <span class="comment">%Store the conditional intensity function</span>
    <span class="keyword">else</span>
        lambda = lambda.merge(lambdaTemp); <span class="comment">%Add it to the other realizations</span>
    <span class="keyword">end</span>

    nst{i} = sC.getNST(1);             <span class="comment">%get the neural spikeTrain from the collection</span>
    nst{i} = nst{i}.resample(1/delta); <span class="comment">%make sure that it is sampled at the current samplerate</span>
<span class="keyword">end</span>

spikeColl = nstColl(nst); <span class="comment">%Create a collection of the spike trains across trials</span>
</pre><pre class="codeoutput">Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
</pre><h2 id="17">Summarize Simulated Data</h2><pre class="codeinput">close <span class="string">all</span>;
scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

<span class="comment">%Plot the raster</span>
subplot(3,2,[3 4]); spikeColl.plot;
set(gca,<span class="string">'ytick'</span>,0:10:numRealizations,<span class="string">'ytickLabel'</span>,0:10:numRealizations);
set(gca,<span class="string">'xtick'</span>,0:.1:Tmax,<span class="string">'xtickLabel'</span>,0:.1:Tmax); xlabel(<span class="string">''</span>);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Simulated Neural Raster'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,14,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

<span class="comment">% Plot the actual stimulus effect (not including history)</span>
<span class="comment">% The CIF including the history effect is stored in the lambda Covariate</span>
<span class="comment">% above</span>


stimData = exp(b0 + u'*b1);
<span class="keyword">if</span>(strcmp(simTypeSelect,<span class="string">'binomial'</span>))
    stimData = stimData./(1+stimData);
<span class="keyword">end</span>

<span class="comment">%Plot the trial dependence</span>
subplot(3,2,1); plot(time,u,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3);
<span class="comment">% xlabel('time [s]');ylabel('stimulus');</span>
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Stimulus'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Within Trial Stimulus'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,14,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

subplot(3,2,2); plot(1:length(b1),b1,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3);
xlabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Stimulus Gain'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
    12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Across Trial Stimulus Gain'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>,<span class="keyword">...</span>
    <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

subplot(3,2,[5 6]);
imagesc(stimData'./delta);  set(gca, <span class="string">'YDir'</span>,<span class="string">'normal'</span>);
set(gca,<span class="string">'xtick'</span>,0:100:Tmax/delta,<span class="string">'xtickLabel'</span>,0:.1:Tmax);
set(gca,<span class="string">'ytick'</span>,0:10:numRealizations,<span class="string">'ytickLabel'</span>,0:10:numRealizations);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
ylabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="keyword">...</span>
    <span class="string">'Fontsize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'True Conditional Intensity Function'</span>,<span class="string">'Interpreter'</span>,<span class="keyword">...</span>
    <span class="string">'none'</span>,<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);


axis <span class="string">tight</span>;
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_09.png" alt=""> <h2 id="18">Estimation of the Stimulus Response</h2><pre class="codeinput"><span class="comment">% Create the covariates that will be used for the GLM regression</span>
stim = Covariate(time,sin(2*pi*f*time),<span class="string">'Stimulus'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'V'</span>,{<span class="string">'stim'</span>});
baseline = Covariate(time,ones(length(time),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,<span class="keyword">...</span>
                    {<span class="string">'constant'</span>});

<span class="comment">% Specify the windows of the history coefficients to be estimated</span>
windowTimes=[0:.001:.003];
<span class="comment">% Number of bins to discrtize time into (used both for the PSTH and for</span>
<span class="comment">% thec</span>
<span class="comment">% SSGLM model.</span>
numBasis = 25;

spikeColl.resample(1/delta); <span class="comment">% Enforce sampleRate</span>
spikeColl.setMaxTime(Tmax);  <span class="comment">% Make all spikeTrains end at time Tmax</span>


dN=spikeColl.dataToMatrix';  <span class="comment">% Convert the spikeTrains into a matrix</span>
                             <span class="comment">% of 1's and 0's corresponding to the presence</span>
                             <span class="comment">% or absense of a spike in each time window.</span>
dN(dN&gt;1)=1;                  <span class="comment">% One should sample finely enough so there is</span>
                             <span class="comment">% one spike per bin. Here we make sure that</span>
                             <span class="comment">% this is the case regardless of the</span>
                             <span class="comment">% sampleRate</span>

<span class="comment">% The width of each rectangular basis pulse is determined by Tmax and by the</span>
<span class="comment">% number of basis pulses to use.</span>
basisWidth=(spikeColl.maxTime-spikeColl.minTime)/numBasis;

<span class="keyword">if</span>(simTypeSelect==0)
    fitType=<span class="string">'binomial'</span>;
<span class="keyword">else</span>
    fitType=<span class="string">'poisson'</span>;
<span class="keyword">end</span>
<span class="keyword">if</span>(strcmp(fitType,<span class="string">'binomial'</span>))
    Algorithm = <span class="string">'BNLRCG'</span>;   <span class="comment">% BNLRCG - faster Truncated, L-2 Regularized,</span>
                            <span class="comment">% Binomial Logistic Regression with Conjugate</span>
                            <span class="comment">% Gradient Solver by Demba Ba (demba@mit.edu).</span>
<span class="keyword">else</span>
    Algorithm = <span class="string">'GLM'</span>;      <span class="comment">% Standard Matlab GLM (Can be used for binomial or</span>
                            <span class="comment">% or Poisson CIFs</span>
<span class="keyword">end</span>

<span class="comment">% Use the values obtained from a PSTH to initialize the SSGLM filter</span>
[psthSig, ~, psthResult] =spikeColl.psthGLM(basisWidth,windowTimes,fitType);
gamma0=psthResult.getHistCoeffs';<span class="comment">%+.1*randn(size(histCoeffs));</span>
gamma0(isnan(gamma0))=-5; <span class="comment">% Depending on the amount of data the</span>
                          <span class="comment">% the psth may not identify all parameters</span>
                          <span class="comment">% Just make sure that the estimates are real</span>
                          <span class="comment">% numbers</span>

x0=psthResult.getCoeffs;  <span class="comment">%The initial estimate for the SSGLM model</span>

<span class="comment">% Estimate the variance within each time bin across trials</span>
numVarEstIter=10;
Q0 = spikeColl.estimateVarianceAcrossTrials(numBasis,windowTimes,<span class="keyword">...</span>
    numVarEstIter,fitType);
A=eye(numBasis,numBasis);
delta = 1/spikeColl.sampleRate;
</pre><pre class="codeoutput">Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
Running in batch mode: neurons with same name are fit simultaneously
Analyzing Configuration #1: Neuron #1
A=eye(numBasis,numBasis);
delta = 1/spikeColl.sampleRate;
</pre><h2 id="19">Run the SSGLM Filter</h2><pre class="codeinput">CompilingHelpFile=1;
    <span class="comment">% Commented out to speed up help file creation ...</span>
    <span class="keyword">if</span>(~CompilingHelpFile)
        Q0d=diag(Q0);
        neuronName = psthResult.neuronNumber;
        [xK,WK, WkuFinal,Qhat,gammahat,fitResults,stimulus,stimCIs,logll,<span class="keyword">...</span>
            QhatAll,gammahatAll,nIter]=DecodingAlgorithms.PPSS_EMFB(A,Q0d,x0,<span class="keyword">...</span>
            dN,fitType,delta,gamma0,windowTimes, numBasis,neuronName);

        fR = fitResults.toStructure;
        psthR = psthResult.toStructure;
    <span class="keyword">end</span>
<span class="comment">% save SSGLMExampleData psthR fR xK WK WkuFinal Qhat gammahat fitResults stimulus stimCIs logll QhatAll gammahatAll nIter;</span>
</pre><pre class="codeoutput">
%% Run the SSGLM Filter
CompilingHelpFile=1;
    % Commented out to speed up help file creation ... 
    if(~CompilingHelpFile)
</pre><pre class="codeinput">load <span class="string">SSGLMExampleData</span>;
fitResults = FitResult.fromStructure(fR);
psthResult = FitResult.fromStructure(psthR);
</pre><pre class="codeoutput">% save SSGLMExampleData psthR fR xK WK WkuFinal Qhat gammahat fitResults stimulus stimCIs logll QhatAll gammahatAll nIter;
%%
load SSGLMExampleData;
fitResults = FitResult.fromStructure(fR);
psthResult = FitResult.fromStructure(psthR);
</pre><pre class="codeinput">t=psthResult.mergeResults(fitResults);
<span class="comment">%t.plotResults; %Compare the results with the PSTH Model</span>
t.lambda.setDataLabels({<span class="string">'\lambda_{PSTH}'</span>,<span class="string">'\lambda_{SSGLM}'</span>});
scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
subplot(2,2,1); t.KSPlot;
subplot(2,2,2); t.plotResidual;
subplot(2,2,3); t.plotInvGausTrans;
subplot(2,2,4); t.plotSeqCorr;

S=FitResSummary(t);
dAIC=diff(S.AIC)
dBIC=diff(S.BIC)
dKS =diff(S.KSStats);
</pre><pre class="codeoutput">
%%
t=psthResult.mergeResults(fitResults);
%t.plotResults; %Compare the results with the PSTH Model
t.lambda.setDataLabels({'\lambda_{PSTH}','\lambda_{SSGLM}'});
scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
subplot(2,2,1); t.KSPlot;
subplot(2,2,2); t.plotResidual;
subplot(2,2,3); t.plotInvGausTrans;
subplot(2,2,4); t.plotSeqCorr;

S=FitResSummary(t);
dAIC=diff(S.AIC)

dAIC =

  -1.7978e+04

dBIC=diff(S.BIC)

dBIC =

  -6.9523e+03

dKS =diff(S.KSStats); 
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_10.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;
<span class="comment">% Generate the actual stimulus effect</span>
minTime=0; maxTime = Tmax;
stimData = stim.data*b1;
<span class="keyword">if</span>(strcmp(fitType,<span class="string">'poisson'</span>))
    actStimEffect=exp(stimData + b0)./delta;
<span class="keyword">elseif</span>(strcmp(fitType,<span class="string">'binomial'</span>))
    actStimEffect=exp(stimData + b0)./(1+exp(stimData + b0))./delta;
<span class="keyword">end</span>
<span class="comment">%</span>

<span class="comment">% Generate the basis function so that the estimated effect can be plotted</span>
<span class="comment">% at the same temporal resolution as the theoretical effect</span>
 <span class="keyword">if</span>(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,minTime,<span class="keyword">...</span>
        maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 <span class="keyword">end</span>

<span class="comment">% Generate the estimated stimulus effect</span>
<span class="keyword">if</span>(strcmp(fitType,<span class="string">'poisson'</span>))
    estStimEffect=exp(basisMat*xK)./delta;
<span class="keyword">elseif</span>(strcmp(fitType,<span class="string">'binomial'</span>))
    estStimEffect=exp(basisMat*xK)./(1+exp(basisMat*xK))./delta;
<span class="keyword">end</span>


scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

<span class="comment">% Plot the actual and estimated stimulus effect as a function of trial and</span>
<span class="comment">% time</span>
subplot(3,1,[1 2 3]);
lighting <span class="string">gouraud</span>
surf((1:length(b1))',stim.time,actStimEffect,<span class="string">'FaceAlpha'</span>,0.1,<span class="keyword">...</span>
    <span class="string">'EdgeAlpha'</span>,0.1,<span class="string">'AlphaData'</span>,0.1);
hx=xlabel(<span class="string">'Trial [k]'</span>); hy=ylabel(<span class="string">'time [s]'</span>);
hz=zlabel(<span class="string">'Stimulus Effect [spikes/sec]'</span>); hold <span class="string">all</span>;
set([hx hy hz],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

surf((1:length(b1))',stim.time,estStimEffect(:,1:length(b1)),<span class="keyword">...</span>
    <span class="string">'FaceAlpha'</span>,0.5,<span class="string">'EdgeAlpha'</span>,0.1,<span class="string">'AlphaData'</span>,0.5); <span class="comment">%xlabel('Trial [k]'); ylabel('time [s]'); zlabel('Stimulus Effect');</span>
set(gca,<span class="string">'YDir'</span>,<span class="string">'reverse'</span>);
set(gca,<span class="string">'ytick'</span>,0:.1:Tmax,<span class="string">'ytickLabel'</span>,0:.1:Tmax);

title(<span class="string">'SSGLM Estimated vs. Actual Stimulus Effect'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

close <span class="string">all</span>;
h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

<span class="comment">% The actual stimulus effect</span>
subplot(3,1,1);
lighting <span class="string">gouraud</span>
mesh((1:length(b1))',stim.time,actStimEffect);
hx=xlabel(<span class="string">'Trial [k]'</span>); hy=ylabel(<span class="string">'time [s]'</span>);
zlabel(<span class="string">'Stimulus Effect [spikes/sec]'</span>); hold <span class="string">all</span>;
set([hx hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
<span class="comment">% title('True Stimulus Effect');</span>
title(<span class="string">'True Stimulus Effect'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
set(gca,<span class="string">'ytick'</span>,[],<span class="string">'ytickLabel'</span>,[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);



<span class="comment">% The PSTH estimate</span>
subplot(3,1,2);
lighting <span class="string">gouraud</span>
mesh((1:length(b1))',stim.time,repmat(psthSig.data, [1 numRealizations]));
hx=xlabel(<span class="string">'Trial [k]'</span>); hy=ylabel(<span class="string">'time [s]'</span>);
hz=zlabel(<span class="string">'Stimulus Effect [spikes/sec]'</span>); hold <span class="string">all</span>;
set([hx hy hz],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
<span class="comment">% title('PSTH Estimated Stimulus Effect');</span>
title(<span class="string">'PSTH Estimated Stimulus Effect'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
set(gca,<span class="string">'ytick'</span>,[],<span class="string">'ytickLabel'</span>,[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);

<span class="comment">% The SSGLM estimated stimulus effect</span>
subplot(3,1,3);
lighting <span class="string">gouraud</span>
mesh((1:length(b1))',stim.time,estStimEffect);
xlabel(<span class="string">'Trial [k]'</span>); ylabel(<span class="string">'time [s]'</span>);
zlabel(<span class="string">'Stimulus Effect [spikes/sec]'</span>); hold <span class="string">all</span>;
hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>); hz=get(gca,<span class="string">'ZLabel'</span>);
set([hx hy hz],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

<span class="comment">% title('SSGLM Estimated Stimulus Efferct');</span>
title(<span class="string">'SSGLM Estimated Stimulus Effect'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
set(gca,<span class="string">'ytick'</span>,[],<span class="string">'ytickLabel'</span>,[]);
set(gca, <span class="string">'YDir'</span>,<span class="string">'normal'</span>)
view(gca,[90 -90]);
</pre><pre class="codeoutput">

%%
close all;
% Generate the actual stimulus effect
minTime=0; maxTime = Tmax;
stimData = stim.data*b1;
if(strcmp(fitType,'poisson'))
elseif(strcmp(fitType,'binomial'))
    actStimEffect=exp(stimData + b0)./(1+exp(stimData + b0))./delta;
end
%     

% Generate the basis function so that the estimated effect can be plotted
% at the same temporal resolution as the theoretical effect
 if(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,minTime,...
        maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 end

% Generate the estimated stimulus effect
if(strcmp(fitType,'poisson'))
elseif(strcmp(fitType,'binomial'))
    estStimEffect=exp(basisMat*xK)./(1+exp(basisMat*xK))./delta;
end


scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

% Plot the actual and estimated stimulus effect as a function of trial and
% time
subplot(3,1,[1 2 3]);
lighting gouraud
surf((1:length(b1))',stim.time,actStimEffect,'FaceAlpha',0.1,...
    'EdgeAlpha',0.1,'AlphaData',0.1); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
hz=zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

surf((1:length(b1))',stim.time,estStimEffect(:,1:length(b1)),...
    'FaceAlpha',0.5,'EdgeAlpha',0.1,'AlphaData',0.5); %xlabel('Trial [k]'); ylabel('time [s]'); zlabel('Stimulus Effect');
set(gca,'YDir','reverse');
set(gca,'ytick',0:.1:Tmax,'ytickLabel',0:.1:Tmax);

title('SSGLM Estimated vs. Actual Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');

close all;
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

% The actual stimulus effect
subplot(3,1,1);
lighting gouraud
mesh((1:length(b1))',stim.time,actStimEffect); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
% title('True Stimulus Effect');
title('True Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');
set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);



% The PSTH estimate
subplot(3,1,2);
lighting gouraud
mesh((1:length(b1))',stim.time,repmat(psthSig.data, [1 numRealizations])); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
hz=zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
% title('PSTH Estimated Stimulus Effect');
title('PSTH Estimated Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');

set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);

% The SSGLM estimated stimulus effect
subplot(3,1,3);
lighting gouraud
mesh((1:length(b1))',stim.time,estStimEffect); 
xlabel('Trial [k]'); ylabel('time [s]'); 
zlabel('Stimulus Effect [spikes/sec]'); hold all;
hx=get(gca,'XLabel');  hy=get(gca,'YLabel'); hz=get(gca,'ZLabel');
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
           
% title('SSGLM Estimated Stimulus Efferct');
title('SSGLM Estimated Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');
set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
set(gca, 'YDir','normal')
view(gca,[90 -90]);
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_11.png" alt=""> <h2 id="23">Compare differences across trials</h2><pre class="codeinput">close <span class="string">all</span>;
   minTime=0; maxTime = Tmax;
<span class="comment">% Generate the basis function so that the estimated effect can be plotted</span>
<span class="comment">% at the same temporal resolution as the theoretical effect</span>
 <span class="keyword">if</span>(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,<span class="keyword">...</span>
        minTime,maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 <span class="keyword">end</span>


<span class="comment">% close all;</span>

t0=0; tf=Tmax;
[spikeRateBinom, ProbMat,sigMat]=DecodingAlgorithms.computeSpikeRateCIs(xK,<span class="keyword">...</span>
    WkuFinal,dN,t0,tf,fitType,delta,gammahat,windowTimes);

lt=find(sigMat(1,:)==1,1,<span class="string">'first'</span>);
display([<span class="string">'The learning trial (compared to the first trial) is trial #'</span> <span class="keyword">...</span>
    num2str(find(sigMat(1,:)==1,1,<span class="string">'first'</span>))]);
scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(2,3,1);
spikeRateBinom.setName([<span class="string">'('</span> num2str(Tmax) <span class="string">'-0)^-1*\Lambda(0,'</span> <span class="keyword">...</span>
    num2str(Tmax) <span class="string">')'</span>]);
spikeRateBinom.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}});
<span class="comment">% e = Events(lt,{''});</span>
<span class="comment">% e.plot;</span>
v=axis;
plot(lt*[1;1],v(3:4),<span class="string">'r'</span>,<span class="string">'Linewidth'</span>,2);
hx=xlabel(<span class="string">'Trial [k]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>); hold <span class="string">all</span>;
hy=ylabel(<span class="string">'Average Firing Rate [spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title([<span class="string">'Learning Trial:'</span> num2str(lt)],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);



h=subplot(2,3,[2 3 5 6]);
K=size(dN,1);
colormap(flipud(gray));
imagesc(ProbMat); hold <span class="string">on</span>;
<span class="keyword">for</span> k=1:K
    <span class="keyword">for</span> m=(k+1):K
        <span class="keyword">if</span>(sigMat(k,m)==1)
            plot3(m,k,1,<span class="string">'r*'</span>); hold <span class="string">on</span>;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%</span>
set(h,<span class="string">'XAxisLocation'</span>,<span class="string">'top'</span>,<span class="string">'YAxisLocation'</span>,<span class="string">'right'</span>);
hx=xlabel(<span class="string">'Trial Number'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>); hold <span class="string">all</span>;
hy=ylabel(<span class="string">'Trial Number'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

subplot(2,3,4)
stim1 = Covariate(time, basisMat*stimulus(:,1),<span class="string">'Trial1'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="keyword">...</span>
    <span class="string">'spikes/sec'</span>);
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,1,:)));
stim1.setConfInterval(temp);
stimlt = Covariate(time, basisMat*stimulus(:,lt),<span class="string">'Trial1'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="keyword">...</span>
    <span class="string">'spikes/sec'</span>);
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt,:)));
temp.setColor(<span class="string">'r'</span>);
stimlt.setConfInterval(temp);
stimltm1 = Covariate(time, basisMat*stimulus(:,lt-1),<span class="string">'Trial1'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="keyword">...</span>
    <span class="string">'spikes/sec'</span>);
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt-1,:)));
temp.setColor(<span class="string">'r'</span>);
stimltm1.setConfInterval(temp);

<span class="comment">% figure;</span>
h1=stim1.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}}); hold <span class="string">all</span>;
h2=stimlt.plot([],{{<span class="string">' ''r'',''Linewidth'',4'</span>}});
hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>); hold <span class="string">all</span>;
hy=ylabel(<span class="string">'Firing Rate [spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

title({<span class="string">'Learning Trial Vs. Baseline Trial'</span>;<span class="string">'with 95% CIs'</span>},<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
            <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
h_legend=legend([h1(1) h2(1)],<span class="string">'\lambda_{1}(t)'</span>,[<span class="string">'\lambda_{'</span> num2str(lt) <span class="string">'}(t)'</span>]);
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.03 pos(2)+.01 pos(3:4)]);
</pre><pre class="codeoutput">


%% Compare differences across trials 
close all;
   minTime=0; maxTime = Tmax;
% Generate the basis function so that the estimated effect can be plotted
% at the same temporal resolution as the theoretical effect
 if(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,...
        minTime,maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 end


% close all;

t0=0; tf=Tmax;
[spikeRateBinom, ProbMat,sigMat]=DecodingAlgorithms.computeSpikeRateCIs(xK,...
    WkuFinal,dN,t0,tf,fitType,delta,gammahat,windowTimes);

lt=find(sigMat(1,:)==1,1,'first');
display(['The learning trial (compared to the first trial) is trial #' ...
    num2str(find(sigMat(1,:)==1,1,'first'))]);
The learning trial (compared to the first trial) is trial #12
scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(2,3,1);
spikeRateBinom.setName(['(' num2str(Tmax) '-0)^-1*\Lambda(0,' ...
    num2str(Tmax) ')']);
spikeRateBinom.plot([],{{' ''k'',''Linewidth'',4'}});
% e = Events(lt,{''});
% e.plot;
v=axis;
plot(lt*[1;1],v(3:4),'r','Linewidth',2);
hx=xlabel('Trial [k]','Interpreter','none'); hold all;
hy=ylabel('Average Firing Rate [spikes/sec]','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title(['Learning Trial:' num2str(lt)],'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
        


h=subplot(2,3,[2 3 5 6]);
K=size(dN,1);
colormap(flipud(gray));
imagesc(ProbMat); hold on;
for k=1:K
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
        if(sigMat(k,m)==1)
    end
end
    for m=(k+1):K
end
%
set(h,'XAxisLocation','top','YAxisLocation','right');
hx=xlabel('Trial Number','Interpreter','none'); hold all;
hy=ylabel('Trial Number','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

subplot(2,3,4)
stim1 = Covariate(time, basisMat*stimulus(:,1),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,1,:)));
stim1.setConfInterval(temp);
stimlt = Covariate(time, basisMat*stimulus(:,lt),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt,:)));
temp.setColor('r');
stimlt.setConfInterval(temp);
stimltm1 = Covariate(time, basisMat*stimulus(:,lt-1),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt-1,:)));
temp.setColor('r');
stimltm1.setConfInterval(temp);

% figure;
h1=stim1.plot([],{{' ''k'',''Linewidth'',4'}}); hold all;
h2=stimlt.plot([],{{' ''r'',''Linewidth'',4'}});
hx=xlabel('time [s]','Interpreter','none'); hold all;
hy=ylabel('Firing Rate [spikes/sec]','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

title({'Learning Trial Vs. Baseline Trial';'with 95% CIs'},'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
h_legend=legend([h1(1) h2(1)],'\lambda_{1}(t)',['\lambda_{' num2str(lt) '}(t)']);
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.03 pos(2)+.01 pos(3:4)]);
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_12.png" alt=""> <h2 id="24">Example 4 - HIPPOCAMPAL PLACE CELL - RECEPTIVE FIELD ESTIMATION</h2><p>Estimation of receptive fields of neurons is a very common data analysis problem in neuroscience. Here we use the nSTAT software to perform an estimation of the receptive fields of hippocampal place cells using a bivariate Gaussian model and Zernike polynomials. The number of zernike polynomials is based on "An Analysis of Hippocampal Spatio-Temporal Representations Using a Bayesian Algorithm for Neural Spike Train Decoding" Barbieri et. al 2005. The data used herein in was provided by Dr. Ricardo Barbieri on 2/28/2011.</p><p><b>Author</b>: Iahn Cajigas</p><p><b>Date</b>: 3/1/2011</p><h2 id="26">Example Data</h2><p>The x and y coordinates of a freely foraging rat in a circular environment (70cm in diameter and 30cm high walls) and a fixed visual cue. The x and y coordinates at the time when a spike was observed are marked in red. The position coordinates have been normalized to be between -1 and 1 to allow to simplify the analysis.</p><pre class="codeinput">    close <span class="string">all</span>;
    load(strcat(<span class="string">'PlaceCellDataAnimal1.mat'</span>));
    exampleCell = [2 21 25 49];
<span class="comment">%     exampleCell = 1:length(neuron);</span>
<span class="comment">%     figure(1);</span>
    scrsz = get(0,<span class="string">'ScreenSize'</span>);
    h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.9]);

    <span class="keyword">for</span> i=1:length(exampleCell)
        subplot(2,2,i);
        h1=plot(x,y,<span class="string">'b'</span>,<span class="string">'Linewidth'</span>,.5); hold <span class="string">on</span>;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,<span class="string">'r.'</span>,<span class="keyword">...</span>
            <span class="string">'MarkerSize'</span>,7);
        hx=xlabel(<span class="string">'X Position'</span>); hy=ylabel(<span class="string">'Y Position'</span>);
<span class="comment">%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);</span>
        title([<span class="string">'Cell#'</span> num2str(exampleCell(i))],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
            <span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
        set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
        set(gca,<span class="string">'xTick'</span>,-1:.5:1,<span class="string">'yTick'</span>,-1:.5:1); axis <span class="string">square</span>;
        <span class="keyword">if</span>(i==4)
            h_legend = legend([h1 h2],<span class="string">'Animal Path'</span>,<span class="keyword">...</span>
                <span class="string">'Location at time of spike'</span>);
            pos = get(h_legend,<span class="string">'position'</span>);
            set(h_legend, <span class="string">'position'</span>,[pos(1)+.09 pos(2)+.06 pos(3:4)]);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
</pre><pre class="codeoutput">
%% Example 4 - HIPPOCAMPAL PLACE CELL - RECEPTIVE FIELD ESTIMATION 
% Estimation of receptive fields of neurons is a very common data analysis problem in neuroscience.
% Here we use the nSTAT software to perform an estimation of the receptive fields of hippocampal
% place cells using a bivariate Gaussian model and Zernike polynomials. The number of zernike polynomials 
% is based on "An Analysis of Hippocampal Spatio-Temporal Representations Using a Bayesian Algorithm for Neural
% Spike Train Decoding" Barbieri et. al 2005. The data used herein in was
% provided by Dr. Ricardo Barbieri on 2/28/2011.
%
% *Author*: Iahn Cajigas 
%
% *Date*: 3/1/2011
%%

    
%% Example Data
% The x and y coordinates of a freely foraging rat in a circular environment (70cm in diameter and 30cm high walls) and a fixed visual cue. 
% The x and y coordinates at the time when a spike was observed are marked
% in red. The position coordinates have been normalized to be between -1
% and 1 to allow to simplify the analysis. 
    close all;
    load(strcat('PlaceCellDataAnimal1.mat'));    
    exampleCell = [2 21 25 49];
%     exampleCell = 1:length(neuron);
%     figure(1);
    scrsz = get(0,'ScreenSize');
    h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.9]);

    for i=1:length(exampleCell)
        subplot(2,2,i);
        h1=plot(x,y,'b','Linewidth',.5); hold on;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,'r.',...
            'MarkerSize',7);
        hx=xlabel('X Position'); hy=ylabel('Y Position'); 
%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);
        title(['Cell#' num2str(exampleCell(i))],'FontWeight','bold',...
            'Fontsize',12,'FontName','Arial');
        set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        set(gca,'xTick',-1:.5:1,'yTick',-1:.5:1); axis square;
        if(i==4)
    end
        subplot(2,2,i);
        h1=plot(x,y,'b','Linewidth',.5); hold on;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,'r.',...
            'MarkerSize',7);
        hx=xlabel('X Position'); hy=ylabel('Y Position'); 
%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);
        title(['Cell#' num2str(exampleCell(i))],'FontWeight','bold',...
            'Fontsize',12,'FontName','Arial');
        set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        set(gca,'xTick',-1:.5:1,'yTick',-1:.5:1); axis square;
        if(i==4)
    end
        subplot(2,2,i);
        h1=plot(x,y,'b','Linewidth',.5); hold on;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,'r.',...
            'MarkerSize',7);
        hx=xlabel('X Position'); hy=ylabel('Y Position'); 
%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);
        title(['Cell#' num2str(exampleCell(i))],'FontWeight','bold',...
            'Fontsize',12,'FontName','Arial');
        set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        set(gca,'xTick',-1:.5:1,'yTick',-1:.5:1); axis square;
        if(i==4)
    end
        subplot(2,2,i);
        h1=plot(x,y,'b','Linewidth',.5); hold on;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,'r.',...
            'MarkerSize',7);
        hx=xlabel('X Position'); hy=ylabel('Y Position'); 
%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);
        title(['Cell#' num2str(exampleCell(i))],'FontWeight','bold',...
            'Fontsize',12,'FontName','Arial');
        set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        set(gca,'xTick',-1:.5:1,'yTick',-1:.5:1); axis square;
        if(i==4)
            h_legend = legend([h1 h2],'Animal Path',...
                'Location at time of spike');
            pos = get(h_legend,'position');
            set(h_legend, 'position',[pos(1)+.09 pos(2)+.06 pos(3:4)]);
        end
    end
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_13.png" alt=""> <h2 id="27">Analyze All Cells</h2><pre class="codeinput">numAnimals=2;
CompilingHelpFile=1;
<span class="keyword">if</span>(~CompilingHelpFile)
    <span class="keyword">for</span> n=1:numAnimals
        <span class="comment">% load the data</span>
        clear <span class="string">x</span> <span class="string">y</span> <span class="string">neuron</span> <span class="string">time</span> <span class="string">nst</span> <span class="string">tc</span> <span class="string">tcc</span> <span class="string">z</span>;
        load(strcat(<span class="string">'PlaceCellDataAnimal'</span>,num2str(n),<span class="string">'.mat'</span>));

        <span class="comment">% Create the spikeTrains for each cell</span>
        <span class="keyword">for</span> i=1:length(neuron)
            nst{i} = nspikeTrain(neuron{i}.spikeTimes);
        <span class="keyword">end</span>


        <span class="comment">% Convert to polar coordinates</span>
        [theta,r] = cart2pol(x,y);


        <span class="comment">% Evaluate the Zernike Polynomials</span>
        <span class="comment">% Number of polynomials from "An Analysis of Hippocampal</span>
        <span class="comment">% Spatio-Temporal Representations Using a Bayesian Algorithm for Neural</span>
        <span class="comment">% Spike Train Decoding" Barbieri et. al 2005</span>
        cnt=0;
        <span class="keyword">for</span> l=0:3
           <span class="keyword">for</span> m=-l:l
               <span class="keyword">if</span>(~any(mod(l-m,2))) <span class="comment">% otherwise the polynomial = 0</span>
                cnt = cnt+1;
                z(:,cnt) = zernfun(l,m,r,theta,<span class="string">'norm'</span>);
                <span class="comment">% zernfun by Paul Fricker</span>
                <span class="comment">% http://www.mathworks.com/matlabcentral/fileexchange/7687</span>
               <span class="keyword">end</span>
           <span class="keyword">end</span>
        <span class="keyword">end</span>

        <span class="comment">% Data sampled at 30 Hz but just to be sure</span>
        delta=min(diff(time));
        sampleRate = round(1/delta);
        <span class="comment">% Define Covariates for the analysis</span>
        baseline = Covariate(time,ones(length(x),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,<span class="keyword">...</span>
                            {<span class="string">'mu'</span>});
        zernike  = Covariate(time,z,<span class="string">'Zernike'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'m'</span>,{<span class="string">'z1'</span>,<span class="string">'z2'</span>,<span class="string">'z3'</span>,<span class="keyword">...</span>
                            <span class="string">'z4'</span>,<span class="string">'z5'</span>,<span class="string">'z6'</span>,<span class="string">'z7'</span>,<span class="string">'z8'</span>,<span class="string">'z9'</span>,<span class="string">'z10'</span>});
        gaussian = Covariate(time,[x y x.^2 y.^2 x.*y],<span class="string">'Gaussian'</span>,<span class="string">'time'</span>,<span class="keyword">...</span>
                            <span class="string">'s'</span>,<span class="string">'m'</span>,{<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'x^2'</span>,<span class="string">'y^2'</span>,<span class="string">'x*y'</span>});
        covarColl = CovColl({baseline,gaussian,zernike});

        <span class="comment">% Create the trial structure</span>
        spikeColl = nstColl(nst);
        trial     = Trial(spikeColl,covarColl);


        <span class="comment">% Define how we want to analyze the data</span>
        tc{1} = TrialConfig({{<span class="string">'Baseline'</span>,<span class="string">'mu'</span>},{<span class="string">'Gaussian'</span>,<span class="keyword">...</span>
                            <span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'x^2'</span>,<span class="string">'y^2'</span>,<span class="string">'x*y'</span>}},sampleRate,[]);
        tc{1}.setName(<span class="string">'Gaussian'</span>);
        tc{2} = TrialConfig({{<span class="string">'Zernike'</span> <span class="string">'z1'</span>,<span class="string">'z2'</span>,<span class="string">'z3'</span>,<span class="string">'z4'</span>,<span class="string">'z5'</span>,<span class="string">'z6'</span>,<span class="keyword">...</span>
                            <span class="string">'z7'</span>,<span class="string">'z8'</span>,<span class="string">'z9'</span>,<span class="string">'z10'</span>}},sampleRate,[]);
        tc{2}.setName(<span class="string">'Zernike'</span>);
        tcc = ConfigColl(tc);

        <span class="comment">% Perform Analysis (Commented to since data already saved)</span>
         results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);

        <span class="comment">% Save results</span>
            resStruct =FitResult.CellArrayToStructure(results);
            filename = [<span class="string">'PlaceCellAnimal'</span> num2str(n) <span class="string">'Results'</span>];
            save(filename,<span class="string">'resStruct'</span>);
    <span class="keyword">end</span>
<span class="keyword">end</span>
</pre><pre class="codeoutput">    

 %% Analyze All Cells 
numAnimals=2;
CompilingHelpFile=1;
if(~CompilingHelpFile)
</pre><h2 id="28">View Summary Statistics</h2><p>Note the Zernike Polynomials yield better fits in terms of decreased KS Statistics (less deviation from the 45 degree line), reduced AIC and reduced BIC across the majority of cells and for both animals</p><pre class="codeinput">clear <span class="string">Summary</span>;
numAnimals =2;

<span class="keyword">for</span> n=1:numAnimals
    resData=load(strcat(<span class="string">'PlaceCellAnimal'</span>,num2str(n),<span class="string">'Results.mat'</span>));
    results = FitResult.fromStructure(resData.resStruct);
    Summary{n} = FitResSummary(results);
<span class="comment">%     Summary{n}.plotSummary;</span>
<span class="keyword">end</span>
</pre><pre class="codeoutput">%% View Summary Statistics
% Note the Zernike Polynomials yield better fits in terms of decreased KS
% Statistics (less deviation from the 45 degree line), reduced AIC and
% reduced BIC across the majority of cells and for both animals
clear Summary;
numAnimals =2;
 
for n=1:numAnimals
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    Summary{n} = FitResSummary(results);
%     Summary{n}.plotSummary;
end    
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    Summary{n} = FitResSummary(results);
%     Summary{n}.plotSummary;
end    
</pre><pre class="codeinput">close <span class="string">all</span>;
scrsz = get(0,<span class="string">'ScreenSize'</span>);
h=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.5]);
subplot(1,3,1);
maxLength = max([Summary{1}.numNeurons,Summary{2}.numNeurons]);
dKS = nan(maxLength, 2);
dKS(1:Summary{1}.numNeurons,1) = (Summary{1}.KSStats(:,1)-Summary{1}.KSStats(:,2)) ;
dKS(1:Summary{2}.numNeurons,2) = (Summary{2}.KSStats(:,1)-Summary{2}.KSStats(:,2)) ;

boxplot(dKS ,{<span class="string">'Animal 1'</span>, <span class="string">'Animal 2'</span>},<span class="string">'labelorientation'</span>,<span class="string">'inline'</span>);
title(<span class="string">'\Delta KS Statistic'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="keyword">...</span>
    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);


subplot(1,3,2);
dAIC = nan(maxLength, 2);
dAIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffAIC(1);
dAIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffAIC(1);

boxplot(dAIC ,{<span class="string">'Animal 1'</span>, <span class="string">'Animal 2'</span>},<span class="string">'labelorientation'</span>,<span class="string">'inline'</span>);
title(<span class="string">'\Delta AIC'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);


subplot(1,3,3);
dBIC = nan(maxLength, 2);
dBIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffBIC(1);
dBIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffBIC(1);

boxplot(dBIC ,{<span class="string">'Animal 1'</span>, <span class="string">'Animal 2'</span>},<span class="string">'labelorientation'</span>,<span class="string">'inline'</span>); <span class="comment">%ylabel('\Delta BIC'); %xticklabel_rotate([],45,[],'Fontsize',6);</span>
title(<span class="string">'\Delta BIC'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

<span class="comment">%  close all;</span>
</pre><pre class="codeoutput">%%
close all;
scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.5]);
subplot(1,3,1);
maxLength = max([Summary{1}.numNeurons,Summary{2}.numNeurons]);
dKS = nan(maxLength, 2);
dKS(1:Summary{1}.numNeurons,1) = (Summary{1}.KSStats(:,1)-Summary{1}.KSStats(:,2)) ;
dKS(1:Summary{2}.numNeurons,2) = (Summary{2}.KSStats(:,1)-Summary{2}.KSStats(:,2)) ;

boxplot(dKS ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); 
title('\Delta KS Statistic','FontWeight','bold','FontSize',14,...
    'FontName','Arial');
                  

subplot(1,3,2);
dAIC = nan(maxLength, 2);
dAIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffAIC(1);
dAIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffAIC(1);

boxplot(dAIC ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); 
title('\Delta AIC','FontWeight','bold','FontSize',14,'FontName','Arial');
                  

subplot(1,3,3); 
dBIC = nan(maxLength, 2);
dBIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffBIC(1);
dBIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffBIC(1);

boxplot(dBIC ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); %ylabel('\Delta BIC'); %xticklabel_rotate([],45,[],'Fontsize',6);
title('\Delta BIC','FontWeight','bold','FontSize',14,'FontName','Arial');
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_14.png" alt=""> <h2 id="30">Visualize the results</h2><pre class="codeinput">close <span class="string">all</span>;
<span class="comment">% Define a grid</span>
[x_new,y_new]=meshgrid(-1:.01:1); <span class="comment">%define new x and y</span>
y_new = flipud(y_new); x_new = fliplr(x_new);
[theta_new,r_new] = cart2pol(x_new,y_new);

<span class="comment">%Data for the gaussian fit</span>
newData{1} =ones(size(x_new));
newData{2} =x_new; newData{3} =y_new;
newData{4} =x_new.^2; newData{5} =y_new.^2;
newData{6} =x_new.*y_new;


<span class="comment">% Zernike polynomials only defined on the unit disk</span>
idx = r_new&lt;=1;
zpoly = cell(1,10);
cnt=0;
<span class="keyword">for</span> l=0:3
   <span class="keyword">for</span> m=-l:l
       <span class="keyword">if</span>(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),<span class="string">'norm'</span>);
        zpoly{cnt} = temp;
       <span class="keyword">end</span>
   <span class="keyword">end</span>
<span class="keyword">end</span>



<span class="keyword">for</span> n=1:numAnimals

    clear <span class="string">lambdaGaussian</span> <span class="string">lambdaZernike</span>;
    load(strcat(<span class="string">'PlaceCellDataAnimal'</span>,num2str(n),<span class="string">'.mat'</span>));
    resData=load(strcat(<span class="string">'PlaceCellAnimal'</span>,num2str(n),<span class="string">'Results.mat'</span>));
    results = FitResult.fromStructure(resData.resStruct);

    <span class="keyword">for</span> i=1:length(neuron)
        <span class="comment">% Evaluate our fits using the new data and the estimated parameters</span>
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    <span class="keyword">end</span>




    <span class="comment">% Plot the receptive fields</span>
    <span class="keyword">for</span> i=1:length(neuron)
        <span class="comment">% 3d plot of an example place field</span>


        <span class="comment">% 2d plot of all the cell's fields</span>
        <span class="keyword">if</span>(n==1)
            h4=figure(4);
            colormap(<span class="string">'jet'</span>);
            <span class="keyword">if</span>(i==1)
                tb=annotation(h4,<span class="string">'textbox'</span>,<span class="keyword">...</span>
                    [0.283261904761904 0.928571428571418 <span class="keyword">...</span>
                    0.392857142857143 0.0595238095238095],<span class="keyword">...</span>
                    <span class="string">'String'</span>,{[<span class="string">'Gaussian Place Fields - Animal#'</span> <span class="keyword">...</span>
                    num2str(n)]},<span class="string">'FitBoxToText'</span>,<span class="string">'on'</span>,<span class="string">'Fontsize'</span>,11,<span class="keyword">...</span>
                    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'LineStyle'</span>,<span class="keyword">...</span>
                    <span class="string">'none'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>); hold <span class="string">on</span>;
            <span class="keyword">end</span>
            subplot(7,7,i);
        <span class="keyword">elseif</span>(n==2)
            h6=figure(6);
            colormap(<span class="string">'jet'</span>);
            <span class="keyword">if</span>(i==1)
                annotation(h6,<span class="string">'textbox'</span>,<span class="keyword">...</span>
                    [0.283261904761904 0.928571428571418 <span class="keyword">...</span>
                    0.392857142857143 0.0595238095238095],<span class="keyword">...</span>
                    <span class="string">'String'</span>,{[<span class="string">'Gaussian Place Fields - Animal#'</span> <span class="keyword">...</span>
                    num2str(n)]},<span class="string">'FitBoxToText'</span>,<span class="string">'on'</span>,<span class="string">'Fontsize'</span>,11,<span class="keyword">...</span>
                    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'LineStyle'</span>,<span class="keyword">...</span>
                    <span class="string">'none'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>); hold <span class="string">on</span>;
            <span class="keyword">end</span>
            subplot(6,7,i);
        <span class="keyword">end</span>
        pcolor(x_new,y_new,lambdaGaussian{i}), shading <span class="string">interp</span>
        axis <span class="string">square</span>; set(gca,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[]);
        set(gca, <span class="string">'Box'</span>         , <span class="string">'off'</span>);

        <span class="keyword">if</span>(n==1)
            h5=figure(5);
            colormap(<span class="string">'jet'</span>);
            <span class="keyword">if</span>(i==1)
                annotation(h5,<span class="string">'textbox'</span>,<span class="keyword">...</span>
                    [0.303261904761904 0.928571428571418 <span class="keyword">...</span>
                    0.392857142857143 0.0595238095238095],<span class="keyword">...</span>
                    <span class="string">'String'</span>,{[<span class="string">'Zernike Place Fields - Animal#'</span> <span class="keyword">...</span>
                    num2str(n)]},<span class="string">'FitBoxToText'</span>,<span class="string">'on'</span>,<span class="string">'Fontsize'</span>,11,<span class="keyword">...</span>
                    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'LineStyle'</span>,<span class="string">'none'</span>); hold <span class="string">on</span>;

            <span class="keyword">end</span>
            subplot(7,7,i);
        <span class="keyword">elseif</span>(n==2)
            h7=figure(7);
            colormap(<span class="string">'jet'</span>);
            <span class="keyword">if</span>(i==1)
               annotation(h7,<span class="string">'textbox'</span>,<span class="keyword">...</span>
                    [0.303261904761904 0.928571428571418 <span class="keyword">...</span>
                    0.392857142857143 0.0595238095238095],<span class="keyword">...</span>
                    <span class="string">'String'</span>,{[<span class="string">'Zernike Place Fields - Animal#'</span> <span class="keyword">...</span>
                    num2str(n)]},<span class="string">'FitBoxToText'</span>,<span class="string">'on'</span>,<span class="string">'Fontsize'</span>,11,<span class="keyword">...</span>
                    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'LineStyle'</span>,<span class="keyword">...</span>
                    <span class="string">'none'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>); hold <span class="string">on</span>;
            <span class="keyword">end</span>
            subplot(6,7,i);
        <span class="keyword">end</span>
        pcolor(x_new,y_new,lambdaZernike{i}), shading <span class="string">interp</span>
        axis <span class="string">square</span>;
        set(gca,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[]);
        set(gca, <span class="string">'Box'</span>         , <span class="string">'off'</span>);
    <span class="keyword">end</span>


<span class="keyword">end</span>
</pre><pre class="codeoutput">
%  close all;
    

%% Visualize the results 
close all;
% Define a grid 
[x_new,y_new]=meshgrid(-1:.01:1); %define new x and y
y_new = flipud(y_new); x_new = fliplr(x_new);
[theta_new,r_new] = cart2pol(x_new,y_new);

%Data for the gaussian fit 
newData{1} =ones(size(x_new));
newData{2} =x_new; newData{3} =y_new;
newData{4} =x_new.^2; newData{5} =y_new.^2;
newData{6} =x_new.*y_new;


% Zernike polynomials only defined on the unit disk
idx = r_new&lt;=1;
zpoly = cell(1,10);
cnt=0;
for l=0:3
   for m=-l:l 
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
end
   for m=-l:l 
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
end
   for m=-l:l 
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
end
   for m=-l:l 
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
       if(~any(mod(l-m,2)))
   end
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
end



for n=1:numAnimals 
    
    clear lambdaGaussian lambdaZernike;
    load(strcat('PlaceCellDataAnimal',num2str(n),'.mat'));
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    
    for i=1:length(neuron)
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end

   
    
    
    % Plot the receptive fields
    for i=1:length(neuron)
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
                tb=annotation(h4,'textbox',...
                    [0.283261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Gaussian Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
                annotation(h5,'textbox',...
                    [0.303261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Zernike Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle','none'); hold on;
                
            end
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
            subplot(7,7,i); 
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end

  
end
    
    clear lambdaGaussian lambdaZernike;
    load(strcat('PlaceCellDataAnimal',num2str(n),'.mat'));
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    
    for i=1:length(neuron)
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end

   
    
    
    % Plot the receptive fields
    for i=1:length(neuron)
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
                annotation(h6,'textbox',...
                    [0.283261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Gaussian Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
               annotation(h7,'textbox',...
                    [0.303261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Zernike Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end

  
end
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_15.png" alt=""> <img vspace="5" hspace="5" src="nSTATPaperExamples_16.png" alt=""> <img vspace="5" hspace="5" src="nSTATPaperExamples_17.png" alt=""> <img vspace="5" hspace="5" src="nSTATPaperExamples_18.png" alt=""> <pre class="codeinput">    clear <span class="string">lambdaGaussian</span> <span class="string">lambdaZernike</span>;
    load(strcat(<span class="string">'PlaceCellDataAnimal1.mat'</span>));
    resData=load(strcat(<span class="string">'PlaceCellAnimal1Results.mat'</span>));
    results = FitResult.fromStructure(resData.resStruct);

    <span class="keyword">for</span> i=1:length(neuron)
        <span class="comment">% Evaluate our fits using the new data and the estimated parameters</span>
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    <span class="keyword">end</span>



<span class="comment">%     h1=plot(x,y,'b');</span>
<span class="comment">%     h2=plot(x,y,'g');</span>
    <span class="comment">%</span>
    exampleCell = 25;
<span class="comment">%     figure(8);</span>
<span class="comment">%     plot(x,y,'b',neuron{exampleCell}.xN,neuron{exampleCell}.yN,'r.');</span>
<span class="comment">%     xlabel('x'); ylabel('y');</span>
<span class="comment">%     title(['Animal#1, Cell#' num2str(exampleCell)]);</span>
<span class="comment">%</span>
    close <span class="string">all</span>;
    h9=figure(9);
    h_mesh = mesh(x_new,y_new,lambdaGaussian{exampleCell},<span class="string">'AlphaData'</span>,0);
    get(h_mesh,<span class="string">'AlphaData'</span>);
    set(h_mesh,<span class="string">'FaceAlpha'</span>,0.2,<span class="string">'EdgeAlpha'</span>,0.2,<span class="string">'EdgeColor'</span>,<span class="string">'b'</span>);
    hold <span class="string">on</span>;
    h_mesh = mesh(x_new,y_new,lambdaZernike{exampleCell},<span class="string">'AlphaData'</span>,0);
    get(h_mesh,<span class="string">'AlphaData'</span>);
    set(h_mesh,<span class="string">'FaceAlpha'</span>,0.2,<span class="string">'EdgeAlpha'</span>,0.2,<span class="string">'EdgeColor'</span>,<span class="string">'g'</span>);


<span class="comment">%     h_legend=legend('\lambda_{Gaussian}','\lambda_{Zernike}');</span>
<span class="comment">%     set(h_legend,'FontSize',20);</span>
    plot(x,y,neuron{exampleCell}.xN,neuron{exampleCell}.yN,<span class="string">'r.'</span>);
    axis <span class="string">tight</span> <span class="string">square</span>;
    xlabel(<span class="string">'x position'</span>); ylabel(<span class="string">'y position'</span>);
    title([<span class="string">'Animal#1, Cell#'</span> num2str(exampleCell)],<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
        <span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
</pre><pre class="codeoutput">

%%
    clear lambdaGaussian lambdaZernike;
    load(strcat('PlaceCellDataAnimal1.mat'));
    resData=load(strcat('PlaceCellAnimal1Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    
    for i=1:length(neuron)
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end

    
    
%     h1=plot(x,y,'b');
%     h2=plot(x,y,'g');
    %
    exampleCell = 25;
%     figure(8);
%     plot(x,y,'b',neuron{exampleCell}.xN,neuron{exampleCell}.yN,'r.');
%     xlabel('x'); ylabel('y'); 
%     title(['Animal#1, Cell#' num2str(exampleCell)]);
%     
    close all;
    h9=figure(9);
    h_mesh = mesh(x_new,y_new,lambdaGaussian{exampleCell},'AlphaData',0);
    get(h_mesh,'AlphaData');
    set(h_mesh,'FaceAlpha',0.2,'EdgeAlpha',0.2,'EdgeColor','b');
    hold on;
    h_mesh = mesh(x_new,y_new,lambdaZernike{exampleCell},'AlphaData',0);
    get(h_mesh,'AlphaData');
    set(h_mesh,'FaceAlpha',0.2,'EdgeAlpha',0.2,'EdgeColor','g');

    
%     h_legend=legend('\lambda_{Gaussian}','\lambda_{Zernike}');
%     set(h_legend,'FontSize',20);
    plot(x,y,neuron{exampleCell}.xN,neuron{exampleCell}.yN,'r.');
    axis tight square;
    xlabel('x position'); ylabel('y position');
    title(['Animal#1, Cell#' num2str(exampleCell)],'FontWeight','bold',...
        'Fontsize',12,'FontName','Arial');
    hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_19.png" alt=""> <h2 id="32">Example 5 - STIMULUS DECODING</h2><p>In this example we show how to decode a univariate and a bivariate stimulus based on a point process observations using nSTAT. Even though due to the simulated nature of the data, we know the exact condition intensity function, we estimate the parameters before moving on to the decoding stage.</p><h2 id="33">Generate the conditional Intensity Function</h2><pre class="codeinput">    close <span class="string">all</span>; clear <span class="string">all</span>;
    delta = 0.001; Tmax = 1;
    time = 0:delta:Tmax;
    numRealizations = 20;
    f=2; b1=randn(numRealizations,1);b0=log(10*delta)+randn(numRealizations,1);
    x = sin(2*pi*f*time);
    clear <span class="string">nst</span>;
    <span class="keyword">for</span> i=1:numRealizations
        expData = exp(b1(i)*x+b0(i));
        lambdaData = expData./(1+expData);

        <span class="keyword">if</span>(i==1)
            lambda = Covariate(time,lambdaData./delta, <span class="keyword">...</span>
                <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,{<span class="string">'\lambda_{1}'</span>},<span class="keyword">...</span>
                {{<span class="string">' ''b'', ''LineWidth'' ,2'</span>}});
        <span class="keyword">else</span>
            tempLambda = Covariate(time,lambdaData./delta, <span class="keyword">...</span>
                <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,{<span class="string">'\lambda_{1}'</span>},<span class="keyword">...</span>
                {{<span class="string">' ''b'', ''LineWidth'' ,2'</span>}});
            lambda = lambda.merge(tempLambda);
        <span class="keyword">end</span>

        spikeColl = CIF.simulateCIFByThinningFromLambda(<span class="keyword">...</span>
            lambda.getSubSignal(i),1);
        nst{i} = spikeColl.getNST(1);
    <span class="keyword">end</span>
        spikeColl = nstColl(nst);scrsz = get(0,<span class="string">'ScreenSize'</span>);
        h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 <span class="keyword">...</span>
            scrsz(3)*.6 scrsz(4)*.8]);
<span class="comment">%         figure;</span>
        subplot(3,1,1); plot(time,x,<span class="string">'k'</span>);
        set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]); ylabel(<span class="string">'Stimulus'</span>);
            hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>);
            set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
            title(<span class="string">'Driving Stimulus'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
                <span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
        subplot(3,1,2); lambda.plot([],{{<span class="string">' ''k'',''Linewidth'',1'</span>}});
            legend <span class="string">off</span>;
            hy=ylabel(<span class="string">'Firing Rate [spikes/sec]'</span>, <span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
            hx=xlabel(<span class="string">''</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
            set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="keyword">...</span>
                <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
            set(gca,<span class="string">'xtickLabel'</span>,[]);
            title(<span class="string">'Conditional Intensity Functions'</span>,<span class="string">'FontWeight'</span>,<span class="keyword">...</span>
                <span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

        subplot(3,1,3); spikeColl.plot;
            set(gca,<span class="string">'ytick'</span>,0:10:numRealizations,<span class="string">'ytickLabel'</span>,<span class="keyword">...</span>
                0:10:numRealizations);
            xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
            ylabel(<span class="string">'Cell Number'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
            hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>);
            set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
            title(<span class="string">'Point Process Sample Paths'</span>,<span class="string">'FontWeight'</span>,<span class="keyword">...</span>
                <span class="string">'bold'</span>,<span class="string">'FontSize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

stim = Covariate(time,sin(2*pi*f*time),<span class="string">'Stimulus'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'V'</span>,{<span class="string">'stim'</span>});
baseline = Covariate(time,ones(length(time),1),<span class="string">'Baseline'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>,<span class="keyword">...</span>
                    {<span class="string">'constant'</span>});

<span class="comment">%     close all;</span>
</pre><pre class="codeoutput">

    
%% Example 5 - STIMULUS DECODING
% In this example we show how to decode a univariate and a bivariate
% stimulus based on a point process observations using nSTAT. Even though 
% due to the simulated nature of the data, we know the exact condition 
% intensity function, we estimate the parameters before moving on to the 
% decoding stage.
%% Generate the conditional Intensity Function

    close all; clear all;
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
    delta = 0.001; Tmax = 1;
    time = 0:delta:Tmax;
    numRealizations = 20;
    f=2; b1=randn(numRealizations,1);b0=log(10*delta)+randn(numRealizations,1);
    x = sin(2*pi*f*time);
    clear nst;
    for i=1:numRealizations
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
            lambda = Covariate(time,lambdaData./delta, ...
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        spikeColl = nstColl(nst);scrsz = get(0,'ScreenSize');
        h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 ...
            scrsz(3)*.6 scrsz(4)*.8]);
%         figure;
        subplot(3,1,1); plot(time,x,'k'); 
        set(gca,'xtick',[],'xtickLabel',[]); ylabel('Stimulus');
            hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
            set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
            title('Driving Stimulus','FontWeight','bold',...
                'FontSize',14,'FontName','Arial');
        subplot(3,1,2); lambda.plot([],{{' ''k'',''Linewidth'',1'}}); 
            legend off; 
            hy=ylabel('Firing Rate [spikes/sec]', 'Interpreter','none');
            hx=xlabel('','Interpreter','none');
            set([hx, hy],'FontName', 'Arial','FontSize',12,...
                'FontWeight','bold');
            set(gca,'xtickLabel',[]);
            title('Conditional Intensity Functions','FontWeight',...
                'bold','FontSize',14,'FontName','Arial');
 
        subplot(3,1,3); spikeColl.plot; 
            set(gca,'ytick',0:10:numRealizations,'ytickLabel',...
                0:10:numRealizations); 
            xlabel('time [s]','Interpreter','none');
            ylabel('Cell Number','Interpreter','none');
            hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
            set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
            title('Point Process Sample Paths','FontWeight',...
                'bold','FontSize',14,'FontName','Arial');

stim = Covariate(time,sin(2*pi*f*time),'Stimulus','time','s','V',{'stim'});
baseline = Covariate(time,ones(length(time),1),'Baseline','time','s','',...
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_20.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;

clear <span class="string">lambdaCIF</span>;
spikeColl.resample(1/delta);
dN=spikeColl.dataToMatrix;

<span class="comment">% Make noise according to the dynamic range of the stimulus</span>
Q=std(stim.data(2:end)-stim.data(1:end-1));
Px0=.1; A=1;
x0 = x(:,1); yT=x(:,end);
Pi0 = eps*eye(size(x0,1),size(x0,1));
PiT = eps*eye(size(x0,1),size(x0,1));


[x_p, W_p, x_u, W_u] = DecodingAlgorithms.PPDecodeFilterLinear(A, <span class="keyword">...</span>
    Q, dN',b0,b1',<span class="string">'binomial'</span>,delta);
<span class="comment">%</span>
h=figure(<span class="string">'Position'</span>,[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.6]);
zVal=1.96;
ciLower = min(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',<span class="keyword">...</span>
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));
ciUpper = max(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',<span class="keyword">...</span>
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));

estimatedStimulus = Covariate(time,x_u(1:end),<span class="string">'\hat{x}(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>);
CI= ConfidenceInterval(time,[ciLower', ciUpper'],<span class="string">'\hat{x}(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">''</span>);
estimatedStimulus.setConfInterval(CI);

<span class="comment">% hold all;</span>
<span class="comment">% hEst=plot(time,x_u(1:end),'b','Linewidth',2); hold on;</span>
<span class="comment">% plot(time, [ciUpper', ciLower'],'b');</span>

hEst = estimatedStimulus.plot([],{{<span class="string">' ''k'',''Linewidth'',4'</span>}});
hStim=stim.plot([],{{<span class="string">' ''b'',''Linewidth'',4'</span>}});
legend <span class="string">off</span>;
h_legend=legend([hEst(1) hStim],<span class="string">'Decoded'</span>,<span class="string">'Actual'</span>);
set(h_legend,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set(h_legend,<span class="string">'FontSize'</span>,22);
title([<span class="string">'Decoded Stimulus +/- 95% CIs with '</span> num2str(numRealizations) <span class="string">' cells'</span>],<span class="keyword">...</span>
    <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,22,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
ylabel(<span class="string">'Stimulus'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,22,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
</pre><pre class="codeoutput">                    {'constant'});

%     close all;
%%
close all;

clear lambdaCIF;
spikeColl.resample(1/delta);
dN=spikeColl.dataToMatrix;

% Make noise according to the dynamic range of the stimulus
Q=std(stim.data(2:end)-stim.data(1:end-1));
Px0=.1; A=1;
x0 = x(:,1); yT=x(:,end);
Pi0 = eps*eye(size(x0,1),size(x0,1));
PiT = eps*eye(size(x0,1),size(x0,1));


[x_p, W_p, x_u, W_u] = DecodingAlgorithms.PPDecodeFilterLinear(A, ...
    Q, dN',b0,b1','binomial',delta);
%
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.6]);
zVal=1.96;
ciLower = min(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',...
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));
ciUpper = max(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',...
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));

estimatedStimulus = Covariate(time,x_u(1:end),'\hat{x}(t)','time','s','');
CI= ConfidenceInterval(time,[ciLower', ciUpper'],'\hat{x}(t)','time','s','');
estimatedStimulus.setConfInterval(CI);

% hold all;            
% hEst=plot(time,x_u(1:end),'b','Linewidth',2); hold on;
% plot(time, [ciUpper', ciLower'],'b');

hEst = estimatedStimulus.plot([],{{' ''k'',''Linewidth'',4'}});
hStim=stim.plot([],{{' ''b'',''Linewidth'',4'}}); 
legend off;
h_legend=legend([hEst(1) hStim],'Decoded','Actual');
set(h_legend,'Interpreter','none');
set(h_legend,'FontSize',22);
title(['Decoded Stimulus +/- 95% CIs with ' num2str(numRealizations) ' cells'],...
    'FontWeight','bold','Fontsize',22,'FontName','Arial');
xlabel('time [s]','Interpreter','none');
ylabel('Stimulus','Interpreter','none');
hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
set([hx, hy],'FontName', 'Arial','FontSize',22,'FontWeight','bold');
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_21.png" alt=""> <h2 id="35">Example 5b - Arm reaching to target Simulation</h2><p>See L. Srinivasan, U. T. Eden, A. S. Willsky, and E. N. Brown, "A state-space analysis for reconstruction of goal-directed movements using neural signals.," Neural computation, vol. 18, no. 10, pp. 2465?2494, Oct. 2006.</p><pre class="codeinput">    close <span class="string">all</span>;
    clear <span class="string">all</span>;
    <span class="comment">%Process noise covariance only drives the movement velocity</span>
    q=1e-4;
    Q=diag([1e-12 1e-12 q q]);

    delta = .001;        <span class="comment">% Time increment</span>
    r=1e-6;   <span class="comment">% in meters^2</span>
    p=1e-6;    <span class="comment">% in meters^2/s^2</span>
    PiT=diag([r r p p]); <span class="comment">% Uncertainty in the target state</span>
    Pi0=PiT;
    T=2;                 <span class="comment">% Reach Duration</span>

    x0 = [0;0;0;0];     <span class="comment">% Initial Position and velocities (states)</span>
    xT = [-.35;.2; 0;0];<span class="comment">% Final Target</span>
    time=0:delta:T;     <span class="comment">% time vector</span>

    A=[1 0 delta 0    ; <span class="comment">%State transition matrix</span>
       0 1 0     delta;
       0 0 1     0    ;
       0 0 0     1    ];

    x=zeros(4,length(time));


<span class="comment">% Simulate a reach trajectory</span>
<span class="comment">% Differs from reference by multiplication by delta instead of division so</span>
<span class="comment">% that the velocity has units of meters per second</span>
    R=chol(Q);
    L=chol(PiT);
    <span class="keyword">for</span> k=1:length(time)
        <span class="keyword">if</span>(k==1)
            x(:,k)=x0;
        <span class="keyword">else</span>
             x(:,k)=A*x(:,k-1)+<span class="keyword">...</span>
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;<span class="keyword">...</span>
                 xT(1)-x0(1);xT(2)-x0(2)]; <span class="comment">%Reach to target model</span>
            <span class="comment">%x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model</span>
        <span class="keyword">end</span>

    <span class="keyword">end</span>
    xT =x(:,end); <span class="comment">% The target generated by the model</span>
    yT=xT;        <span class="comment">% Assume we have observed the actual target position with uncertainty PiT</span>

    <span class="comment">%Define Q according to the dynamic range of the movement above</span>
    Q=diag(var(diff(x,[],2),[],2))*100;

    <span class="comment">% Plot the movement trajectories and the hand path</span>
    scrsz = get(0,<span class="string">'ScreenSize'</span>);
    fig1=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 <span class="keyword">...</span>
        scrsz(3)*.8 scrsz(4)*.8]);
    <span class="comment">%Plot The movement path</span>
    subplot(4,2,[1 3]);
    plot(100*x(1,:),100*x(2,:),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2);
    xlabel(<span class="string">'X Position [cm]'</span>); ylabel(<span class="string">'Y Position [cm]'</span>);
    hx=get(gca,<span class="string">'XLabel'</span>);  hy=get(gca,<span class="string">'YLabel'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Reach Path'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hold <span class="string">on</span>;
    axis([sort([100*x0(1)+5, 100*xT(1)-5]), sort([100*x0(2)-5, 100*xT(2)+5])]);
    h1=plot(100*x(1,1),100*x(2,1),<span class="string">'bo'</span>,<span class="string">'MarkerSize'</span>,14);
    h2=plot(100*x(1,end),100*x(2,end),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,14);
    legend([h1 h2],<span class="string">'Start'</span>,<span class="string">'Finish'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);


    subplot(4,2,5); h1=plot(time,100*x(1,:),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); hold <span class="string">on</span>;
    h2=plot(time,100*x(2,:),<span class="string">'k-.'</span>,<span class="string">'Linewidth'</span>,2);
    h_legend=legend([h1,h2],<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
    set(h_legend,<span class="string">'FontSize'</span>,14)
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'Position [cm]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    <span class="comment">% Plot the velocity profiles</span>

    subplot(4,2,7);
    h1=plot(time,100*x(3,:),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); hold <span class="string">on</span>;
    h2=plot(time,100*x(4,:),<span class="string">'k-.'</span>,<span class="string">'Linewidth'</span>,2);
    h_legend=legend([h1 h2],<span class="string">'v_x'</span>,<span class="string">'v_y'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
    xlabel(<span class="string">'time [s]'</span>);
    set(h_legend,<span class="string">'FontSize'</span>,14);
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'Velocity [cm/s]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    <span class="comment">%</span>

    gamma=0;
    windowTimes=[0, 0.001];


<span class="comment">% Simulate neural responses</span>
    <span class="comment">% logit(lambda_i*delta) = mu_i + b_x_i*v_x + b_y_i*v_y</span>
    <span class="comment">% logit(lambda_i*delta) = X_i*beta_i;</span>
    numCells = 20;
    bCoeffs=10*(rand(numCells,2)-.5);           <span class="comment">% b_i = [b_x_i b_y_i] ~ U(-5, 5);</span>
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  <span class="comment">% Maximal firing direction of cell</span>
    phiMaxNorm = (phiMax+pi)./(2*pi);
    meanMu = log(10*delta); <span class="comment">% baseline firing rate -10Hz</span>
    MuCoeffs = meanMu+randn(numCells,1);   <span class="comment">% mu_i ~ G(meanMu,1)</span>

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; <span class="comment">% design matrix: X (</span>
    coeffs = [MuCoeffs bCoeffs]; <span class="comment">% coefficient vector: beta</span>
    fitType=<span class="string">'binomial'</span>;
    clear <span class="string">nst</span>;
    <span class="keyword">for</span> i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');

         <span class="keyword">if</span>(strcmp(fitType,<span class="string">'poisson'</span>))
             lambdaData = tempData;
         <span class="keyword">else</span>
            lambdaData = tempData./(1+tempData); <span class="comment">% Conditional Intensity Function for ith cell</span>
         <span class="keyword">end</span>
         lambda{i}=Covariate(time,lambdaData./delta, <span class="keyword">...</span>
             <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,<span class="keyword">...</span>
             {strcat(<span class="string">'\lambda_{'</span>,num2str(i),<span class="string">'}'</span>)},{{<span class="string">' ''b'' '</span>}});
         lambda{i}=lambda{i}.resample(1/delta);

         <span class="comment">% Generate CIF representation in case we want to use the symbolic</span>
         <span class="comment">% versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear</span>
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],<span class="keyword">...</span>
             {<span class="string">'1'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'vx'</span>,<span class="string">'vy'</span>},{<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'vx'</span>,<span class="string">'vy'</span>},fitType);
         <span class="comment">% generate one realization for each cell</span>
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     <span class="comment">% grab the realization</span>
         nst{i}.setName(num2str(i));              <span class="comment">% give each cell a unique name</span>
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{<span class="string">' ''k'', ''LineWidth'' ,.5'</span>}});
         legend <span class="string">off</span>; hold <span class="string">all</span>; <span class="comment">% Plot the CIF</span>



    <span class="keyword">end</span>
    title(<span class="string">'Neural Conditional Intensity Functions'</span>,<span class="string">'FontWeight'</span>,<span class="keyword">...</span>
        <span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    hy=ylabel(<span class="string">'Firing Rate [spikes/sec]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    spikeColl = nstColl(nst); <span class="comment">% Create a neural spike train collection</span>

    subplot(4,2,[2,4]); spikeColl.plot;
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
    title(<span class="string">'Neural Raster'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
        <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    hy=ylabel(<span class="string">'Cell Number'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

<span class="comment">%     close all;</span>
</pre><pre class="codeoutput">

    
%% Example 5b - Arm reaching to target Simulation
% See 
% L. Srinivasan, U. T. Eden, A. S. Willsky, and E. N. Brown, 
% "A state-space analysis for reconstruction of goal-directed movements 
% using neural signals.," Neural computation, vol. 18, no. 10, pp. 2465?2494, Oct. 2006.

    close all;
    clear all;
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
    %Process noise covariance only drives the movement velocity
    q=1e-4;
    Q=diag([1e-12 1e-12 q q]); 

    delta = .001;        % Time increment
    r=1e-6;   % in meters^2 
    p=1e-6;    % in meters^2/s^2
    PiT=diag([r r p p]); % Uncertainty in the target state
    Pi0=PiT;
    T=2;                 % Reach Duration

    x0 = [0;0;0;0];     % Initial Position and velocities (states)
    xT = [-.35;.2; 0;0];% Final Target
    time=0:delta:T;     % time vector

    A=[1 0 delta 0    ; %State transition matrix
       0 1 0     delta;
       0 0 1     0    ;
       0 0 0     1    ];

    x=zeros(4,length(time));


% Simulate a reach trajectory
% Differs from reference by multiplication by delta instead of division so
% that the velocity has units of meters per second
    R=chol(Q);
    L=chol(PiT);
    for k=1:length(time)
        if(k==1)
            x(:,k)=x0;
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
        if(k==1)
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
    xT =x(:,end); % The target generated by the model
    yT=xT;        % Assume we have observed the actual target position with uncertainty PiT

    %Define Q according to the dynamic range of the movement above 
    Q=diag(var(diff(x,[],2),[],2))*100;

    % Plot the movement trajectories and the hand path
    scrsz = get(0,'ScreenSize');
    fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
        scrsz(3)*.8 scrsz(4)*.8]);
    %Plot The movement path
    subplot(4,2,[1 3]); 
    plot(100*x(1,:),100*x(2,:),'k','Linewidth',2); 
    xlabel('X Position [cm]'); ylabel('Y Position [cm]');
    hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    title('Reach Path','FontWeight','bold','Fontsize',14,'FontName','Arial');
    hold on; 
    axis([sort([100*x0(1)+5, 100*xT(1)-5]), sort([100*x0(2)-5, 100*xT(2)+5])]);
    h1=plot(100*x(1,1),100*x(2,1),'bo','MarkerSize',14); 
    h2=plot(100*x(1,end),100*x(2,end),'ro','MarkerSize',14); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); h1=plot(time,100*x(1,:),'k','Linewidth',2); hold on;
    h2=plot(time,100*x(2,:),'k-.','Linewidth',2); 
    h_legend=legend([h1,h2],'x','y','Location','NorthEast'); 
    set(h_legend,'FontSize',14)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel('time [s]'); hy=ylabel('Position [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    % Plot the velocity profiles 

    subplot(4,2,7);   
    h1=plot(time,100*x(3,:),'k','Linewidth',2); hold on;
    h2=plot(time,100*x(4,:),'k-.','Linewidth',2); 
    h_legend=legend([h1 h2],'v_x','v_y','Location','NorthEast'); 
    xlabel('time [s]');
    set(h_legend,'FontSize',14);
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel('time [s]'); hy=ylabel('Velocity [cm/s]');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    %

    gamma=0;
    windowTimes=[0, 0.001];


% Simulate neural responses
    % logit(lambda_i*delta) = mu_i + b_x_i*v_x + b_y_i*v_y
    % logit(lambda_i*delta) = X_i*beta_i;
    numCells = 20; 
    bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta); % baseline firing rate -10Hz
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst;
    for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
    title('Neural Conditional Intensity Functions','FontWeight',...
        'bold','Fontsize',14,'FontName','Arial');
    hx=xlabel('time [s]','Interpreter','none'); 
    hy=ylabel('Firing Rate [spikes/sec]','Interpreter','none');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    spikeColl = nstColl(nst); % Create a neural spike train collection
    
    subplot(4,2,[2,4]); spikeColl.plot;
    set(gca,'xtick',[],'xtickLabel',[]);
    title('Neural Raster','FontWeight','bold','Fontsize',14,...
        'FontName','Arial');
    hx=xlabel('time [s]','Interpreter','none'); 
    hy=ylabel('Cell Number','Interpreter','none');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_22.png" alt=""> <pre class="codeinput">close <span class="string">all</span>;
numExamples=20;
scrsz = get(0,<span class="string">'ScreenSize'</span>);
fig1=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 <span class="keyword">...</span>
    scrsz(3)*.6 scrsz(4)*.9]);
<span class="keyword">for</span> k=1:numExamples
     bCoeffs=10*(rand(numCells,2)-.5);           <span class="comment">% b_i = [b_x_i b_y_i] ~ U(-5, 5);</span>
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  <span class="comment">% Maximal firing direction of cell</span>
    phiMaxNorm = (phiMax+pi)./(2*pi);
    meanMu = log(10*delta);  <span class="comment">% baseline firing rate</span>
    MuCoeffs = meanMu+randn(numCells,1);   <span class="comment">% mu_i ~ G(meanMu,1)</span>

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; <span class="comment">% design matrix: X (</span>
    coeffs = [MuCoeffs bCoeffs]; <span class="comment">% coefficient vector: beta</span>
    fitType=<span class="string">'binomial'</span>;
    clear <span class="string">nst</span> <span class="string">lambda</span>;


    <span class="keyword">for</span> i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         <span class="keyword">if</span>(strcmp(fitType,<span class="string">'poisson'</span>))
            lambdaData = tempData;
         <span class="keyword">else</span>
             <span class="comment">% Conditional Intensity Function for ith cell</span>
            lambdaData = tempData./(1+tempData);
         <span class="keyword">end</span>
         lambda{i}=Covariate(time,lambdaData./delta, <span class="keyword">...</span>
             <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,<span class="keyword">...</span>
             {strcat(<span class="string">'\lambda_{'</span>,num2str(i),<span class="string">'}'</span>)},{{<span class="string">' ''b'' '</span>}});
         lambda{i}=lambda{i}.resample(1/delta);

         <span class="comment">% Generate CIF representation in case we want to use the symbolic</span>
         <span class="comment">% versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear</span>
         <span class="comment">% generate one realization for each cell</span>
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);
         nst{i} = tempSpikeColl{i}.getNST(1);     <span class="comment">% grab the realization</span>
         nst{i}.setName(num2str(i));              <span class="comment">% give each cell a unique name</span>

    <span class="keyword">end</span>

    <span class="comment">% Plot the neural raster across all the cells</span>
    spikeColl = nstColl(nst); <span class="comment">% Create a neural spike train collection</span>

    <span class="comment">% Based on the temporal resolution defined by delta, bin the data and get</span>
    <span class="comment">% a matrix representation of the neural firing</span>
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; <span class="comment">% more than one spike per bin will be treated as one spike. In</span>
                <span class="comment">% general we should pick delta small enough so that there is</span>
                <span class="comment">% only one spike per bin</span>

    [C,N]   = size(dN); <span class="comment">% N time samples, C cells</span>

    beta=[zeros(2,numCells);  bCoeffs'];


    <span class="comment">%Use the Goal Directed Movement Version of the Point Process adaptive</span>
    <span class="comment">%Filter</span>
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = <span class="keyword">...</span>
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,<span class="keyword">...</span>
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    <span class="comment">%Use the Free Movement Version of the Point Process adaptive</span>
    <span class="comment">%Filter</span>
    [x_pf, W_pf, x_uf, W_uf] = <span class="keyword">...</span>
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,<span class="keyword">...</span>
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    <span class="keyword">if</span>(k==numExamples)
        subplot(4,2,1:4);h1=plot(100*x(1,:),100*x(2,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3);
        hold <span class="string">on</span>;
        axis([sort([100*x0(1)+5, 100*xT(1)-5]), <span class="keyword">...</span>
            sort([100*x0(2)-5, 100*xT(2)+5])]);
        title(<span class="string">'Estimated vs. Actual Reach Paths'</span>,<span class="keyword">...</span>
            <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    <span class="keyword">end</span>
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)',<span class="string">'b'</span>); hold <span class="string">all</span>;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)',<span class="string">'g'</span>);
    hx=xlabel(<span class="string">'x [cm]'</span>); hy=ylabel(<span class="string">'y [cm]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    h1=plot(100*x0(1),100*x0(2),<span class="string">'bo'</span>,<span class="string">'MarkerSize'</span>,10); hold <span class="string">on</span>;
    h2=plot(100*xT(1),100*xT(2),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,10);
    legend([h1 h2],<span class="string">'Start'</span>,<span class="string">'Finish'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);


    subplot(4,2,5);
    h1=plot(time,100*x(1,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*x_u(1,:)',<span class="string">'b'</span>);
    h3=plot(time,100*x_uf(1,:)',<span class="string">'g'</span>);
    hy=ylabel(<span class="string">'x(t) [cm]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'X Position'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

    subplot(4,2,6);
    h1=plot(time,100*x(2,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*x_u(2,:)',<span class="string">'b'</span>);
    h3=plot(time,100*x_uf(2,:)',<span class="string">'g'</span>);
    h_legend=legend([h1(1) h2(1) h3(1)],<span class="string">'Actual'</span>,<span class="string">'PPAF+Goal'</span>,<span class="keyword">...</span>
        <span class="string">'PPAF'</span>,<span class="string">'Location'</span>,<span class="string">'SouthEast'</span>);
    hy=ylabel(<span class="string">'y(t) [cm]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Y Position'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    set(h_legend,<span class="string">'FontSize'</span>,10)
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7);
    h1=plot(time,100*x(3,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*x_u(3,:)',<span class="string">'b'</span>);
    h3=plot(time,100*x_uf(3,:)',<span class="string">'g'</span>);
    hy=ylabel(<span class="string">'v_{x}(t) [cm/s]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'X Velocity'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

    subplot(4,2,8);
    h1=plot(time,100*x(4,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*x_u(4,:)',<span class="string">'b'</span>);
    h3=plot(time,100*x_uf(4,:)',<span class="string">'g'</span>);
    hy=ylabel(<span class="string">'v_{y}(t) [cm/s]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Y Velocity'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);


<span class="keyword">end</span>

<span class="comment">%     close all;</span>
</pre><pre class="codeoutput">
%     close all;

    
%%
close all;
numExamples=20;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.6 scrsz(4)*.9]);
for k=1:numExamples
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN&gt;1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
        subplot(4,2,1:4);h1=plot(100*x(1,:),100*x(2,:),'k','LineWidth',3); 
        hold on;
        axis([sort([100*x0(1)+5, 100*xT(1)-5]), ...
            sort([100*x0(2)-5, 100*xT(2)+5])]);
        title('Estimated vs. Actual Reach Paths',...
            'FontWeight','bold','Fontsize',12,'FontName','Arial');
    end
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_23.png" alt=""> <h2 id="37">Experiment 6 - Hybrid Point Process Filter Example</h2><p>NOTE THIS EXAMPLE WAS NOT INCLUDED IN THE FINAL VERSION OF THE PAPER This example is based on an implementation of the Hybrid Point Process filter described in <i>General-purpose filter design for neural prosthetic devices</i> by Srinivasan L, Eden UT, Mitter SK, Brown EN in J Neurophysiol. 2007 Oct, 98(4):2456-75.</p><h2 id="38">Problem Statement</h2><p>Suppose that a process of interest can be modeled as consisting of several discrete states where the evolution of the system under each state can be modeled as a linear state space model. The observations of both the state and the continuous dynamics are not direct, but rather observed through how the continuous and discrete states affect the firing of a population of neurons. The goal of the hybrid filter is to estimate both the continuous dynamics and the underlying system state from only the neural population firing (point process observations).</p><p>To illustrate the use of this filter, we consider a reaching task. We assume two underlying system states s=1="Not Moving"=NM and s=2="Moving"=M. Under the "Not Moving" the position of the arm remain constant, whereas in the "Moving" state, the position and velocities evolved based on the arm acceleration that is modeled as a gaussian white noise process.</p><p>Under both the "Moving" and "Not Moving" states, the arm evolution state vector is</p><p><img src="nSTATPaperExamples_eq01306006823101465304.png" alt="$${\bf{x}} = {[x,y,{v_x},{v_y},{a_x},{a_y}]^T}$$"></p><h2 id="40">Generated Simulated Arm Reach</h2><pre class="codeinput">clear <span class="string">all</span>;
close <span class="string">all</span>;
delta=0.001;
Tmax=2;
time=0:delta:Tmax;
A{2} = [1 0 delta 0     delta^2/2   0;
        0 1 0     delta 0           delta^2/2;
        0 0 1     0     delta       0;
        0 0 0     1     0           delta;
        0 0 0     0     1           0;
        0 0 0     0     0           1];

A{1} = [1 0 0 0 0 0;
        0 1 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0];
A{1} = [1 0;
        0 1];

Px0{2} =1e-6*eye(6,6);
Px0{1} =1e-6*eye(2,2);

minCovVal = 1e-12;
covVal = 1e-3;



Q{2}=[minCovVal     0   0     0   0       0;
      0       minCovVal 0     0   0       0;
      0       0   minCovVal   0   0       0;
      0       0   0     minCovVal 0       0;
      0       0   0     0   covVal      0;
      0       0   0     0   0       covVal];

Q{1}=minCovVal*eye(2,2);

mstate = zeros(1,length(time));
ind{1}=1:2;
ind{2}=1:6;

<span class="comment">% Acceleration model</span>
X=zeros(max([size(A{1},1),size(A{2},1)]),length(time));
p_ij = [.998 .002;
        .001 .999];

<span class="keyword">for</span> i = 1:length(time)

    <span class="keyword">if</span>(i==1)
        mstate(i) = 1;
    <span class="keyword">else</span>
       <span class="keyword">if</span>(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       <span class="keyword">else</span>
           <span class="keyword">if</span>(mstate(i-1)==1)
               mstate(i) = 2;
           <span class="keyword">else</span>
               mstate(i) = 1;
           <span class="keyword">end</span>
       <span class="keyword">end</span>
    <span class="keyword">end</span>
    st = mstate(i);
    R=chol(Q{st});
    <span class="keyword">if</span>(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    <span class="keyword">end</span>

<span class="keyword">end</span>
</pre><pre class="codeoutput">
%     close all;
%% Experiment 6 - Hybrid Point Process Filter Example 
% NOTE THIS EXAMPLE WAS NOT INCLUDED IN THE FINAL VERSION OF THE PAPER
% This example is based on an implementation of the Hybrid Point Process
% filter described in _General-purpose filter design for neural prosthetic 
% devices_ by Srinivasan L, Eden UT, Mitter SK, Brown EN in J Neurophysiol.
% 2007 Oct, 98(4):2456-75. 
%

%% Problem Statement
% Suppose that a process of interest can be modeled as consisting of
% several discrete states where the evolution of the system under each
% state can be modeled as a linear state space model. The observations of
% both the state and the continuous dynamics are not direct, but rather
% observed through how the continuous and discrete states affect the firing
% of a population of neurons. The goal of the hybrid filter is to estimate
% both the continuous dynamics and the underlying system state from only
% the neural population firing (point process observations).
%
% To illustrate the use of this filter, we consider a reaching task. We
% assume two underlying system states s=1="Not Moving"=NM and s=2="Moving"=M.
% Under the "Not Moving" the position of the arm remain constant,
% whereas in the "Moving" state, the position and velocities evolved based
% on the arm acceleration that is modeled as a gaussian white noise
% process.
%
% Under both the "Moving" and "Not Moving" states, the arm evolution state
% vector is 
%%
% 
% $${\bf{x}} = {[x,y,{v_x},{v_y},{a_x},{a_y}]^T}$$
% 

%% Generated Simulated Arm Reach

clear all;
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\private\evalmxdom.m' could not be
cleared because it contains MATLAB code that is currently executing. 
Warning: The file
'C:\Users\Developer\Dropbox\GitHub\nSTAT\helpfiles\nSTATPaperExamples.m' could
not be cleared because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\mdbpublish.m' could not be cleared
because it contains MATLAB code that is currently executing. 
Warning: The file 'C:\Program
Files\MATLAB\R2017a\toolbox\matlab\codetools\publish.p' could not be cleared
because it contains MATLAB code that is currently executing. 
close all;
delta=0.001;
Tmax=2;
time=0:delta:Tmax;
A{2} = [1 0 delta 0     delta^2/2   0;
        0 1 0     delta 0           delta^2/2;
        0 0 1     0     delta       0;
        0 0 0     1     0           delta;
        0 0 0     0     1           0;
        0 0 0     0     0           1];
        
A{1} = [1 0 0 0 0 0;
        0 1 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0];
A{1} = [1 0;
        0 1];
            
Px0{2} =1e-6*eye(6,6);
Px0{1} =1e-6*eye(2,2);

minCovVal = 1e-12;
covVal = 1e-3; 



Q{2}=[minCovVal     0   0     0   0       0;
      0       minCovVal 0     0   0       0;
      0       0   minCovVal   0   0       0;
      0       0   0     minCovVal 0       0;
      0       0   0     0   covVal      0;
      0       0   0     0   0       covVal];

Q{1}=minCovVal*eye(2,2);

mstate = zeros(1,length(time));
ind{1}=1:2;
ind{2}=1:6;

% Acceleration model
X=zeros(max([size(A{1},1),size(A{2},1)]),length(time));
p_ij = [.998 .002; 
        .001 .999];

for i = 1:length(time)
    
    if(i==1)
        mstate(i) = 1;
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
       else
           if(mstate(i-1)==1)
               mstate(i) = 2;
           end
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
    
    if(i==1)
    else
       if(rand(1,1)&lt;p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i&lt;length(time))

end
</pre><pre class="codeinput"><span class="comment">%save paperHybridFilterExample time Tmax delta mstate X p_ij ind A Q Px0</span>
load <span class="string">paperHybridFilterExample</span>;
Q{1}=minCovVal*eye(2,2);
numCells=40;
close <span class="string">all</span>;
scrsz = get(0,<span class="string">'ScreenSize'</span>);
fig1=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 <span class="keyword">...</span>
    scrsz(3)*.8 scrsz(4)*.9]);
subplot(4,2,[1 3]);
plot(100*X(1,:),100*X(2,:),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); hx=xlabel(<span class="string">'X [cm]'</span>);
hy=ylabel(<span class="string">'Y [cm]'</span>);  hold <span class="string">on</span>;
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
title(<span class="string">'Reach Path'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
hold <span class="string">on</span>;
h1=plot(100*X(1,1),100*X(2,1),<span class="string">'bo'</span>,<span class="string">'MarkerSize'</span>,16);
h2=plot(100*X(1,end),100*X(2,end),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,16);
legend([h1 h2],<span class="string">'Start'</span>,<span class="string">'Finish'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);



subplot(4,2,[6 8]);
plot(time,mstate,<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); axis <span class="string">tight</span>; v=axis;
axis([v(1) v(2) 0 3]);
hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'state'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
set(gca,<span class="string">'YTick'</span>,[1 2],<span class="string">'YTickLabel'</span>,{<span class="string">'N'</span>,<span class="string">'M'</span>})
title(<span class="string">'Discrete Movement State'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="keyword">...</span>
    <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

subplot(4,2,5);
h1=plot(time,100*X(1,1:end),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); hold <span class="string">on</span>;
h2=plot(time,100*X(2,1:end),<span class="string">'k-.'</span>,<span class="string">'Linewidth'</span>,2);
hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'Position [cm]'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
h_legend=legend([h1,h2],<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
set(h_legend,<span class="string">'FontSize'</span>,14)
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.06 pos(2)+.01 pos(3:4)]);


subplot(4,2,7);
h1=plot(time,100*X(3,1:end),<span class="string">'k'</span>,<span class="string">'Linewidth'</span>,2); hold <span class="string">on</span>;
h2=plot(time,100*X(4,1:end),<span class="string">'k-.'</span>,<span class="string">'Linewidth'</span>,2);
hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'Velocity [cm/s]'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
h_legend=legend([h1,h2],<span class="string">'v_{x}'</span>,<span class="string">'v_{y}'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
set(h_legend,<span class="string">'FontSize'</span>,14)
pos = get(h_legend,<span class="string">'position'</span>);
set(h_legend, <span class="string">'position'</span>,[pos(1)+.06 pos(2)+.01 pos(3:4)]);

meanMu = log(10*delta);  <span class="comment">% baseline firing rate</span>
MuCoeffs = meanMu+randn(numCells,1);   <span class="comment">% mu_i ~ G(meanMu,1)</span>
coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) <span class="keyword">...</span>
    0*randn(numCells,2)];
<span class="comment">%Add realization by thinning with history</span>
dataMat = [ones(size(X,2),1),X(:,1:end)'];
<span class="comment">% Generate M1 cells</span>
clear <span class="string">lambda</span> <span class="string">tempSpikeColl</span> <span class="string">lambdaCIF</span> <span class="string">n</span>;
fitType =<span class="string">'binomial'</span>;
<span class="comment">% matlabpool open;</span>
 <span class="keyword">for</span> i=1:numCells
     tempData  = exp(dataMat*coeffs(i,:)');
     <span class="keyword">if</span>(strcmp(fitType,<span class="string">'binomial'</span>));
        lambdaData = tempData./(1+tempData);
     <span class="keyword">else</span>
        lambdaData = tempData;
     <span class="keyword">end</span>
     lambda{i}=Covariate(time,lambdaData./delta, <span class="keyword">...</span>
         <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,<span class="keyword">...</span>
         {strcat(<span class="string">'\lambda_{'</span>,num2str(i),<span class="string">'}'</span>)},{{<span class="string">' ''b'', ''LineWidth'' ,2'</span>}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));
 <span class="keyword">end</span>
 spikeColl = nstColl(n);
 subplot(4,2,[2 4]);
spikeColl.plot;
set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[],<span class="string">'ytickLabel'</span>,[]);
title(<span class="string">'Neural Raster'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,14,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
hx=xlabel(<span class="string">'time [s]'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
hy=ylabel(<span class="string">'Cell Number'</span>,<span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,12,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

<span class="comment">% close all;</span>
</pre><pre class="codeoutput">%%
%save paperHybridFilterExample time Tmax delta mstate X p_ij ind A Q Px0
load paperHybridFilterExample;
Q{1}=minCovVal*eye(2,2);
numCells=40;
close all;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.8 scrsz(4)*.9]);
subplot(4,2,[1 3]);
plot(100*X(1,:),100*X(2,:),'k','Linewidth',2); hx=xlabel('X [cm]'); 
hy=ylabel('Y [cm]');  hold on;
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title('Reach Path','FontWeight','bold','Fontsize',14,'FontName','Arial');
hold on; 
h1=plot(100*X(1,1),100*X(2,1),'bo','MarkerSize',16); 
h2=plot(100*X(1,end),100*X(2,end),'ro','MarkerSize',16); 
legend([h1 h2],'Start','Finish','Location','NorthEast');



subplot(4,2,[6 8]);
plot(time,mstate,'k','Linewidth',2); axis tight; v=axis; 
axis([v(1) v(2) 0 3]);
hx=xlabel('time [s]'); hy=ylabel('state');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
set(gca,'YTick',[1 2],'YTickLabel',{'N','M'})
title('Discrete Movement State','FontWeight','bold','Fontsize',14,...
    'FontName','Arial');

subplot(4,2,5);
h1=plot(time,100*X(1,1:end),'k','Linewidth',2); hold on;
h2=plot(time,100*X(2,1:end),'k-.','Linewidth',2);
hx=xlabel('time [s]'); hy=ylabel('Position [cm]');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
h_legend=legend([h1,h2],'x','y','Location','NorthEast'); 
set(h_legend,'FontSize',14)
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);


subplot(4,2,7);
h1=plot(time,100*X(3,1:end),'k','Linewidth',2); hold on;
h2=plot(time,100*X(4,1:end),'k-.','Linewidth',2);
hx=xlabel('time [s]'); hy=ylabel('Velocity [cm/s]');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
h_legend=legend([h1,h2],'v_{x}','v_{y}','Location','NorthEast'); 
set(h_legend,'FontSize',14)
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);

meanMu = log(10*delta);  % baseline firing rate 
MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
    0*randn(numCells,2)];
%Add realization by thinning with history
dataMat = [ones(size(X,2),1),X(:,1:end)'];
% Generate M1 cells
clear lambda tempSpikeColl lambdaCIF n;
fitType ='binomial';
% matlabpool open;
 for i=1:numCells
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
 spikeColl = nstColl(n);
 subplot(4,2,[2 4]);
spikeColl.plot;
set(gca,'xtick',[],'xtickLabel',[],'ytickLabel',[]);
title('Neural Raster','FontWeight','bold','Fontsize',14,'FontName','Arial');
hx=xlabel('time [s]','Interpreter','none'); 
hy=ylabel('Cell Number','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_24.png" alt=""> <h2 id="42">Simulate Neural Firing</h2><p>We simulate a population of neurons that fire in response to the movement velocity (x and y coorinates)</p><pre class="codeinput"><span class="comment">%Use the data to estimate the process noise for the moving case and</span>
<span class="comment">%non-moving case</span>

nonMovingInd = intersect(find(X(5,:)==0),find(X(6,:)==0));
movingInd=setdiff(1:size(X,2),nonMovingInd);
Q{2}=diag(var(diff(X(:,movingInd),[],2),[],2));
Q{2}(1:4,1:4)=0;
varNV=diag(var(diff(X(:,nonMovingInd),[],2),[],2));
Q{1} = varNV(1:2,1:2);
close <span class="string">all</span>; clear <span class="string">S_est</span> <span class="string">X_est</span> <span class="string">MU_est</span> <span class="string">S_estNT</span> <span class="string">X_estNT</span> <span class="string">MU_estNT</span>;
numExamples = 20;
numCells=40;
scrsz = get(0,<span class="string">'ScreenSize'</span>);
fig1=figure(<span class="string">'OuterPosition'</span>,[scrsz(3)*.1 scrsz(4)*.1 <span class="keyword">...</span>
    scrsz(3)*.9 scrsz(4)*.9]);

<span class="keyword">for</span> n=1:numExamples
    meanMu = log(10*delta);  <span class="comment">% baseline firing rate</span>
    MuCoeffs = meanMu+randn(numCells,1);   <span class="comment">% mu_i ~ G(meanMu,1)</span>
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) <span class="keyword">...</span>
        0*randn(numCells,2)];



    <span class="comment">%Add realization by thinning with history</span>
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    <span class="comment">% Generate M1 cells</span>
    clear <span class="string">lambda</span> <span class="string">tempSpikeColl</span> <span class="string">lambdaCIF</span> <span class="string">nst</span>;
    fitType =<span class="string">'binomial'</span>;
    <span class="comment">% matlabpool open;</span>
     <span class="keyword">for</span> i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         <span class="keyword">if</span>(strcmp(fitType,<span class="string">'binomial'</span>))
            lambdaData = tempData./(1+tempData);
         <span class="keyword">else</span>
            lambdaData = tempData;
         <span class="keyword">end</span>
         lambda{i}=Covariate(time,lambdaData./delta, <span class="keyword">...</span>
             <span class="string">'\Lambda(t)'</span>,<span class="string">'time'</span>,<span class="string">'s'</span>,<span class="string">'spikes/sec'</span>,<span class="keyword">...</span>
             {strcat(<span class="string">'\lambda_{'</span>,num2str(i),<span class="string">'}'</span>)},{{<span class="string">' ''b'', ''LineWidth'' ,2'</span>}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = <span class="keyword">...</span>
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));
     <span class="keyword">end</span>

    <span class="comment">% Decode the x-y trajectory</span>

    <span class="comment">% Enforce that the maximum time resolution is delta</span>
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix;
    dN(dN&gt;1)=1; <span class="comment">%Avoid more than 1 spike per bin.</span>

    <span class="comment">% Starting states are equally probable</span>
    Mu0=.5*ones(size(p_ij,1),1);
    clear <span class="string">x0</span> <span class="string">yT</span> <span class="string">clear</span> <span class="string">Pi0</span> <span class="string">PiT</span>;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    <span class="comment">% Run the Hybrid Point Process Filter</span>
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=<span class="keyword">...</span>
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',<span class="keyword">...</span>
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=<span class="keyword">...</span>
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',<span class="keyword">...</span>
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);

    <span class="comment">%Store the results for computing relevant statistics later</span>
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;


    <span class="comment">%State Estimate</span>
    subplot(4,3,[1 4]);
    plot(time,mstate,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">all</span>;
    plot(time,S_est,<span class="string">'b-.'</span>,<span class="string">'Linewidth'</span>,.5);
    plot(time,S_estNT,<span class="string">'g-.'</span>,<span class="string">'Linewidth'</span>,.5); axis <span class="string">tight</span>; v=axis;
    axis([v(1) v(2) 0.5 2.5]);

    <span class="comment">%Movement State Probability (Non-movement State probability is 1-Pr(Movement))</span>
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),<span class="string">'b-.'</span>,<span class="string">'Linewidth'</span>,.5);  hold <span class="string">on</span>;
    plot(time,MU_estNT(2,:),<span class="string">'g-.'</span>,<span class="string">'Linewidth'</span>,.5);  hold <span class="string">on</span>;
    axis([min(time) max(time) 0 1.1]);

    <span class="comment">%The movement path</span>
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)',<span class="string">'k'</span>); hold <span class="string">all</span>;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)',<span class="string">'b-.'</span>); hold <span class="string">all</span>;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)',<span class="string">'g-.'</span>);

    <span class="comment">%X-Position</span>
    subplot(4,3,8);
    h1=plot(time,100*X(1,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*X_est(1,:)',<span class="string">'b-.'</span>);
    h3=plot(time,100*X_estNT(1,:)',<span class="string">'g-.'</span>);

    <span class="comment">%Y-Position</span>
    subplot(4,3,9);
    h1=plot(time,100*X(2,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*X_est(2,:)',<span class="string">'b-.'</span>);
    h3=plot(time,100*X_estNT(2,:)',<span class="string">'g-.'</span>);

    <span class="comment">%X-Velocity</span>
    subplot(4,3,11);
    h1=plot(time,100*X(3,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*X_est(3,:)',<span class="string">'b-.'</span>);
    h3=plot(time,100*X_estNT(3,:)',<span class="string">'g-.'</span>);

    subplot(4,3,12);
    h1=plot(time,100*X(4,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,100*X_est(4,:)',<span class="string">'b-.'</span>);
    h3=plot(time,100*X_estNT(4,:)',<span class="string">'g-.'</span>);




<span class="keyword">end</span>

<span class="comment">%</span>
<span class="comment">%     Save all the example Data</span>
<span class="comment">%     save Experiment6ReachExamples X_estAll X_estNTAll S_estAll ...</span>
<span class="comment">%           S_estNTAll MU_estAll MU_estNTAll;</span>
<span class="comment">%</span>
<span class="comment">%     load Experiment6ReachExamples;</span>

    <span class="comment">% Mean Discrete State Estimate</span>
    subplot(4,3,[1 4]);
    hold <span class="string">all</span>;
    plot(time,mstate,<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3);
    plot(time,mean(S_estAll),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3);
    plot(time,mean(S_estNTAll),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3);
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'YTick'</span>,[1 2.1],<span class="string">'YTickLabel'</span>,{<span class="string">'N'</span>,<span class="string">'M'</span>});
    hy=ylabel(<span class="string">'state'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set([hy hx],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
        <span class="string">'Interpreter'</span>,<span class="string">'none'</span>);
    title(<span class="string">'Estimated vs. Actual State'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,<span class="keyword">...</span>
        12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);




   <span class="comment">% Mean State Movement State Probability</span>
    subplot(4,3,[7 10]);
    plot(time, mean(squeeze(MU_estAll(2,:,:)),2),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3);
    hold <span class="string">on</span>;
    plot(time,mean(squeeze(MU_estNTAll(2,:,:)),2),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3);
    hold <span class="string">on</span>;
    axis([min(time) max(time) 0 1.1]);
    hx=xlabel(<span class="string">'time [s]'</span>); hy=ylabel(<span class="string">'P(s(t)=M | data)'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Probability of State'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="keyword">...</span>
        <span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

    <span class="comment">% Mean movement path</span>
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)',<span class="string">'k'</span>); hold <span class="string">all</span>;
    mXestAll=mean(100*X_estAll,3);
    mXestNTAll=mean(100*X_estNTAll,3);
    plot(mXestAll(1,:),mXestAll(2,:),<span class="string">'b'</span>,<span class="string">'Linewidth'</span>,3);
    plot(mXestNTAll(1,:),mXestNTAll(2,:),<span class="string">'g'</span>,<span class="string">'Linewidth'</span>,3);
    hx=xlabel(<span class="string">'x [cm]'</span>); hy=ylabel(<span class="string">'y [cm]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);

    h1=plot(100*X(1,1),100*X(2,1),<span class="string">'bo'</span>,<span class="string">'MarkerSize'</span>,14); hold <span class="string">on</span>;
    h2=plot(100*X(1,end),100*X(2,end),<span class="string">'ro'</span>,<span class="string">'MarkerSize'</span>,14);
    legend([h1 h2],<span class="string">'Start'</span>,<span class="string">'Finish'</span>,<span class="string">'Location'</span>,<span class="string">'NorthEast'</span>);
    title(<span class="string">'Estimated vs. Actual Reach Path'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="keyword">...</span>
        <span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);


    <span class="comment">% Mean X-Positon</span>
    subplot(4,3,8);
    h1=plot(time,100*X(1,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,mXestAll(1,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h3=plot(time,mXestNTAll(1,:),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    hy=ylabel(<span class="string">'x(t) [cm]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'X Position'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

    <span class="comment">% Mean Y-Position</span>
    subplot(4,3,9);
    h1=plot(time,100*X(2,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,mXestAll(2,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h3=plot(time,mXestNTAll(2,:),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h_legend=legend([h1(1) h2(1) h3(1)],<span class="string">'Actual'</span>,<span class="string">'PPAF+Goal'</span>,<span class="keyword">...</span>
        <span class="string">'PPAF'</span>,<span class="string">'Location'</span>,<span class="string">'SouthEast'</span>);
    hy=ylabel(<span class="string">'y(t) [cm]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set(gca,<span class="string">'xtick'</span>,[],<span class="string">'xtickLabel'</span>,[]);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Y Position'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
    set(h_legend,<span class="string">'FontSize'</span>,10)
    pos = get(h_legend,<span class="string">'position'</span>);
    set(h_legend, <span class="string">'position'</span>,[pos(1)-.40 pos(2)+.51 pos(3:4)]);

    <span class="comment">% Mean X-Velocity</span>
    subplot(4,3,11);
    h1=plot(time,100*X(3,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,mXestAll(3,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h3=plot(time,mXestNTAll(3,:),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    hy=ylabel(<span class="string">'v_{x}(t) [cm/s]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'X Velocity'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);

    <span class="comment">% Mean Y-Velocity</span>
    subplot(4,3,12);
    h1=plot(time,100*X(4,:),<span class="string">'k'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h2=plot(time,mXestAll(4,:),<span class="string">'b'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    h3=plot(time,mXestNTAll(4,:),<span class="string">'g'</span>,<span class="string">'LineWidth'</span>,3); hold <span class="string">on</span>;
    hy=ylabel(<span class="string">'v_{y}(t) [cm/s]'</span>); hx=xlabel(<span class="string">'time [s]'</span>);
    set([hx, hy],<span class="string">'FontName'</span>, <span class="string">'Arial'</span>,<span class="string">'FontSize'</span>,10,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>);
    title(<span class="string">'Y Velocity'</span>,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Fontsize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Arial'</span>);
</pre><pre class="codeoutput">
% close all;
 
%% Simulate Neural Firing
% We simulate a population of neurons that fire in response to the movement
% velocity (x and y coorinates) 

%Use the data to estimate the process noise for the moving case and
%non-moving case

nonMovingInd = intersect(find(X(5,:)==0),find(X(6,:)==0));
movingInd=setdiff(1:size(X,2),nonMovingInd);
Q{2}=diag(var(diff(X(:,movingInd),[],2),[],2));
Q{2}(1:4,1:4)=0;
varNV=diag(var(diff(X(:,nonMovingInd),[],2),[],2));
Q{1} = varNV(1:2,1:2);
close all; clear S_est X_est MU_est S_estNT X_estNT MU_estNT;
numExamples = 20;
numCells=40;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.9 scrsz(4)*.9]);

for n=1:numExamples
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN&gt;1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end

%
%     Save all the example Data
%     save Experiment6ReachExamples X_estAll X_estNTAll S_estAll ...
%           S_estNTAll MU_estAll MU_estNTAll;
%  
%     load Experiment6ReachExamples;

    % Mean Discrete State Estimate
    subplot(4,3,[1 4]);
    hold all; 
    plot(time,mstate,'k','LineWidth',3); 
    plot(time,mean(S_estAll),'b','LineWidth',3); 
    plot(time,mean(S_estNTAll),'g','LineWidth',3); 
    set(gca,'xtick',[],'YTick',[1 2.1],'YTickLabel',{'N','M'});
    hy=ylabel('state'); hx=xlabel('time [s]');
    set([hy hx],'FontName', 'Arial','FontSize',10,'FontWeight','bold',...
        'Interpreter','none');
    title('Estimated vs. Actual State','FontWeight','bold','Fontsize',...
        12,'FontName','Arial');

    
    

   % Mean State Movement State Probability
    subplot(4,3,[7 10]);
    plot(time, mean(squeeze(MU_estAll(2,:,:)),2),'b','LineWidth',3);  
    hold on;
    plot(time,mean(squeeze(MU_estNTAll(2,:,:)),2),'g','LineWidth',3);  
    hold on;
    axis([min(time) max(time) 0 1.1]);
    hx=xlabel('time [s]'); hy=ylabel('P(s(t)=M | data)');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Probability of State','FontWeight','bold','Fontsize',12,...
        'FontName','Arial');
    
    % Mean movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    mXestAll=mean(100*X_estAll,3);
    mXestNTAll=mean(100*X_estNTAll,3);
    plot(mXestAll(1,:),mXestAll(2,:),'b','Linewidth',3);
    plot(mXestNTAll(1,:),mXestNTAll(2,:),'g','Linewidth',3);
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');

    h1=plot(100*X(1,1),100*X(2,1),'bo','MarkerSize',14); hold on;
    h2=plot(100*X(1,end),100*X(2,end),'ro','MarkerSize',14); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');
    title('Estimated vs. Actual Reach Path','FontWeight','bold',...
        'Fontsize',12,'FontName','Arial');

   
    % Mean X-Positon
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(1,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(1,:),'g','LineWidth',3); hold on;
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    
    % Mean Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(2,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(2,:),'g','LineWidth',3); hold on;
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.40 pos(2)+.51 pos(3:4)]);

    % Mean X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(3,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(3,:),'g','LineWidth',3); hold on;
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    % Mean Y-Velocity
    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(4,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(4,:),'g','LineWidth',3); hold on;
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

</pre><img vspace="5" hspace="5" src="nSTATPaperExamples_25.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2017a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% nSTAT J. Neuroscience Methods Paper Examples
%
% *Author*: Iahn Cajigas 
%
% *Date*: 01/04/2012


%% Experiment 1
% MINIATURE EXCITATORY POST-SYNAPTIC CURRENTS (mEPSCs) 
% Data from Marnie Phillips  <marnie.a.phillips@gmail.com>
% This analysis is based on a partial version of the dataset used in
%
% Phillips MA, Lewis LD, Gong J, Constantine-Paton M, Brown EN.  2011  
% _Model-based statistical analysis of miniature synaptic transmission._  
% J Neurophys (under consideration)
%
% *Date*: 03/01/2011
%% Constant Magnesium Concentration - Constant rate poisson
% Under a constant Magnesium concentration, it is seen that the mEPSCs
% behave as a homogeneous poisson process (constant arrival rate).
    close all; clear all;
    epsc2 = importdata('epsc2.txt');
    sampleRate = 1000;
    spikeTimes = epsc2.data(:,2)*1/sampleRate; %in seconds
    nstConst = nspikeTrain(spikeTimes);
    time = 0:(1/sampleRate):nstConst.maxTime;

    
    % Define Covariates for the analysis
    baseline = Covariate(time,ones(length(time),1),'Baseline','time','s',...
        '',{'\mu'});
    covarColl = CovColl({baseline});

    % Create the trial structure
    spikeColl = nstColl(nstConst);
    trial     = Trial(spikeColl,covarColl);
    

    % Define how we want to analyze the data
    clear tc tcc;
    tc{1} = TrialConfig({{'Baseline','\mu'}},sampleRate,[]); 
    tc{1}.setName('Constant Baseline');
    tcc = ConfigColl(tc);
    
    % Perform Analysis (Commented to since data already saved)
    results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);
%     h=results.plotResults;
    close all;
    scrsz = get(0,'ScreenSize');
    results.lambda.setDataLabels({'\lambda_{const}'});
    h=figure('OuterPosition',[scrsz(3)*.01 scrsz(4)*.04 ...
        scrsz(3)*.98 scrsz(4)*.95]);
    
    subplot(2,2,1); spikeColl.plot;
        title({'Neural Raster with constant Mg^{2+} Concentration'},...
            'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
         hx=xlabel('time [s]','Interpreter','none');
         hy=ylabel('mEPSCs','Interpreter','none');
         set(gca,'yTick',[0 1]);
         set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    subplot(2,2,3); results.KSPlot;
    subplot(2,2,2); results.plotInvGausTrans;
    subplot(2,2,4); results.lambda.plot([],{{' ''b'' ,''Linewidth'',2'}}); 
    hx=xlabel('time [s]','Interpreter','none');
    hy=get(gca,'YLabel');
    set([hx hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    h_legend = legend('\lambda_{const}','Location','NorthEast');
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.05 pos(2) pos(3:4)]);
    set(h_legend,'FontSize',14)


 %% Varying Magnesium Concentration - Piecewise Constant rate poisson
 % When the magnesium concentration of the bath decreased (i.e. magnesium
 % is removed), the rate of mEPSCs begin to increase in frequency. This can
 % be modeled in a many different ways (using the change in Magnesium
 % directly as a model covariate, etc.) Here we approximate the rate as
 % being constant during certain portions of the experiment. These segments
 % can in principle be estimated (using heirarchical Bayesian methods), but
 % here we select them via visual inspection. We compare three models: a
 % constant rate model (from above), a piecewise constant rate model, and a
 % piecewise constant rate model with history.
    close all;
 % load the data;
    washout1 = importdata('washout1.txt');
    washout2 = importdata('washout2.txt');
    
    sampleRate  = 1000;
    % Magnesium removed at t=0
    spikeTimes1 = 260+washout1.data(:,2)*1/sampleRate; %in seconds
    spikeTimes2 = sort(washout2.data(:,2))*1/sampleRate + 745;%in seconds
    nst = nspikeTrain([spikeTimes1; spikeTimes2]);
    time = 260:(1/sampleRate):nst.maxTime;

    %% Data Visualization
    % Visual inspection of the spike train is used to pick three regions
    % where the firing rate appears to be different. Here we do not
    % estimate where these transitions happen but pick times in an ad-hoc
    % manner.
    scrsz = get(0,'ScreenSize');
    h=figure('OuterPosition',[scrsz(3)*.01 scrsz(4)*.04 scrsz(3)*.6 ...
        scrsz(4)*.9]);
                
    subplot(2,1,1);
    nstConst.plot; set(gca,'yTick',[0 1]); hy=ylabel('mEPSCs');
     title({'Neural Raster with constant Mg^{2+} Concentration'},...
         'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
    hx=get(gca,'XLabel');
    set([hx,hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    
    subplot(2,1,2);
    nst.plot; set(gca,'yTick',[0 1]); hy=ylabel('mEPSCs');
    title({'Neural Raster with decreasing Mg^{2+} Concentration'},...
        'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
    hx=get(gca,'XLabel');
    set([hx,hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');



    %% Define Covariates for the analysis    
          timeInd1 =find(time<495,1,'last'); %0-495sec first constant rate
        timeInd2 =find(time<765,1,'last'); %495-765 second constant rate epoch
                                       %765 onwards third constant rate
                                       %epoch
    constantRate = ones(length(time),1); 
    rate1 = zeros(length(time),1); rate1(1:timeInd1)=1;
    rate2 = zeros(length(time),1); rate2((timeInd1+1):timeInd2)=1;
    rate3 = zeros(length(time),1); rate3((timeInd2+1):end)=1;
    baseline = Covariate(time,[constantRate,rate1, rate2, rate3],...
        'Baseline','time','s','',{'\mu','\mu_{1}','\mu_{2}','\mu_{3}'});
    covarColl = CovColl({baseline});

    % Create the trial structure
    spikeColl = nstColl(nst);
    trial     = Trial(spikeColl,covarColl);
    
    %30ms history in logarithmic spacing (chosen after using
    %Analysis.computeHistLagForAll for various window lengths)
    maxWindow=.3; numWindows=20; 
    delta=1/sampleRate;
    windowTimes =unique(round([0 logspace(log10(delta),...
    log10(maxWindow),numWindows)]*sampleRate)./sampleRate);
    windowTimes = windowTimes(1:11);
    
    %% Define how we want to analyze the data
    clear tc tcc;
    tc{1} = TrialConfig({{'Baseline','\mu'}},sampleRate,[]); 
    tc{1}.setName('Constant Baseline');
    tc{2} = TrialConfig({{'Baseline','\mu_{1}','\mu_{2}','\mu_{3}'}},...
        sampleRate,[]); tc{2}.setName('Diff Baseline');
    tcc = ConfigColl(tc);
    
    %% Perform Analysis 
    % We see that the piece-wise constant rate model (without
    % history) outperforms the constant baseline model in terms of AIC, BIC,
    % and KS-statistic. 
    results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);
%     h=results.plotResults;
%     Summary = FitResSummary(results);
%     h=Summary.plotSummary;

%%
close all;
    scrsz = get(0,'ScreenSize');
    results.lambda.setDataLabels({'\lambda_{const}',...
        '\lambda_{const-epoch}'});
    h=figure('OuterPosition',[scrsz(3)*.01 scrsz(4)*.04 ...
        scrsz(3)*.98 scrsz(4)*.95]);
    
    subplot(2,2,1); spikeColl.plot;
        title({'Neural Raster with decreasing Mg^{2+} Concentration'},...
            'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
        hx=xlabel('time [s]','Interpreter','none');
        set(gca,'YTickLabel',[]);
        set([hx],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        timeInd1 =find(time<495,1,'last'); %0-495sec first constant rate
        timeInd2 =find(time<765,1,'last'); %495-765 second constant rate epoch
                                       %765 onwards third constant rate
                                       %epoch
        plot([495;495],[0,1],'r','Linewidth',4); hold on;
        plot([765;765],[0,1],'r','Linewidth',4);

    subplot(2,2,3); results.KSPlot;
    subplot(2,2,2); results.plotInvGausTrans;
    subplot(2,2,4); 
    results.lambda.getSubSignal(1).plot([],{{' ''b'' ,''Linewidth'',2'}}); 
    results.lambda.getSubSignal(2).plot([],{{' ''g'' ,''Linewidth'',2'}}); 
                    v=axis; axis([v(1) v(2) 0 5]);
    hx=xlabel('time [s]','Interpreter','none');
    hy=get(gca,'YLabel');
    set([hx hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    h_legend = legend('\lambda_{const}','\lambda_{const-epoch}',...
        'Location','NorthEast');
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.05 pos(2)-.01 pos(3:4)]);
    set(h_legend,'FontSize',14)

%% Experiment 2
% EXPLICIT STIMULUS EXAMPLE - WHISKER STIMULATION/THALAMIC NEURON
% In the worksheet with analyze the stimulus effect and history effect on
% the firing of a thalamic neuron under a known stimulus consisting of
% whisker stimulation.
% Data from Demba Ba (demba@mit.edu)

%% Load the data
% clear all; 
close all; currdir = pwd;
index = strfind(currdir,'helpfiles')-1;
rootpath = currdir(1:index);

Direction=3; Neuron=1; Stim=2;
% datapath = strcat(rootpath,['data/Explicit Stimulus/Dir' num2str(Direction)...
%     '\Neuron' num2str(Neuron) '\Stim' num2str(Stim) '\']);
datapath = strcat(rootpath,['data/Explicit Stimulus/Dir' num2str(Direction)...
    '/Neuron' num2str(Neuron) '/Stim' num2str(Stim) '/']);
data=load(strcat(datapath,'trngdataBis.mat'));

time=0:.001:(length(data.t)-1)*.001;
stimData = data.t;
spikeTimes = time(data.y==1);

stim = Covariate(time,stimData./10,'Stimulus','time','s','mm',{'stim'});
baseline = Covariate(time,ones(length(time),1),'Baseline','time','s','',...
    {'constant'});

nst = nspikeTrain(spikeTimes);
nspikeColl = nstColl(nst);
cc = CovColl({stim,baseline});
trial = Trial(nspikeColl,cc);
% trial.plot;

scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
subplot(3,1,1);
nst2 = nspikeTrain(spikeTimes);
nst2.setMaxTime(21);nst2.plot;
set(gca,'ytick',[0 1]);
xlabel('');
hy=ylabel('spikes');
set(hy,'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title({'Neural Raster'},'FontWeight','bold','FontSize',16,'FontName','Arial');
set(gca, ...
  'XTick'       , 0:1:max(time), ...
  'XTickLabel'  , [],...
  'LineWidth'   , 1         );
subplot(3,1,2);
stim.getSigInTimeWindow(0,21).plot([],{{' ''k'' '}}); legend off;
set(gca,'ytick',[0 0.5 1]);
hy=ylabel('Displacement [mm]','Interpreter','none'); xlabel('');
set(hy,'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title({'Stimulus - Whisker Displacement'},'FontWeight','bold',...
    'FontSize',16,'FontName','Arial');

set(gca, ...
  'XTick'       , 0:1:max(time), ...
  'XTickLabel'  , [],...
  'YTick'       , 0:.25:1, ...
  'LineWidth'   , 1         );

subplot(3,1,3);
stim.derivative.getSigInTimeWindow(0,21).plot([],{{' ''k'' '}}); legend off;
set(gca,'ytick',[-80 0 80]);
axis([0 21 -80 80]);
hy=ylabel('Displacement Velocity [mm/s]','Interpreter','none');
hx= xlabel('time [s]','Interpreter','none');
set([hx hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title({'Displacement Velocity'},'FontWeight','bold',...
    'FontSize',16,'FontName','Arial');

set(gca, ...
  'XTick'       , 0:1:max(time), ...
  'YTick'       , -80:40:80, ...
  'LineWidth'   , 1         );


%%
% Fit a constant baseline and Find Stimulus Lag
% We fit a constant rate (Poisson) model to the data and use the look at the
% cross-covariance function of between the stimulus and the fit
% residual to determine the appropriate lag for the stimulus.
clear c; close all;
selfHist = [] ; NeighborHist = []; sampleRate = 1000; 
c{1} = TrialConfig({{'Baseline','constant'}},sampleRate,selfHist,NeighborHist); 
c{1}.setName('Baseline');
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial,cfgColl,0);

% Find Stimulus Lag (look for peaks in the cross-covariance function less
% than 1 second
scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
                
subplot(7,2,[1 3 5])
results.Residual.xcov(stim).windowedSignal([0,1]).plot;

ylabel('');
[m,ind,ShiftTime] = max(results.Residual.xcov(stim).windowedSignal([0,1]));
title(['Cross Correlation Function - Peak at t=' num2str(ShiftTime) ' sec'],'FontWeight','bold',...
            'FontSize',12,...
            'FontName','Arial'); 
hold on;
h=plot(ShiftTime,m,'ro','Linewidth',3);
set(h, 'MarkerFaceColor',[1 0 0], 'MarkerEdgeColor',[1 0 0]);
hx=xlabel('Lag [s]','Interpreter','none');
set(hx,'FontName', 'Arial','FontSize',12,'FontWeight','bold');

           
%Allow for shifts of less than 1 second
stim = Covariate(time,stimData,'Stimulus','time','s','V',{'stim'});
stim = stim.shift(ShiftTime);
baseline = Covariate(time,ones(length(time),1),'Baseline','time','s','',...
    {'\mu'});

nst = nspikeTrain(spikeTimes);
nspikeColl = nstColl(nst);
cc = CovColl({stim,baseline});
trial2 = Trial(nspikeColl,cc);

%% Compare constant rate model with model including stimulus effect
% Addition of the stimulus improves the fits in terms of the KS plot and
% the making the rescaled ISIs less correlated. The Point Process Residula
% also looks more "white"
clear c;
selfHist = [] ; NeighborHist = []; sampleRate = 1000; 
c{1} = TrialConfig({{'Baseline','\mu'}},sampleRate,selfHist,...
    NeighborHist); 
c{1}.setName('Baseline');
c{2} = TrialConfig({{'Baseline','\mu'},{'Stimulus','stim'}},...
    sampleRate,selfHist,NeighborHist);
c{2}.setName('Baseline+Stimulus');
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial2,cfgColl,0);
% results.plotResults;

%% History Effect
% Determine the best history effect model using AIC, BIC, and KS statistic
sampleRate=1000;
delta=1/sampleRate*1; 
maxWindow=1; numWindows=32;
windowTimes =unique(round([0 logspace(log10(delta),...
    log10(maxWindow),numWindows)]*sampleRate)./sampleRate);
results =Analysis.computeHistLagForAll(trial2,windowTimes,...
    {{'Baseline','\mu'},{'Stimulus','stim'}},'BNLRCG',0,sampleRate,0);

KSind = find(results{1}.KSStats.ks_stat == min(results{1}.KSStats.ks_stat));
AICind = find((results{1}.AIC(2:end)-results{1}.AIC(1))== ...
               min(results{1}.AIC(2:end)-results{1}.AIC(1))) +1;
BICind = find((results{1}.BIC(2:end)-results{1}.BIC(1))== ...
               min(results{1}.BIC(2:end)-results{1}.BIC(1))) +1;
if(AICind==1)
    AICind=inf; 
end
if(BICind==1)
    BICind=inf; %sometime BIC is non-decreasing and the index would be 1
end
windowIndex = min([AICind,BICind]) %use the minimum order model
Summary = FitResSummary(results);
% Summary.plotSummary;


clear c;
if(windowIndex>1)
    selfHist = windowTimes(1:windowIndex+1);
else
    selfHist = [];
end
NeighborHist = []; sampleRate = 1000; 
%
% figure;
subplot(7,2,2);
x=0:length(windowTimes)-1;
plot(x,results{1}.KSStats.ks_stat,'.-'); axis tight; hold on;
plot(x(windowIndex),results{1}.KSStats.ks_stat(windowIndex),'r*');

 set(gca,'XTick', 0:5:results{1}.numResults-1,'XTickLabel',[],...
     'TickLength', [.02 .02] , ...
  'XMinorTick', 'on','LineWidth'   , 1); 

hy=ylabel('KS Statistic'); 
set(hy,'FontName', 'Arial','FontSize',12,'FontWeight','bold');
dAIC = results{1}.AIC-results{1}.AIC(1);
 title({'Model Selection via change'; 'in KS Statistic, AIC, and BIC'},...
     'FontWeight','bold',...
            'FontSize',12,...
            'FontName','Arial');
         
subplot(7,2,4); plot(x,dAIC,'.-');
set(gca,'XTick', 0:5:results{1}.numResults-1,'XTickLabel',[],...
     'TickLength', [.02 .02] , ...
  'XMinorTick', 'on','LineWidth'   , 1); 
hy=ylabel('\Delta AIC');axis tight; hold on;
set(hy,'FontName', 'Arial','FontSize',12,'FontWeight','bold');
plot(x(windowIndex),dAIC(windowIndex),'r*');
dBIC = results{1}.BIC-results{1}.BIC(1);

subplot(7,2,6); plot(x,dBIC,'.-');
hy=ylabel('\Delta BIC'); axis tight; hold on;

plot(x(windowIndex),dBIC(windowIndex),'r*');
hx=xlabel('# History Windows, Q');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
set(gca, ...
  'TickLength'  , [.02 .02] , ...
  'XMinorTick'  , 'on'      , ...
  'XTick'       , 0:5:results{1}.numResults-1, ...
  'LineWidth'   , 1         );



% Compare Baseline, Baseline+Stimulus Model, Baseline+History+Stimulus
% Addition of the history effect yields a model that falls within the 95%
% CI of the KS plot.

c{1} = TrialConfig({{'Baseline','\mu'}},sampleRate,[],NeighborHist);
c{1}.setName('Baseline');
c{2} = TrialConfig({{'Baseline','\mu'},{'Stimulus','stim'}},...
                    sampleRate,[],[]); 
c{2}.setName('Baseline+Stimulus');
c{3} = TrialConfig({{'Baseline','\mu'},{'Stimulus','stim'}},...
                    sampleRate,windowTimes(1:windowIndex),[]);
c{3}.setName('Baseline+Stimulus+Hist');
cfgColl= ConfigColl(c);
results = Analysis.RunAnalysisForAllNeurons(trial2,cfgColl,0);
%results.plotResults;
%
results.lambda.setDataLabels({'\lambda_{const}','\lambda_{const+stim}',...
    '\lambda_{const+stim+hist}'});
subplot(7,2,[9 11 13]); results.KSPlot;
subplot(7,2,[10 12 14]); results.plotCoeffs; legend off;


%% Example 3 - PSTH Data

% Generate a known Conditional Intensity Function
% We generated a known conditional intensity function (rate function) and
% generate distinct realizations of point processes consistent with this
% rate function. We use the method of thinning to simulate a point process.
clear all;
close all;
delta = 0.001;
Tmax = 1;
time = 0:delta:Tmax;
f=2;
mu = -3; 

tempData = 1*sin(2*pi*f*time)+mu; %lambda >=0
lambdaData = exp(tempData)./(1+exp(tempData))*(1/delta);
lambda = Covariate(time,lambdaData, '\lambda(t)','time','s',...
    'spikes/sec',{'\lambda_{1}'},{{' ''b'', ''LineWidth'' ,2'}});
numRealizations = 20; 
spikeCollSim = CIF.simulateCIFByThinningFromLambda(lambda,numRealizations);


scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(2,2,3);spikeCollSim.plot; 
set(gca,'YTick',0:5:numRealizations,'YTickLabel',0:5:numRealizations);
title({[num2str(numRealizations) ' Simulated Point Process Sample Paths']},...
    'FontWeight','bold','Fontsize',14,'FontName','Arial');
xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');

subplot(2,2,1);lambda.plot; 
title({'Simulated Conditional Intensity Function (CIF)'},...
    'FontWeight','bold','FontSize',14,'FontName','Arial');
xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
hy=get(gca,'YLabel');
set(hy,'FontName', 'Arial','FontSize',14,'FontWeight','bold');
            
fileLocation = which('nSTAT_Install'); 
index = strfind(fileLocation,'nSTAT_Install.m')-1;
nSTATDir =fileLocation(1:index);

rootDir = [nSTATDir 'data' filesep 'PSTH' filesep];
filename = 'Results.mat';
x=load(strcat(rootDir,filename));
numTrials = x.Results.Data.Spike_times_STC.balanced_SUA.Nr_trials;
cellNum=6; clear nst;
for i=1:numTrials
    spikeTimes{i}=x.Results.Data.Spike_times_STC.balanced_SUA.spike_times{1,i,cellNum};
    nst{i} = nspikeTrain(spikeTimes{i});
    nst{i}.setName(num2str(cellNum));
end

spikeCollReal1=nstColl(nst);
spikeCollReal1.setMinTime(0); spikeCollReal1.setMaxTime(2);
subplot(2,2,2);spikeCollReal1.plot;  set(gca,'YTick',0:2:numTrials,...
    'YTickLabel',0:2:numTrials);
%set(gca,'xtick',[0:.5:2],'xtickLabel',{'0','0.5','1','1.5','2'});
xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
title('Response to Moving Visual Stimulus (Neuron 6)',...
    'FontWeight','bold','Fontsize',14,'FontName','Arial');

cellNum=1; clear nst;
for i=1:numTrials
    spikeTimes{i}=x.Results.Data.Spike_times_STC.balanced_SUA.spike_times{1,i,cellNum};
    nst{i} = nspikeTrain(spikeTimes{i});
    nst{i}.setName(num2str(cellNum));
end

spikeCollReal2=nstColl(nst);
spikeCollReal2.setMinTime(0); spikeCollReal2.setMaxTime(2);
subplot(2,2,4);spikeCollReal2.plot; 
set(gca,'YTick',0:2:numTrials,'YTickLabel',0:2:numTrials);
%set(gca,'xtick',[0:.5:2],'xtickLabel',{'0','0.5','1','1.5','2'});
xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
title('Response to Moving Visual Stimulus (Neuron 1)','FontWeight',...
    'bold','Fontsize',14,'FontName','Arial');


%% Estimate the PSTH with 50ms windows
% 
close all;

scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

binsize = .05; %50ms window
psth    = spikeCollSim.psth(binsize);
psthGLM = spikeCollSim.psthGLM(binsize);
true = lambda; %rate*delta = expected number of arrivals per bin
subplot(2,3,4);

h1=true.plot([],{{' ''b'',''Linewidth'',4'}});
h3=psthGLM.plot([],{{' ''k'',''Linewidth'',4'}});
h2=psth.plot([],{{' ''rx'',''Linewidth'',4'}});

xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
ylabel('[spikes/sec]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');

legend off;
h_legend=legend([h1(1) h2(1)  h3(1)],'true','PSTH','PSTH_{glm}');
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.005 pos(2)+.095 pos(3:4)]);


%
subplot(2,3,1);spikeCollSim.plot; 
set(gca,'YTick',0:2:spikeCollSim.numSpikeTrains,'YTickLabel',0:2:spikeCollSim.numSpikeTrains);
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');

subplot(2,3,5); 
binsize = .05; %50ms window
psthReal1    = spikeCollReal1.psth(binsize);
psthGLMReal1 = spikeCollReal1.psthGLM(binsize);%,[],[],[],[],[],1000);

h3=psthGLMReal1.plot([],{{' ''k'',''Linewidth'',4'}});
h2=psthReal1.plot([],{{' ''rx'',''Linewidth'',4'}});
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('[spikes/sec]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');

h_legend=legend([h2(1)  h3(1)],'PSTH','PSTH_{glm}');
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.005 pos(2)+.07 pos(3:4)]);
subplot(2,3,2); spikeCollReal1.plot;  
set(gca,'YTick',0:2:spikeCollReal2.numSpikeTrains,'YTickLabel',0:2:spikeCollReal2.numSpikeTrains);
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
subplot(2,3,6); 
psthReal2    = spikeCollReal2.psth(binsize);
psthGLMReal2 = spikeCollReal2.psthGLM(binsize);%,[],[],[],[],[],1000);
h3=psthGLMReal2.plot([],{{' ''k'',''Linewidth'',4'}});
h2=psthReal2.plot([],{{' ''rx'',''Linewidth'',4'}});
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('[spikes/sec]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');


h_legend=legend([h2(1)  h3(1)],'PSTH','PSTH_{glm}');
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.005 pos(2)+.07 pos(3:4)]);
subplot(2,3,3); spikeCollReal2.plot;  
set(gca,'YTick',0:2:spikeCollReal2.numSpikeTrains,'YTickLabel',0:2:spikeCollReal2.numSpikeTrains);
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');



%% Example 3b - SSGLM Example 
% Example of estimating with-in and across trial dynamics
% Methods from:
% G. Czanner, U. T. Eden, S. Wirth, M. Yanike, 
% W. A. Suzuki, and E. N. Brown, "Analysis of between-trial and 
% within-trial neural spiking dynamics.," Journal of neurophysiology, 
% vol. 99, no. 5, pp. 2672?2693, May. 2008.

close all; 
clear all;
% set(0,'DefaultFigureRenderer','ZBuffer')
delta = 0.001; Tmax = 1;
time = 0:delta:Tmax;
Ts=.001;
numRealizations = 50; %Each realization corresponds to a distinct trial

for i=1:numRealizations
    % The within trial dynamics are sinusoidal 
    % For each trial the stimulus effect increases 
    f=2; b1(i)=3*((i)/numRealizations);b0=-3; 
    u = sin(2*pi*f*time);
    e = zeros(length(time),1);   %No Ensemble input

    stim=Covariate(time',u,'Stimulus','time','s','Voltage',{'sin'});
    ens =Covariate(time',e,'Ensemble','time','s','Spikes',{'n1'});

    mu=b0;
    histCoeffs=[-4 -1 -.5]; 
    H=tf(histCoeffs,[1],Ts,'Variable','z^-1');
    
    S=tf([b1(i)],1,Ts,'Variable','z^-1');
    E=tf([0],1,Ts,'Variable','z^-1');
    simTypeSelect='binomial'; %Parameters are used to compute 
                              %binomial conditional intensity function
                              %

    % Obtain a realization of the point process with the current
    % stimulus and history effect
    [sC, lambdaTemp]=CIF.simulateCIF(mu,H,S,E,stim,ens,1,simTypeSelect);

    if(i==1)
        lambda=lambdaTemp; %Store the conditional intensity function
    else
        lambda = lambda.merge(lambdaTemp); %Add it to the other realizations
    end
    
    nst{i} = sC.getNST(1);             %get the neural spikeTrain from the collection
    nst{i} = nst{i}.resample(1/delta); %make sure that it is sampled at the current samplerate
end

spikeColl = nstColl(nst); %Create a collection of the spike trains across trials

%% Summarize Simulated Data
close all;
scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

%Plot the raster
subplot(3,2,[3 4]); spikeColl.plot; 
set(gca,'ytick',0:10:numRealizations,'ytickLabel',0:10:numRealizations); 
set(gca,'xtick',0:.1:Tmax,'xtickLabel',0:.1:Tmax); xlabel('');
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
title('Simulated Neural Raster','Interpreter','none','FontName', 'Arial',...
    'Fontsize',14,'FontWeight','bold');

% Plot the actual stimulus effect (not including history)
% The CIF including the history effect is stored in the lambda Covariate
% above


stimData = exp(b0 + u'*b1);
if(strcmp(simTypeSelect,'binomial'))
    stimData = stimData./(1+stimData);
end

%Plot the trial dependence
subplot(3,2,1); plot(time,u,'k','LineWidth',3); 
% xlabel('time [s]');ylabel('stimulus');
xlabel('time [s]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Stimulus','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
title('Within Trial Stimulus','Interpreter','none','FontName', 'Arial',...
    'Fontsize',14,'FontWeight','bold');

subplot(3,2,2); plot(1:length(b1),b1,'k','LineWidth',3);
xlabel('Trial [k]','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
ylabel('Stimulus Gain','Interpreter','none','FontName', 'Arial','Fontsize',...
    12,'FontWeight','bold');
title('Across Trial Stimulus Gain','Interpreter','none','FontName',...
    'Arial','Fontsize',14,'FontWeight','bold');

subplot(3,2,[5 6]); 
imagesc(stimData'./delta);  set(gca, 'YDir','normal');
set(gca,'xtick',0:100:Tmax/delta,'xtickLabel',0:.1:Tmax);
set(gca,'ytick',0:10:numRealizations,'ytickLabel',0:10:numRealizations);
xlabel('time [s]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
ylabel('Trial [k]','Interpreter','none','FontName', 'Arial',...
    'Fontsize',12,'FontWeight','bold');
title('True Conditional Intensity Function','Interpreter',...
    'none','FontName', 'Arial','Fontsize',14,'FontWeight','bold');


axis tight;

%% Estimation of the Stimulus Response

% Create the covariates that will be used for the GLM regression
stim = Covariate(time,sin(2*pi*f*time),'Stimulus','time','s','V',{'stim'});
baseline = Covariate(time,ones(length(time),1),'Baseline','time','s','',...
                    {'constant'});

% Specify the windows of the history coefficients to be estimated
windowTimes=[0:.001:.003];
% Number of bins to discrtize time into (used both for the PSTH and for
% thec
% SSGLM model.
numBasis = 25;

spikeColl.resample(1/delta); % Enforce sampleRate
spikeColl.setMaxTime(Tmax);  % Make all spikeTrains end at time Tmax


dN=spikeColl.dataToMatrix';  % Convert the spikeTrains into a matrix
                             % of 1's and 0's corresponding to the presence
                             % or absense of a spike in each time window.
dN(dN>1)=1;                  % One should sample finely enough so there is 
                             % one spike per bin. Here we make sure that
                             % this is the case regardless of the
                             % sampleRate
                             
% The width of each rectangular basis pulse is determined by Tmax and by the
% number of basis pulses to use.
basisWidth=(spikeColl.maxTime-spikeColl.minTime)/numBasis; 

if(simTypeSelect==0)
    fitType='binomial';
else
    fitType='poisson';
end
if(strcmp(fitType,'binomial'))
    Algorithm = 'BNLRCG';   % BNLRCG - faster Truncated, L-2 Regularized,
                            % Binomial Logistic Regression with Conjugate
                            % Gradient Solver by Demba Ba (demba@mit.edu).
else
    Algorithm = 'GLM';      % Standard Matlab GLM (Can be used for binomial or
                            % or Poisson CIFs 
end
    
% Use the values obtained from a PSTH to initialize the SSGLM filter
[psthSig, ~, psthResult] =spikeColl.psthGLM(basisWidth,windowTimes,fitType);
gamma0=psthResult.getHistCoeffs';%+.1*randn(size(histCoeffs));
gamma0(isnan(gamma0))=-5; % Depending on the amount of data the 
                          % the psth may not identify all parameters
                          % Just make sure that the estimates are real
                          % numbers
                          
x0=psthResult.getCoeffs;  %The initial estimate for the SSGLM model

% Estimate the variance within each time bin across trials
numVarEstIter=10;
Q0 = spikeColl.estimateVarianceAcrossTrials(numBasis,windowTimes,...
    numVarEstIter,fitType);
A=eye(numBasis,numBasis);
delta = 1/spikeColl.sampleRate;

%% Run the SSGLM Filter
CompilingHelpFile=1;
    % Commented out to speed up help file creation ... 
    if(~CompilingHelpFile)
        Q0d=diag(Q0);
        neuronName = psthResult.neuronNumber;
        [xK,WK, WkuFinal,Qhat,gammahat,fitResults,stimulus,stimCIs,logll,...
            QhatAll,gammahatAll,nIter]=DecodingAlgorithms.PPSS_EMFB(A,Q0d,x0,...
            dN,fitType,delta,gamma0,windowTimes, numBasis,neuronName);

        fR = fitResults.toStructure;
        psthR = psthResult.toStructure;
    end
% save SSGLMExampleData psthR fR xK WK WkuFinal Qhat gammahat fitResults stimulus stimCIs logll QhatAll gammahatAll nIter;
%%
load SSGLMExampleData;
fitResults = FitResult.fromStructure(fR);
psthResult = FitResult.fromStructure(psthR);

%%
t=psthResult.mergeResults(fitResults);
%t.plotResults; %Compare the results with the PSTH Model
t.lambda.setDataLabels({'\lambda_{PSTH}','\lambda_{SSGLM}'});
scrsz = get(0,'ScreenSize');
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);
subplot(2,2,1); t.KSPlot;
subplot(2,2,2); t.plotResidual;
subplot(2,2,3); t.plotInvGausTrans;
subplot(2,2,4); t.plotSeqCorr;

S=FitResSummary(t);
dAIC=diff(S.AIC)
dBIC=diff(S.BIC)
dKS =diff(S.KSStats); 


%%
close all;
% Generate the actual stimulus effect
minTime=0; maxTime = Tmax;
stimData = stim.data*b1;
if(strcmp(fitType,'poisson'))
    actStimEffect=exp(stimData + b0)./delta;
elseif(strcmp(fitType,'binomial'))
    actStimEffect=exp(stimData + b0)./(1+exp(stimData + b0))./delta;
end
%     

% Generate the basis function so that the estimated effect can be plotted
% at the same temporal resolution as the theoretical effect
 if(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,minTime,...
        maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 end

% Generate the estimated stimulus effect
if(strcmp(fitType,'poisson'))
    estStimEffect=exp(basisMat*xK)./delta;
elseif(strcmp(fitType,'binomial'))
    estStimEffect=exp(basisMat*xK)./(1+exp(basisMat*xK))./delta;
end


scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

% Plot the actual and estimated stimulus effect as a function of trial and
% time
subplot(3,1,[1 2 3]);
lighting gouraud
surf((1:length(b1))',stim.time,actStimEffect,'FaceAlpha',0.1,...
    'EdgeAlpha',0.1,'AlphaData',0.1); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
hz=zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

surf((1:length(b1))',stim.time,estStimEffect(:,1:length(b1)),...
    'FaceAlpha',0.5,'EdgeAlpha',0.1,'AlphaData',0.5); %xlabel('Trial [k]'); ylabel('time [s]'); zlabel('Stimulus Effect');
set(gca,'YDir','reverse');
set(gca,'ytick',0:.1:Tmax,'ytickLabel',0:.1:Tmax);

title('SSGLM Estimated vs. Actual Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');

close all;
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.4 scrsz(4)*.8]);

% The actual stimulus effect
subplot(3,1,1);
lighting gouraud
mesh((1:length(b1))',stim.time,actStimEffect); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
% title('True Stimulus Effect');
title('True Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');
set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);



% The PSTH estimate
subplot(3,1,2);
lighting gouraud
mesh((1:length(b1))',stim.time,repmat(psthSig.data, [1 numRealizations])); 
hx=xlabel('Trial [k]'); hy=ylabel('time [s]'); 
hz=zlabel('Stimulus Effect [spikes/sec]'); hold all;
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
% title('PSTH Estimated Stimulus Effect');
title('PSTH Estimated Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');

set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
CLIM = [min(min(stimData./delta)) max(max(stimData./delta))];
view(gca,[90 -90]);

% The SSGLM estimated stimulus effect
subplot(3,1,3);
lighting gouraud
mesh((1:length(b1))',stim.time,estStimEffect); 
xlabel('Trial [k]'); ylabel('time [s]'); 
zlabel('Stimulus Effect [spikes/sec]'); hold all;
hx=get(gca,'XLabel');  hy=get(gca,'YLabel'); hz=get(gca,'ZLabel');
set([hx hy hz],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
           
% title('SSGLM Estimated Stimulus Efferct');
title('SSGLM Estimated Stimulus Effect','FontWeight','bold',...
            'Fontsize',14,...
            'FontName','Arial');
set(gca,'xtick',[],'xtickLabel',[]); 
set(gca,'ytick',[],'ytickLabel',[]);
set(gca, 'YDir','normal')
view(gca,[90 -90]);



%% Compare differences across trials 
close all;
   minTime=0; maxTime = Tmax;
% Generate the basis function so that the estimated effect can be plotted
% at the same temporal resolution as the theoretical effect
 if(~isempty(numBasis))
    basisWidth = (maxTime-minTime)/numBasis;
    sampleRate=1/delta;
    unitPulseBasis=nstColl.generateUnitImpulseBasis(basisWidth,...
        minTime,maxTime,sampleRate);
    basisMat = unitPulseBasis.data;
 end


% close all;

t0=0; tf=Tmax;
[spikeRateBinom, ProbMat,sigMat]=DecodingAlgorithms.computeSpikeRateCIs(xK,...
    WkuFinal,dN,t0,tf,fitType,delta,gammahat,windowTimes);

lt=find(sigMat(1,:)==1,1,'first');
display(['The learning trial (compared to the first trial) is trial #' ...
    num2str(find(sigMat(1,:)==1,1,'first'))]);
scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.8]);

subplot(2,3,1);
spikeRateBinom.setName(['(' num2str(Tmax) '-0)^-1*\Lambda(0,' ...
    num2str(Tmax) ')']);
spikeRateBinom.plot([],{{' ''k'',''Linewidth'',4'}});
% e = Events(lt,{''});
% e.plot;
v=axis;
plot(lt*[1;1],v(3:4),'r','Linewidth',2);
hx=xlabel('Trial [k]','Interpreter','none'); hold all;
hy=ylabel('Average Firing Rate [spikes/sec]','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title(['Learning Trial:' num2str(lt)],'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
        


h=subplot(2,3,[2 3 5 6]);
K=size(dN,1);
colormap(flipud(gray));
imagesc(ProbMat); hold on;
for k=1:K
    for m=(k+1):K
        if(sigMat(k,m)==1)
            plot3(m,k,1,'r*'); hold on;
        end
    end
end
%
set(h,'XAxisLocation','top','YAxisLocation','right');
hx=xlabel('Trial Number','Interpreter','none'); hold all;
hy=ylabel('Trial Number','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

subplot(2,3,4)
stim1 = Covariate(time, basisMat*stimulus(:,1),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,1,:)));
stim1.setConfInterval(temp);
stimlt = Covariate(time, basisMat*stimulus(:,lt),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt,:)));
temp.setColor('r');
stimlt.setConfInterval(temp);
stimltm1 = Covariate(time, basisMat*stimulus(:,lt-1),'Trial1','time','s',...
    'spikes/sec');
temp = ConfidenceInterval(time, basisMat*squeeze(stimCIs(:,lt-1,:)));
temp.setColor('r');
stimltm1.setConfInterval(temp);

% figure;
h1=stim1.plot([],{{' ''k'',''Linewidth'',4'}}); hold all;
h2=stimlt.plot([],{{' ''r'',''Linewidth'',4'}});
hx=xlabel('time [s]','Interpreter','none'); hold all;
hy=ylabel('Firing Rate [spikes/sec]','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

title({'Learning Trial Vs. Baseline Trial';'with 95% CIs'},'FontWeight','bold',...
            'Fontsize',12,...
            'FontName','Arial');
h_legend=legend([h1(1) h2(1)],'\lambda_{1}(t)',['\lambda_{' num2str(lt) '}(t)']);
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.03 pos(2)+.01 pos(3:4)]);

%% Example 4 - HIPPOCAMPAL PLACE CELL - RECEPTIVE FIELD ESTIMATION 
% Estimation of receptive fields of neurons is a very common data analysis problem in neuroscience.
% Here we use the nSTAT software to perform an estimation of the receptive fields of hippocampal
% place cells using a bivariate Gaussian model and Zernike polynomials. The number of zernike polynomials 
% is based on "An Analysis of Hippocampal Spatio-Temporal Representations Using a Bayesian Algorithm for Neural
% Spike Train Decoding" Barbieri et. al 2005. The data used herein in was
% provided by Dr. Ricardo Barbieri on 2/28/2011.
%
% *Author*: Iahn Cajigas 
%
% *Date*: 3/1/2011
%%

    
%% Example Data
% The x and y coordinates of a freely foraging rat in a circular environment (70cm in diameter and 30cm high walls) and a fixed visual cue. 
% The x and y coordinates at the time when a spike was observed are marked
% in red. The position coordinates have been normalized to be between -1
% and 1 to allow to simplify the analysis. 
    close all;
    load(strcat('PlaceCellDataAnimal1.mat'));    
    exampleCell = [2 21 25 49];
%     exampleCell = 1:length(neuron);
%     figure(1);
    scrsz = get(0,'ScreenSize');
    h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.9]);

    for i=1:length(exampleCell)
        subplot(2,2,i);
        h1=plot(x,y,'b','Linewidth',.5); hold on;
        h2=plot(neuron{exampleCell(i)}.xN,neuron{exampleCell(i)}.yN,'r.',...
            'MarkerSize',7);
        hx=xlabel('X Position'); hy=ylabel('Y Position'); 
%         title(['Animal#1, Cell#' num2str(exampleCell(i))]);
        title(['Cell#' num2str(exampleCell(i))],'FontWeight','bold',...
            'Fontsize',12,'FontName','Arial');
        set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
        set(gca,'xTick',-1:.5:1,'yTick',-1:.5:1); axis square;
        if(i==4)
            h_legend = legend([h1 h2],'Animal Path',...
                'Location at time of spike');
            pos = get(h_legend,'position');
            set(h_legend, 'position',[pos(1)+.09 pos(2)+.06 pos(3:4)]);
        end
    end
    

 %% Analyze All Cells 
numAnimals=2;
CompilingHelpFile=1;
if(~CompilingHelpFile)
    for n=1:numAnimals
        % load the data
        clear x y neuron time nst tc tcc z;
        load(strcat('PlaceCellDataAnimal',num2str(n),'.mat'));

        % Create the spikeTrains for each cell
        for i=1:length(neuron)
            nst{i} = nspikeTrain(neuron{i}.spikeTimes);
        end


        % Convert to polar coordinates
        [theta,r] = cart2pol(x,y);


        % Evaluate the Zernike Polynomials 
        % Number of polynomials from "An Analysis of Hippocampal
        % Spatio-Temporal Representations Using a Bayesian Algorithm for Neural
        % Spike Train Decoding" Barbieri et. al 2005
        cnt=0;
        for l=0:3
           for m=-l:l 
               if(~any(mod(l-m,2))) % otherwise the polynomial = 0
                cnt = cnt+1;
                z(:,cnt) = zernfun(l,m,r,theta,'norm');
                % zernfun by Paul Fricker
                % http://www.mathworks.com/matlabcentral/fileexchange/7687
               end
           end
        end

        % Data sampled at 30 Hz but just to be sure
        delta=min(diff(time));
        sampleRate = round(1/delta);
        % Define Covariates for the analysis
        baseline = Covariate(time,ones(length(x),1),'Baseline','time','s','',...
                            {'mu'});
        zernike  = Covariate(time,z,'Zernike','time','s','m',{'z1','z2','z3',...
                            'z4','z5','z6','z7','z8','z9','z10'});
        gaussian = Covariate(time,[x y x.^2 y.^2 x.*y],'Gaussian','time',...
                            's','m',{'x','y','x^2','y^2','x*y'});
        covarColl = CovColl({baseline,gaussian,zernike});

        % Create the trial structure
        spikeColl = nstColl(nst);
        trial     = Trial(spikeColl,covarColl);


        % Define how we want to analyze the data
        tc{1} = TrialConfig({{'Baseline','mu'},{'Gaussian',...
                            'x','y','x^2','y^2','x*y'}},sampleRate,[]); 
        tc{1}.setName('Gaussian');
        tc{2} = TrialConfig({{'Zernike' 'z1','z2','z3','z4','z5','z6',...
                            'z7','z8','z9','z10'}},sampleRate,[]); 
        tc{2}.setName('Zernike');
        tcc = ConfigColl(tc);

        % Perform Analysis (Commented to since data already saved)
         results =Analysis.RunAnalysisForAllNeurons(trial,tcc,0);

        % Save results
            resStruct =FitResult.CellArrayToStructure(results);
            filename = ['PlaceCellAnimal' num2str(n) 'Results'];
            save(filename,'resStruct');
    end
end
%% View Summary Statistics
% Note the Zernike Polynomials yield better fits in terms of decreased KS
% Statistics (less deviation from the 45 degree line), reduced AIC and
% reduced BIC across the majority of cells and for both animals
clear Summary;
numAnimals =2;
 
for n=1:numAnimals
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    Summary{n} = FitResSummary(results);
%     Summary{n}.plotSummary;
end    
%%
close all;
scrsz = get(0,'ScreenSize');
h=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.6 scrsz(4)*.5]);
subplot(1,3,1);
maxLength = max([Summary{1}.numNeurons,Summary{2}.numNeurons]);
dKS = nan(maxLength, 2);
dKS(1:Summary{1}.numNeurons,1) = (Summary{1}.KSStats(:,1)-Summary{1}.KSStats(:,2)) ;
dKS(1:Summary{2}.numNeurons,2) = (Summary{2}.KSStats(:,1)-Summary{2}.KSStats(:,2)) ;

boxplot(dKS ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); 
title('\Delta KS Statistic','FontWeight','bold','FontSize',14,...
    'FontName','Arial');
                  

subplot(1,3,2);
dAIC = nan(maxLength, 2);
dAIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffAIC(1);
dAIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffAIC(1);

boxplot(dAIC ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); 
title('\Delta AIC','FontWeight','bold','FontSize',14,'FontName','Arial');
                  

subplot(1,3,3); 
dBIC = nan(maxLength, 2);
dBIC(1:Summary{1}.numNeurons,1) = Summary{1}.getDiffBIC(1);
dBIC(1:Summary{2}.numNeurons,2) = Summary{2}.getDiffBIC(1);

boxplot(dBIC ,{'Animal 1', 'Animal 2'},'labelorientation','inline'); %ylabel('\Delta BIC'); %xticklabel_rotate([],45,[],'Fontsize',6);
title('\Delta BIC','FontWeight','bold','FontSize',14,'FontName','Arial');

%  close all;
    

%% Visualize the results 
close all;
% Define a grid 
[x_new,y_new]=meshgrid(-1:.01:1); %define new x and y
y_new = flipud(y_new); x_new = fliplr(x_new);
[theta_new,r_new] = cart2pol(x_new,y_new);

%Data for the gaussian fit 
newData{1} =ones(size(x_new));
newData{2} =x_new; newData{3} =y_new;
newData{4} =x_new.^2; newData{5} =y_new.^2;
newData{6} =x_new.*y_new;


% Zernike polynomials only defined on the unit disk
idx = r_new<=1;
zpoly = cell(1,10);
cnt=0;
for l=0:3
   for m=-l:l 
       if(~any(mod(l-m,2)))
        cnt = cnt+1;
        temp = nan(size(x_new));
        temp(idx) = zernfun(l,m,r_new(idx),theta_new(idx),'norm');
        zpoly{cnt} = temp;
       end
   end
end



for n=1:numAnimals 
    
    clear lambdaGaussian lambdaZernike;
    load(strcat('PlaceCellDataAnimal',num2str(n),'.mat'));
    resData=load(strcat('PlaceCellAnimal',num2str(n),'Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    
    for i=1:length(neuron)
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end

   
    
    
    % Plot the receptive fields
    for i=1:length(neuron)
        % 3d plot of an example place field
        

        % 2d plot of all the cell's fields
        if(n==1)
            h4=figure(4);
            colormap('jet');
            if(i==1)
                tb=annotation(h4,'textbox',...
                    [0.283261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Gaussian Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(7,7,i); 
        elseif(n==2)
            h6=figure(6);
            colormap('jet');
            if(i==1)
                annotation(h6,'textbox',...
                    [0.283261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Gaussian Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaGaussian{i}), shading interp
        axis square; set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');

        if(n==1)
            h5=figure(5);
            colormap('jet');
            if(i==1)
                annotation(h5,'textbox',...
                    [0.303261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Zernike Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle','none'); hold on;
                
            end
            subplot(7,7,i); 
        elseif(n==2)
            h7=figure(7);
            colormap('jet');
            if(i==1)
               annotation(h7,'textbox',...
                    [0.303261904761904 0.928571428571418 ...
                    0.392857142857143 0.0595238095238095],...
                    'String',{['Zernike Place Fields - Animal#' ...
                    num2str(n)]},'FitBoxToText','on','Fontsize',11,...
                    'FontName','Arial','FontWeight','bold','LineStyle',...
                    'none','HorizontalAlignment','center'); hold on;
            end
            subplot(6,7,i);
        end
        pcolor(x_new,y_new,lambdaZernike{i}), shading interp
        axis square; 
        set(gca,'xtick',[],'ytick',[]);
        set(gca, 'Box'         , 'off');
    end

  
end


%%
    clear lambdaGaussian lambdaZernike;
    load(strcat('PlaceCellDataAnimal1.mat'));
    resData=load(strcat('PlaceCellAnimal1Results.mat'));
    results = FitResult.fromStructure(resData.resStruct);
    
    for i=1:length(neuron)
        % Evaluate our fits using the new data and the estimated parameters
        lambdaGaussian{i} = results{i}.evalLambda(1,newData);
        lambdaZernike{i} =  results{i}.evalLambda(2,zpoly);
    end

    
    
%     h1=plot(x,y,'b');
%     h2=plot(x,y,'g');
    %
    exampleCell = 25;
%     figure(8);
%     plot(x,y,'b',neuron{exampleCell}.xN,neuron{exampleCell}.yN,'r.');
%     xlabel('x'); ylabel('y'); 
%     title(['Animal#1, Cell#' num2str(exampleCell)]);
%     
    close all;
    h9=figure(9);
    h_mesh = mesh(x_new,y_new,lambdaGaussian{exampleCell},'AlphaData',0);
    get(h_mesh,'AlphaData');
    set(h_mesh,'FaceAlpha',0.2,'EdgeAlpha',0.2,'EdgeColor','b');
    hold on;
    h_mesh = mesh(x_new,y_new,lambdaZernike{exampleCell},'AlphaData',0);
    get(h_mesh,'AlphaData');
    set(h_mesh,'FaceAlpha',0.2,'EdgeAlpha',0.2,'EdgeColor','g');

    
%     h_legend=legend('\lambda_{Gaussian}','\lambda_{Zernike}');
%     set(h_legend,'FontSize',20);
    plot(x,y,neuron{exampleCell}.xN,neuron{exampleCell}.yN,'r.');
    axis tight square;
    xlabel('x position'); ylabel('y position');
    title(['Animal#1, Cell#' num2str(exampleCell)],'FontWeight','bold',...
        'Fontsize',12,'FontName','Arial');
    hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');


    
%% Example 5 - STIMULUS DECODING
% In this example we show how to decode a univariate and a bivariate
% stimulus based on a point process observations using nSTAT. Even though 
% due to the simulated nature of the data, we know the exact condition 
% intensity function, we estimate the parameters before moving on to the 
% decoding stage.
%% Generate the conditional Intensity Function

    close all; clear all;
    delta = 0.001; Tmax = 1;
    time = 0:delta:Tmax;
    numRealizations = 20;
    f=2; b1=randn(numRealizations,1);b0=log(10*delta)+randn(numRealizations,1);
    x = sin(2*pi*f*time);
    clear nst;
    for i=1:numRealizations
        expData = exp(b1(i)*x+b0(i)); 
        lambdaData = expData./(1+expData);

        if(i==1)
            lambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
        else 
            tempLambda = Covariate(time,lambdaData./delta, ...
                '\Lambda(t)','time','s','spikes/sec',{'\lambda_{1}'},...
                {{' ''b'', ''LineWidth'' ,2'}});
            lambda = lambda.merge(tempLambda);
        end       
        
        spikeColl = CIF.simulateCIFByThinningFromLambda(...
            lambda.getSubSignal(i),1); 
        nst{i} = spikeColl.getNST(1);
    end
        spikeColl = nstColl(nst);scrsz = get(0,'ScreenSize');
        h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 ...
            scrsz(3)*.6 scrsz(4)*.8]);
%         figure;
        subplot(3,1,1); plot(time,x,'k'); 
        set(gca,'xtick',[],'xtickLabel',[]); ylabel('Stimulus');
            hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
            set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
            title('Driving Stimulus','FontWeight','bold',...
                'FontSize',14,'FontName','Arial');
        subplot(3,1,2); lambda.plot([],{{' ''k'',''Linewidth'',1'}}); 
            legend off; 
            hy=ylabel('Firing Rate [spikes/sec]', 'Interpreter','none');
            hx=xlabel('','Interpreter','none');
            set([hx, hy],'FontName', 'Arial','FontSize',12,...
                'FontWeight','bold');
            set(gca,'xtickLabel',[]);
            title('Conditional Intensity Functions','FontWeight',...
                'bold','FontSize',14,'FontName','Arial');
 
        subplot(3,1,3); spikeColl.plot; 
            set(gca,'ytick',0:10:numRealizations,'ytickLabel',...
                0:10:numRealizations); 
            xlabel('time [s]','Interpreter','none');
            ylabel('Cell Number','Interpreter','none');
            hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
            set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
            title('Point Process Sample Paths','FontWeight',...
                'bold','FontSize',14,'FontName','Arial');

stim = Covariate(time,sin(2*pi*f*time),'Stimulus','time','s','V',{'stim'});
baseline = Covariate(time,ones(length(time),1),'Baseline','time','s','',...
                    {'constant'});

%     close all;
%%
close all;

clear lambdaCIF;
spikeColl.resample(1/delta);
dN=spikeColl.dataToMatrix;

% Make noise according to the dynamic range of the stimulus
Q=std(stim.data(2:end)-stim.data(1:end-1));
Px0=.1; A=1;
x0 = x(:,1); yT=x(:,end);
Pi0 = eps*eye(size(x0,1),size(x0,1));
PiT = eps*eye(size(x0,1),size(x0,1));


[x_p, W_p, x_u, W_u] = DecodingAlgorithms.PPDecodeFilterLinear(A, ...
    Q, dN',b0,b1','binomial',delta);
%
h=figure('Position',[scrsz(3)*.1 scrsz(4)*.1 scrsz(3)*.8 scrsz(4)*.6]);
zVal=1.96;
ciLower = min(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',...
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));
ciUpper = max(x_u(1:end)-zVal*sqrt(squeeze(W_u(1:end)))',...
    x_u(1:end)+zVal*sqrt(squeeze(W_u(1:end))'));

estimatedStimulus = Covariate(time,x_u(1:end),'\hat{x}(t)','time','s','');
CI= ConfidenceInterval(time,[ciLower', ciUpper'],'\hat{x}(t)','time','s','');
estimatedStimulus.setConfInterval(CI);

% hold all;            
% hEst=plot(time,x_u(1:end),'b','Linewidth',2); hold on;
% plot(time, [ciUpper', ciLower'],'b');

hEst = estimatedStimulus.plot([],{{' ''k'',''Linewidth'',4'}});
hStim=stim.plot([],{{' ''b'',''Linewidth'',4'}}); 
legend off;
h_legend=legend([hEst(1) hStim],'Decoded','Actual');
set(h_legend,'Interpreter','none');
set(h_legend,'FontSize',22);
title(['Decoded Stimulus +/- 95% CIs with ' num2str(numRealizations) ' cells'],...
    'FontWeight','bold','Fontsize',22,'FontName','Arial');
xlabel('time [s]','Interpreter','none');
ylabel('Stimulus','Interpreter','none');
hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
set([hx, hy],'FontName', 'Arial','FontSize',22,'FontWeight','bold');


    
%% Example 5b - Arm reaching to target Simulation
% See 
% L. Srinivasan, U. T. Eden, A. S. Willsky, and E. N. Brown, 
% "A state-space analysis for reconstruction of goal-directed movements 
% using neural signals.," Neural computation, vol. 18, no. 10, pp. 2465?2494, Oct. 2006.

    close all;
    clear all;
    %Process noise covariance only drives the movement velocity
    q=1e-4;
    Q=diag([1e-12 1e-12 q q]); 

    delta = .001;        % Time increment
    r=1e-6;   % in meters^2 
    p=1e-6;    % in meters^2/s^2
    PiT=diag([r r p p]); % Uncertainty in the target state
    Pi0=PiT;
    T=2;                 % Reach Duration

    x0 = [0;0;0;0];     % Initial Position and velocities (states)
    xT = [-.35;.2; 0;0];% Final Target
    time=0:delta:T;     % time vector

    A=[1 0 delta 0    ; %State transition matrix
       0 1 0     delta;
       0 0 1     0    ;
       0 0 0     1    ];

    x=zeros(4,length(time));


% Simulate a reach trajectory
% Differs from reference by multiplication by delta instead of division so
% that the velocity has units of meters per second
    R=chol(Q);
    L=chol(PiT);
    for k=1:length(time)
        if(k==1)
            x(:,k)=x0;
        else
             x(:,k)=A*x(:,k-1)+...
                 delta/(2)*(pi/T)^2*cos(pi*time(k)/T)*[0;0;...
                 xT(1)-x0(1);xT(2)-x0(2)]; %Reach to target model
            %x(:,k)=A*x(:,k-1)+R*randn(size(x,1),1); %Random walk model
        end

    end
    xT =x(:,end); % The target generated by the model
    yT=xT;        % Assume we have observed the actual target position with uncertainty PiT

    %Define Q according to the dynamic range of the movement above 
    Q=diag(var(diff(x,[],2),[],2))*100;

    % Plot the movement trajectories and the hand path
    scrsz = get(0,'ScreenSize');
    fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
        scrsz(3)*.8 scrsz(4)*.8]);
    %Plot The movement path
    subplot(4,2,[1 3]); 
    plot(100*x(1,:),100*x(2,:),'k','Linewidth',2); 
    xlabel('X Position [cm]'); ylabel('Y Position [cm]');
    hx=get(gca,'XLabel');  hy=get(gca,'YLabel');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    title('Reach Path','FontWeight','bold','Fontsize',14,'FontName','Arial');
    hold on; 
    axis([sort([100*x0(1)+5, 100*xT(1)-5]), sort([100*x0(2)-5, 100*xT(2)+5])]);
    h1=plot(100*x(1,1),100*x(2,1),'bo','MarkerSize',14); 
    h2=plot(100*x(1,end),100*x(2,end),'ro','MarkerSize',14); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); h1=plot(time,100*x(1,:),'k','Linewidth',2); hold on;
    h2=plot(time,100*x(2,:),'k-.','Linewidth',2); 
    h_legend=legend([h1,h2],'x','y','Location','NorthEast'); 
    set(h_legend,'FontSize',14)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel('time [s]'); hy=ylabel('Position [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    % Plot the velocity profiles 

    subplot(4,2,7);   
    h1=plot(time,100*x(3,:),'k','Linewidth',2); hold on;
    h2=plot(time,100*x(4,:),'k-.','Linewidth',2); 
    h_legend=legend([h1 h2],'v_x','v_y','Location','NorthEast'); 
    xlabel('time [s]');
    set(h_legend,'FontSize',14);
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);
    hx=xlabel('time [s]'); hy=ylabel('Velocity [cm/s]');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    %

    gamma=0;
    windowTimes=[0, 0.001];


% Simulate neural responses
    % logit(lambda_i*delta) = mu_i + b_x_i*v_x + b_y_i*v_y
    % logit(lambda_i*delta) = X_i*beta_i;
    numCells = 20; 
    bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta); % baseline firing rate -10Hz
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst;
    for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');

         if(strcmp(fitType,'poisson'))
             lambdaData = tempData;
         else
            lambdaData = tempData./(1+tempData); % Conditional Intensity Function for ith cell
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         lambdaCIF{i} = CIF([MuCoeffs(i) 0 0 bCoeffs(i,:)],...
             {'1','x','y','vx','vy'},{'x','y','vx','vy'},fitType);
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1);          nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
         subplot(4,2,[6 8]);
         h2=lambda{i}.plot([],{{' ''k'', ''LineWidth'' ,.5'}}); 
         legend off; hold all; % Plot the CIF
         
         
         
    end
    title('Neural Conditional Intensity Functions','FontWeight',...
        'bold','Fontsize',14,'FontName','Arial');
    hx=xlabel('time [s]','Interpreter','none'); 
    hy=ylabel('Firing Rate [spikes/sec]','Interpreter','none');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
    spikeColl = nstColl(nst); % Create a neural spike train collection
    
    subplot(4,2,[2,4]); spikeColl.plot;
    set(gca,'xtick',[],'xtickLabel',[]);
    title('Neural Raster','FontWeight','bold','Fontsize',14,...
        'FontName','Arial');
    hx=xlabel('time [s]','Interpreter','none'); 
    hy=ylabel('Cell Number','Interpreter','none');
    set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

%     close all;

    
%%
close all;
numExamples=20;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.6 scrsz(4)*.9]);
for k=1:numExamples
     bCoeffs=10*(rand(numCells,2)-.5);           % b_i = [b_x_i b_y_i] ~ U(-5, 5);
    phiMax = atan2(bCoeffs(:,2),bCoeffs(:,1));  % Maximal firing direction of cell
    phiMaxNorm = (phiMax+pi)./(2*pi); 
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 

    dataMat = [ones(length(time),1) x(3,:)' x(4,:)']; % design matrix: X (
    coeffs = [MuCoeffs bCoeffs]; % coefficient vector: beta
    fitType='binomial';
    clear nst lambda;
    
    
    for i=1:numCells
        tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'poisson'))
            lambdaData = tempData;
         else
             % Conditional Intensity Function for ith cell
            lambdaData = tempData./(1+tempData); 
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'' '}});
         lambda{i}=lambda{i}.resample(1/delta);
         
         % Generate CIF representation in case we want to use the symbolic
         % versions of the PPDecodeFilter (i.e. not PPDecodeFilterLinear
         % generate one realization for each cell
         tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1); 
         nst{i} = tempSpikeColl{i}.getNST(1);     % grab the realization
         nst{i}.setName(num2str(i));              % give each cell a unique name
        
    end

    % Plot the neural raster across all the cells
    spikeColl = nstColl(nst); % Create a neural spike train collection

    % Based on the temporal resolution defined by delta, bin the data and get
    % a matrix representation of the neural firing
    dN=spikeColl.dataToMatrix';
    dN(dN>1)=1; % more than one spike per bin will be treated as one spike. In
                % general we should pick delta small enough so that there is
                % only one spike per bin

    [C,N]   = size(dN); % N time samples, C cells

    beta=[zeros(2,numCells);  bCoeffs'];

    
    %Use the Goal Directed Movement Version of the Point Process adaptive
    %Filter
    [x_p, W_p, x_u, W_u,x_uT,W_uT,x_pT,W_pT] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0, Pi0, yT,PiT,0);

    %Use the Free Movement Version of the Point Process adaptive
    %Filter
    [x_pf, W_pf, x_uf, W_uf] = ...
        DecodingAlgorithms.PPDecodeFilterLinear(A, Q, dN,...
        MuCoeffs,beta,fitType,delta,gamma,windowTimes,x0);


    if(k==numExamples)
        subplot(4,2,1:4);h1=plot(100*x(1,:),100*x(2,:),'k','LineWidth',3); 
        hold on;
        axis([sort([100*x0(1)+5, 100*xT(1)-5]), ...
            sort([100*x0(2)-5, 100*xT(2)+5])]);
        title('Estimated vs. Actual Reach Paths',...
            'FontWeight','bold','Fontsize',12,'FontName','Arial');
    end
    subplot(4,2,1:4);h2=plot(100*x_u(1,:)',100*x_u(2,:)','b'); hold all;
    subplot(4,2,1:4);h3=plot(100*x_uf(1,:)',100*x_uf(2,:)','g'); 
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    h1=plot(100*x0(1),100*x0(2),'bo','MarkerSize',10); hold on;
    h2=plot(100*xT(1),100*xT(2),'ro','MarkerSize',10); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');


    subplot(4,2,5); 
    h1=plot(time,100*x(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(1,:)','b'); 
    h3=plot(time,100*x_uf(1,:)','g'); 
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,6); 
    h1=plot(time,100*x(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(2,:)','b'); 
    h3=plot(time,100*x_uf(2,:)','g');
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]'); 
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.63 pos(2)+.23 pos(3:4)]);

    subplot(4,2,7); 
    h1=plot(time,100*x(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(3,:)','b');
    h3=plot(time,100*x_uf(3,:)','g');
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    subplot(4,2,8); 
    h1=plot(time,100*x(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*x_u(4,:)','b'); 
    h3=plot(time,100*x_uf(4,:)','g'); 
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

 
end

%     close all;
%% Experiment 6 - Hybrid Point Process Filter Example 
% NOTE THIS EXAMPLE WAS NOT INCLUDED IN THE FINAL VERSION OF THE PAPER
% This example is based on an implementation of the Hybrid Point Process
% filter described in _General-purpose filter design for neural prosthetic 
% devices_ by Srinivasan L, Eden UT, Mitter SK, Brown EN in J Neurophysiol.
% 2007 Oct, 98(4):2456-75. 
%

%% Problem Statement
% Suppose that a process of interest can be modeled as consisting of
% several discrete states where the evolution of the system under each
% state can be modeled as a linear state space model. The observations of
% both the state and the continuous dynamics are not direct, but rather
% observed through how the continuous and discrete states affect the firing
% of a population of neurons. The goal of the hybrid filter is to estimate
% both the continuous dynamics and the underlying system state from only
% the neural population firing (point process observations).
%
% To illustrate the use of this filter, we consider a reaching task. We
% assume two underlying system states s=1="Not Moving"=NM and s=2="Moving"=M.
% Under the "Not Moving" the position of the arm remain constant,
% whereas in the "Moving" state, the position and velocities evolved based
% on the arm acceleration that is modeled as a gaussian white noise
% process.
%
% Under both the "Moving" and "Not Moving" states, the arm evolution state
% vector is 
%%
% 
% $${\bf{x}} = {[x,y,{v_x},{v_y},{a_x},{a_y}]^T}$$
% 

%% Generated Simulated Arm Reach

clear all;
close all;
delta=0.001;
Tmax=2;
time=0:delta:Tmax;
A{2} = [1 0 delta 0     delta^2/2   0;
        0 1 0     delta 0           delta^2/2;
        0 0 1     0     delta       0;
        0 0 0     1     0           delta;
        0 0 0     0     1           0;
        0 0 0     0     0           1];
        
A{1} = [1 0 0 0 0 0;
        0 1 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0;
        0 0 0 0 0 0];
A{1} = [1 0;
        0 1];
            
Px0{2} =1e-6*eye(6,6);
Px0{1} =1e-6*eye(2,2);

minCovVal = 1e-12;
covVal = 1e-3; 



Q{2}=[minCovVal     0   0     0   0       0;
      0       minCovVal 0     0   0       0;
      0       0   minCovVal   0   0       0;
      0       0   0     minCovVal 0       0;
      0       0   0     0   covVal      0;
      0       0   0     0   0       covVal];

Q{1}=minCovVal*eye(2,2);

mstate = zeros(1,length(time));
ind{1}=1:2;
ind{2}=1:6;

% Acceleration model
X=zeros(max([size(A{1},1),size(A{2},1)]),length(time));
p_ij = [.998 .002; 
        .001 .999];

for i = 1:length(time)
    
    if(i==1)
        mstate(i) = 1;
    else
       if(rand(1,1)<p_ij(mstate(i-1),mstate(i-1)))
            mstate(i) = mstate(i-1);
       else
           if(mstate(i-1)==1)
               mstate(i) = 2;
           else
               mstate(i) = 1;
           end
       end
    end
    st = mstate(i);
    R=chol(Q{st});
    if(i<length(time))
        X(ind{st},i+1) = A{st}*X(ind{st},i) + R*randn(length(ind{st}),1);
    end

end
%%
%save paperHybridFilterExample time Tmax delta mstate X p_ij ind A Q Px0
load paperHybridFilterExample;
Q{1}=minCovVal*eye(2,2);
numCells=40;
close all;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.8 scrsz(4)*.9]);
subplot(4,2,[1 3]);
plot(100*X(1,:),100*X(2,:),'k','Linewidth',2); hx=xlabel('X [cm]'); 
hy=ylabel('Y [cm]');  hold on;
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
title('Reach Path','FontWeight','bold','Fontsize',14,'FontName','Arial');
hold on; 
h1=plot(100*X(1,1),100*X(2,1),'bo','MarkerSize',16); 
h2=plot(100*X(1,end),100*X(2,end),'ro','MarkerSize',16); 
legend([h1 h2],'Start','Finish','Location','NorthEast');



subplot(4,2,[6 8]);
plot(time,mstate,'k','Linewidth',2); axis tight; v=axis; 
axis([v(1) v(2) 0 3]);
hx=xlabel('time [s]'); hy=ylabel('state');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
set(gca,'YTick',[1 2],'YTickLabel',{'N','M'})
title('Discrete Movement State','FontWeight','bold','Fontsize',14,...
    'FontName','Arial');

subplot(4,2,5);
h1=plot(time,100*X(1,1:end),'k','Linewidth',2); hold on;
h2=plot(time,100*X(2,1:end),'k-.','Linewidth',2);
hx=xlabel('time [s]'); hy=ylabel('Position [cm]');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
h_legend=legend([h1,h2],'x','y','Location','NorthEast'); 
set(h_legend,'FontSize',14)
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);


subplot(4,2,7);
h1=plot(time,100*X(3,1:end),'k','Linewidth',2); hold on;
h2=plot(time,100*X(4,1:end),'k-.','Linewidth',2);
hx=xlabel('time [s]'); hy=ylabel('Velocity [cm/s]');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');
h_legend=legend([h1,h2],'v_{x}','v_{y}','Location','NorthEast'); 
set(h_legend,'FontSize',14)
pos = get(h_legend,'position');
set(h_legend, 'position',[pos(1)+.06 pos(2)+.01 pos(3:4)]);

meanMu = log(10*delta);  % baseline firing rate 
MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
    0*randn(numCells,2)];
%Add realization by thinning with history
dataMat = [ones(size(X,2),1),X(:,1:end)'];
% Generate M1 cells
clear lambda tempSpikeColl lambdaCIF n;
fitType ='binomial';
% matlabpool open;
 for i=1:numCells
     tempData  = exp(dataMat*coeffs(i,:)');
     if(strcmp(fitType,'binomial'));
        lambdaData = tempData./(1+tempData);
     else
        lambdaData = tempData;
     end
     lambda{i}=Covariate(time,lambdaData./delta, ...
         '\Lambda(t)','time','s','spikes/sec',...
         {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
     maxTimeRes = 0.001;
     tempSpikeColl{i} = CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
     n{i} = tempSpikeColl{i}.getNST(1);
     n{i}.setName(num2str(i));    
 end
 spikeColl = nstColl(n);
 subplot(4,2,[2 4]);
spikeColl.plot;
set(gca,'xtick',[],'xtickLabel',[],'ytickLabel',[]);
title('Neural Raster','FontWeight','bold','Fontsize',14,'FontName','Arial');
hx=xlabel('time [s]','Interpreter','none'); 
hy=ylabel('Cell Number','Interpreter','none');
set([hx, hy],'FontName', 'Arial','FontSize',12,'FontWeight','bold');

% close all;
 
%% Simulate Neural Firing
% We simulate a population of neurons that fire in response to the movement
% velocity (x and y coorinates) 

%Use the data to estimate the process noise for the moving case and
%non-moving case

nonMovingInd = intersect(find(X(5,:)==0),find(X(6,:)==0));
movingInd=setdiff(1:size(X,2),nonMovingInd);
Q{2}=diag(var(diff(X(:,movingInd),[],2),[],2));
Q{2}(1:4,1:4)=0;
varNV=diag(var(diff(X(:,nonMovingInd),[],2),[],2));
Q{1} = varNV(1:2,1:2);
close all; clear S_est X_est MU_est S_estNT X_estNT MU_estNT;
numExamples = 20;
numCells=40;
scrsz = get(0,'ScreenSize');
fig1=figure('OuterPosition',[scrsz(3)*.1 scrsz(4)*.1 ...
    scrsz(3)*.9 scrsz(4)*.9]);

for n=1:numExamples
    meanMu = log(10*delta);  % baseline firing rate 
    MuCoeffs = meanMu+randn(numCells,1);   % mu_i ~ G(meanMu,1) 
    coeffs = [MuCoeffs 0*randn(numCells,2) 10*(rand(numCells,2)-.5) ...
        0*randn(numCells,2)];



    %Add realization by thinning with history
    dataMat = [ones(size(X,2),1),X(:,1:end)'];
    % Generate M1 cells
    clear lambda tempSpikeColl lambdaCIF nst;
    fitType ='binomial';
    % matlabpool open;
     for i=1:numCells
         tempData  = exp(dataMat*coeffs(i,:)');
         if(strcmp(fitType,'binomial'))
            lambdaData = tempData./(1+tempData);
         else
            lambdaData = tempData;
         end
         lambda{i}=Covariate(time,lambdaData./delta, ...
             '\Lambda(t)','time','s','spikes/sec',...
             {strcat('\lambda_{',num2str(i),'}')},{{' ''b'', ''LineWidth'' ,2'}});
         maxTimeRes = 0.001;
         tempSpikeColl{i} = ...
             CIF.simulateCIFByThinningFromLambda(lambda{i},1,[]);
         nst{i} = tempSpikeColl{i}.getNST(1);
         nst{i}.setName(num2str(i));    
     end

    % Decode the x-y trajectory

    % Enforce that the maximum time resolution is delta
    spikeColl = nstColl(nst);
    spikeColl.resample(1/delta);
    dN = spikeColl.dataToMatrix; 
    dN(dN>1)=1; %Avoid more than 1 spike per bin.

    % Starting states are equally probable
    Mu0=.5*ones(size(p_ij,1),1);
    clear x0 yT clear Pi0 PiT;
    x0{1} = X(ind{1},1);
    yT{1} = X(ind{1},end);
    Pi0    = Px0;
    PiT{1} = 1e-9*eye(size(x0{1},1),size(x0{1},1));

    x0{2} = X(ind{2},1);
    yT{2} = X(ind{2},end);
    PiT{2} = 1e-9*eye(size(x0{2},1),size(x0{2},1));


    % Run the Hybrid Point Process Filter 
    [S_est, X_est, W_est, MU_est, X_s, W_s,pNGivenS]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0, yT,PiT);
    [S_estNT, X_estNT, W_estNT, MU_estNT, X_sNT, W_sNT,pNGivenSNT]=...
        DecodingAlgorithms.PPHybridFilterLinear(A, Q, p_ij,Mu0, dN',...
        coeffs(:,1),coeffs(:,2:end)',fitType,delta,[],[],x0,Pi0);
    
    %Store the results for computing relevant statistics later
    X_estAll(:,:,n) = X_est;
    X_estNTAll(:,:,n) = X_estNT;
    S_estAll(n,:)=S_est;
    S_estNTAll(n,:)=S_estNT;
    MU_estAll(:,:,n)=MU_est;
    MU_estNTAll(:,:,n) = MU_estNT;
    

    %State Estimate
    subplot(4,3,[1 4]);
    plot(time,mstate,'k','LineWidth',3); hold all;
    plot(time,S_est,'b-.','Linewidth',.5);
    plot(time,S_estNT,'g-.','Linewidth',.5); axis tight; v=axis; 
    axis([v(1) v(2) 0.5 2.5]); 

    %Movement State Probability (Non-movement State probability is 1-Pr(Movement))
    subplot(4,3,[7 10]);
    plot(time,MU_est(2,:),'b-.','Linewidth',.5);  hold on;
    plot(time,MU_estNT(2,:),'g-.','Linewidth',.5);  hold on;
    axis([min(time) max(time) 0 1.1]);

    %The movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    h2=plot(100*X_est(1,:)',100*X_est(2,:)','b-.'); hold all;
    h3=plot(100*X_estNT(1,:)',100*X_estNT(2,:)','g-.'); 
    
    %X-Position
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(1,:)','b-.'); 
    h3=plot(time,100*X_estNT(1,:)','g-.'); 

    %Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(2,:)','b-.'); 
    h3=plot(time,100*X_estNT(2,:)','g-.'); 

    %X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(3,:)','b-.');
    h3=plot(time,100*X_estNT(3,:)','g-.');

    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,100*X_est(4,:)','b-.'); 
    h3=plot(time,100*X_estNT(4,:)','g-.');

    
    

end

%
%     Save all the example Data
%     save Experiment6ReachExamples X_estAll X_estNTAll S_estAll ...
%           S_estNTAll MU_estAll MU_estNTAll;
%  
%     load Experiment6ReachExamples;

    % Mean Discrete State Estimate
    subplot(4,3,[1 4]);
    hold all; 
    plot(time,mstate,'k','LineWidth',3); 
    plot(time,mean(S_estAll),'b','LineWidth',3); 
    plot(time,mean(S_estNTAll),'g','LineWidth',3); 
    set(gca,'xtick',[],'YTick',[1 2.1],'YTickLabel',{'N','M'});
    hy=ylabel('state'); hx=xlabel('time [s]');
    set([hy hx],'FontName', 'Arial','FontSize',10,'FontWeight','bold',...
        'Interpreter','none');
    title('Estimated vs. Actual State','FontWeight','bold','Fontsize',...
        12,'FontName','Arial');

    
    

   % Mean State Movement State Probability
    subplot(4,3,[7 10]);
    plot(time, mean(squeeze(MU_estAll(2,:,:)),2),'b','LineWidth',3);  
    hold on;
    plot(time,mean(squeeze(MU_estNTAll(2,:,:)),2),'g','LineWidth',3);  
    hold on;
    axis([min(time) max(time) 0 1.1]);
    hx=xlabel('time [s]'); hy=ylabel('P(s(t)=M | data)');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Probability of State','FontWeight','bold','Fontsize',12,...
        'FontName','Arial');
    
    % Mean movement path
    subplot(4,3,[2 3 5 6]);
    h1=plot(100*X(1,:)',100*X(2,:)','k'); hold all;
    mXestAll=mean(100*X_estAll,3);
    mXestNTAll=mean(100*X_estNTAll,3);
    plot(mXestAll(1,:),mXestAll(2,:),'b','Linewidth',3);
    plot(mXestNTAll(1,:),mXestNTAll(2,:),'g','Linewidth',3);
    hx=xlabel('x [cm]'); hy=ylabel('y [cm]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');

    h1=plot(100*X(1,1),100*X(2,1),'bo','MarkerSize',14); hold on;
    h2=plot(100*X(1,end),100*X(2,end),'ro','MarkerSize',14); 
    legend([h1 h2],'Start','Finish','Location','NorthEast');
    title('Estimated vs. Actual Reach Path','FontWeight','bold',...
        'Fontsize',12,'FontName','Arial');

   
    % Mean X-Positon
    subplot(4,3,8); 
    h1=plot(time,100*X(1,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(1,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(1,:),'g','LineWidth',3); hold on;
    hy=ylabel('x(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    
    % Mean Y-Position
    subplot(4,3,9); 
    h1=plot(time,100*X(2,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(2,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(2,:),'g','LineWidth',3); hold on;
    h_legend=legend([h1(1) h2(1) h3(1)],'Actual','PPAF+Goal',...
        'PPAF','Location','SouthEast');
    hy=ylabel('y(t) [cm]'); hx=xlabel('time [s]');
    set(gca,'xtick',[],'xtickLabel',[]);
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Position','FontWeight','bold','Fontsize',12,'FontName','Arial');
    set(h_legend,'FontSize',10)
    pos = get(h_legend,'position');
    set(h_legend, 'position',[pos(1)-.40 pos(2)+.51 pos(3:4)]);

    % Mean X-Velocity
    subplot(4,3,11); 
    h1=plot(time,100*X(3,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(3,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(3,:),'g','LineWidth',3); hold on;
    hy=ylabel('v_{x}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('X Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');

    % Mean Y-Velocity
    subplot(4,3,12); 
    h1=plot(time,100*X(4,:),'k','LineWidth',3); hold on;
    h2=plot(time,mXestAll(4,:),'b','LineWidth',3); hold on;
    h3=plot(time,mXestNTAll(4,:),'g','LineWidth',3); hold on;
    hy=ylabel('v_{y}(t) [cm/s]'); hx=xlabel('time [s]');
    set([hx, hy],'FontName', 'Arial','FontSize',10,'FontWeight','bold');
    title('Y Velocity','FontWeight','bold','Fontsize',12,'FontName','Arial');


##### SOURCE END #####
--></body></html>